<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2020-06-19T12:16:02.949Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure Load Balancer のトラブルシューティング: スコーピング編</title>
    <link href="https://jpaztech.github.io/blog/network/tsg-azure-load-balancer-scoping/"/>
    <id>https://jpaztech.github.io/blog/network/tsg-azure-load-balancer-scoping/</id>
    <published>2020-06-17T01:00:00.000Z</published>
    <updated>2020-06-19T12:16:02.949Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure Load Balancer (ALB) はワークロードを複数の Azure VM / VMSS に負荷分散するサービスで、最も利用されている Azure サービスの一つです。利用数が多い分、ALB を経由するエンドノード間の通信に問題が生じたといったトラブルもよくお問い合わせいただきます。そこで、そうしたトラブルにおいて、ALB の観点で原因箇所を切り分けるスコーピングの方法についてご紹介したいと思います。</p><a id="more"></a><h2 id="要約"><a href="#要約" class="headerlink" title="要約"></a>要約</h2><ul><li>トランスポート層 (L4) レベルで接続性が確保できていれば Auzre Load Balancer として問題はありません。</li><li>例えば TCP の負荷分散規則であれば <code>nc</code>、<code>telnet</code>、<code>PsPing</code>、<code>Test-NetConnection</code> 等で TCP コネクションが確立出来るかみれば十分です。</li><li>L4 の接続性が確認できない場合は、Azure Load Balancer の構成状況に問題があります。次の公式ドキュメントやブログ記事等を参考に原因箇所を特定してください。<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/loadbalancer-troubleshooting" target="_blank" rel="noopener">ロードバランサー経由での通信ができない場合のチェックポイント | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/azurelb-tips" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 | Microsoft Docs</a></li></ul></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p> Azure Load Balancer に関わるトラブルを解決する際には、<strong>Azure Load Balancer は L4 ロードバランサーである</strong>ということを意識しておく必要があります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-overview" target="_blank" rel="noopener">Azure Load Balancer の概要 - Azure Load Balancer | Microsoft Docs</a></li></ul><blockquote><p>Azure Load Balancer は、開放型システム間相互接続 (OSI) モデルのレイヤー 4 で動作します。 </p></blockquote><p>立ち位置を明確にする為に他の負荷分散サービスと比べてみると、Azure の負荷分散サービスで関与できるネットワーク レイヤーは、それぞれ以下の通りです。</p><ul><li><strong>Trarffic Manager</strong>: DNS レベルの負荷分散装置。DNS による名前解決時に負荷分散に関与できる。</li><li><strong>Azure Load Balancer</strong>: トランスポート層 (L4) の負荷分散装置。UDP または TCP のフローを、適当なバックエンド サーバーに分散するのが仕事。</li><li><strong>Application Gateway</strong>: アプリケーション層 (L7) の負荷分散装置。HTTP/S のセッションを、適当なバックエンド サーバーに分散するのが仕事。</li></ul><p>なお、負荷分散サービスの比較は、以下のドキュメントでより詳しく説明されています。これらのサービスの比較にご興味があれば、併せてご確認ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-load-balancing-azure" target="_blank" rel="noopener">Azure で負荷分散サービスを使用する | Microsoft Docs</a></li></ul><p>「503 エラーが表示されるが、Azure Load Balancer に問題はないか調査してほしい」といったお問い合わせをいただくことがありますが、<span style="color: #d00000">Azure Load Balancer はあくまで L4 の接続性を担保するのが責務であり、その上のレイヤーである HTTP の応答に関与することはありません</span>。</p><p>Azure Load Balancer は TCP ペイロードに関与しないため、例えば HTTP の 50* 系ステータス コードのレスポンスを返すことも、<code>X-forwarded-for</code> ヘッダを書き換えることもありません。HTTP (アプリケーション層) で何か不具合が出ている場合は、バックエンド サーバーより後段のエンティティを対象に原因調査するのが良いでしょう。</p><h2 id="スコーピング-問題の切り分け"><a href="#スコーピング-問題の切り分け" class="headerlink" title="スコーピング: 問題の切り分け"></a>スコーピング: 問題の切り分け</h2><p>この記事の最大の目的です。Azure Load Balancer を経由するシステムに問題がある場合の <strong>切り分け (スコーピング) 方法</strong>について紹介していきたいと思います。具体的には「Azure Load Balancer に関連する箇所で問題があるか」を切り分けます。</p><p>答えを言ってしまうと、Azure Load Balancer に問題があるか切り分けるには <strong>L4 の接続性 (connectivity)</strong> を確認するだけで十分です。</p><p>切り分けのフローチャートを作成したので、まずは下図を基に全体像を把握していただければ幸いです。</p><img src="/blog/network/tsg-azure-load-balancer-scoping/scoping-flowchart.png"><h3 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h3><p>切り分けに必要な情報は以下の通りです。</p><ul><li><code>&lt;vip&gt;</code>: フロントエンドで待ち受ける仮想 IP アドレス</li><li><code>&lt;protocol&gt;</code>: VIP で待ち受ける L4 プロトコル (TCP/UDP)</li><li><code>&lt;port&gt;</code>: VIP で待ち受けるポート番号</li><li><code>&lt;backend-port&gt;</code>: 負荷分散された後、バックエンド サーバーが受け取る (NAPT 後の) ポート番号</li></ul><p>加えて、テストパケットを送信するクライアントも用意する必要がありますが、クライアントと Azure Load Balancer の間には余計なネットワーク装置 (e.g. Firewall) を置かないことが鉄則です。どうしてもそのようなクライアントが準備出来ない場合は、被疑箇所は Azure Load Balancer だけではなく、中間のネットワーク装置まで含めた検証となることを必ず意識してください。</p><p>なお、クライアントには対象の Azure Load Balancer のバックエンド サーバーではないものを選択してください。というのも、内部ロードバランサーは自分自身に負荷分散されたパケットはドロップされる動作となっている為です。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot#cause-4-accessing-the-internal-load-balancer-frontend-from-the-participating-load-balancer-backend-pool-vm" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li></ul><blockquote><p>副作用として、バックエンド プール内の VM からの送信フローが、そのプール内の内部ロード バランサーのフロントエンドへのフローを試み、”かつ”、それ自体にマップバックされている場合、フローの 2 つのレッグは一致しません。 これらは一致しないため、フローは失敗します。 フローが、フロントエンドへのフローを作成したバックエンド プール内の同じ VM にマップバックしなかった場合、フローは成功します。</p></blockquote><h3 id="TCP-の負荷分散規則"><a href="#TCP-の負荷分散規則" class="headerlink" title="TCP の負荷分散規則"></a>TCP の負荷分散規則</h3><p>負荷分散プロトコルが TCP の場合、3-way handshaking が確認できれば疎通できていると見なせるので、切り分けはクライアントで完結します。</p><p>例えば次のコマンドを実行して、TCP コネクションが確立できるか確認します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[client]# telnet &lt;vip&gt; &lt;port&gt;</span><br><span class="line">[client]# curl -v telnet://&lt;vip&gt;:&lt;port&gt;</span><br><span class="line">[client]# nc -v &lt;vip&gt; &lt;port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell)</span><br><span class="line">PS C:\client&gt; Test-NetConnection &lt;vip&gt; -Port &lt;port&gt;</span><br><span class="line">PS C:\client&gt; PsPing -t &lt;vip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><ul><li><a href="https://Linux.die.net/man/1/telnet" target="_blank" rel="noopener">telnet(1): user interface to TELNET protocol - Linux man page</a></li><li><a href="https://Linux.die.net/man/1/nc" target="_blank" rel="noopener">nc(1): arbitrary TCP/UDP connections/listens - Linux man page</a></li><li><a href="https://docs.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=win10-ps" target="_blank" rel="noopener">Test-NetConnection | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psping" target="_blank" rel="noopener">PsPing - Windows Sysinternals | Microsoft Docs</a></li></ul><p>Linux と Windows のいずれの場合でも、TCP コネクションが connected になれば L4 の疎通性に問題はありません。</p><h3 id="UDP-の負荷分散規則"><a href="#UDP-の負荷分散規則" class="headerlink" title="UDP の負荷分散規則"></a>UDP の負荷分散規則</h3><p>一方で、UDP の場合は、クライアントからの通信に必ずしも応答 (ACK) が返されるとは限らないため、サーバー側で着信を確認する必要があります。</p><p>クライアント側では例えば以下のようなコマンドで、テスト パケットを送信出来ます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">[client]# echo -n &quot;test message&quot; | nc -u &lt;vip&gt; &lt;port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell)</span><br><span class="line">PS C:\client&gt;</span><br><span class="line">function Test-Udp($vip, $port) &#123;</span><br><span class="line">    $client = New-Object System.Net.Sockets.UdpClient</span><br><span class="line">    $client.Connect($vip, $port)</span><br><span class="line">    $encoding = New-Object System.Text.ASCIIEncoding</span><br><span class="line">    $bytes = $encoding.GetBytes(&quot;test message&quot;)</span><br><span class="line">    $client.Send($bytes, $bytes.Length)</span><br><span class="line">    $client.Close()</span><br><span class="line">&#125;</span><br><span class="line">Test-Udp &lt;vip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><p>サーバー側でテスト パケットが着信していることを確認するには、アクセスログを確認する、モックサーバーを利用する、パケットをキャプチャする、といった選択肢が選べます。ここでは、最も汎用性の高いパケット キャプチャによる確認方法を簡単に紹介します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">[server]# sudo tcpdump -i any -nN udp and port &lt;backend-port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell with administrator mode)</span><br><span class="line">PS C:\server&gt; netsh trace start report=no capture=yes tracefile=%USERPROFILE%\Desktop\trace.etl</span><br><span class="line">PS C:\server&gt; netsh trace stop</span><br></pre></td></tr></table></figure><p><code>tcpdump</code> の場合は、標準出力に対象のパケットが表示できれば L4 疎通性は問題ありません。また、<code>netsh</code> の場合は、採取したトレース ファイル (デスクトップに生成される <code>trace.etl</code>) に対象のパケットが含まれていたら L4 疎通性に問題ありません。</p><h2 id="ネクスト-アクション"><a href="#ネクスト-アクション" class="headerlink" title="ネクスト アクション"></a>ネクスト アクション</h2><p>上記の切り分けで L4 の疎通性が得られない場合、Azure Load Balancer の構成状況に問題があります。次に紹介するブログ記事や公式ドキュメントを参考に、原因箇所の特定をご実施ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/loadbalancer-troubleshooting" target="_blank" rel="noopener">ロードバランサー経由での通信ができない場合のチェックポイント | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/azurelb-tips" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 | Microsoft Docs</a></li></ul><p>一方で、Azure Load Balancer に問題がなければ、多くの状況でサーバーで動作しているアプリケーションがエラー原因です。正確に言えば、OS のネットワーク スタック以上のレイヤーで、構成が間違っているか予期しない問題が起きている可能性があります。</p><p>本切り分けの検証結果や、現在の状況、目標とする状態などを OS やミドルウェア/アプリケーションのベンダー様とご共有いただき、さらに原因調査を進めてください。</p><hr><p>※本情報の内容（リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure Load Balancer (ALB) はワークロードを複数の Azure VM / VMSS に負荷分散するサービスで、最も利用されている Azure サービスの一つです。利用数が多い分、ALB を経由するエンドノード間の通信に問題が生じたといったトラブルもよくお問い合わせいただきます。そこで、そうしたトラブルにおいて、ALB の観点で原因箇所を切り分けるスコーピングの方法についてご紹介したいと思います。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
      <category term="TSG" scheme="https://jpaztech.github.io/blog/tags/TSG/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の外部接続 (SNAT) オプション まとめ</title>
    <link href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/"/>
    <id>https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/</id>
    <published>2020-06-16T04:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.945Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure VM がインターネットに接続する際には、パブリック IP アドレスでの送信元 NAT (SNAT) が必要です。Azure は、外部接続の SNAT に関して多くのオプションを提供していますが、オプションが多くて便利な反面、全オプションの列挙やオプション間の比較が難しいのも事実です。そうした難しさを少しでも緩和できるよう、本稿では外部接続の SNAT オプションを様々な角度から網羅的に紹介いたします。</p><a id="more"></a><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p><strong>仮定する知識</strong></p><p>この記事では、一般的なネットワーク用語としてのネットワーク アドレス変換 (NAT) や NAPT について、ある程度知識があることを前提としています。これらの言葉に馴染みがなければ、以下の公式ドキュメントを参考に、まずは NAT についての技術背景を確認してみてください。インターネットを活用すれば、さらに多くの技術解説を見つけることが出来るはずです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#understanding-snat-and-pat" target="_blank" rel="noopener">Azure の Outbound connections &gt; SNAT と PAT の理解 | Microsoft Docs</a></li></ul><p><strong>外部接続と SNAT</strong></p><p>Azure 仮想マシン (VM) がインターネット等のグローバル IP アドレス帯のサーバーと通信することを、<strong>外部接続 (outbound connection)</strong> と呼びます。外部接続では、仮想ネットワークで設定したプライベート IP アドレスから、グローバル IP アドレスに送信元 NAT (SNAT) する必要があります。この記事で取り扱うのは、外部接続の為に Azure が提供している SNAT のオプションについてです。</p><p>結論から書くと、2020 年 6 月現在、Azure で利用できる SNAT のオプションは以下の 5 つ存在します。</p><ul><li>ユーザー定義ルートと仮想アプライアンス (e.g. Azure Firewall) による SNAT</li><li>NAT Gateway</li><li>パブリック Azure Load Balancer (外部ロードバランサー)</li><li>パブリック IP アドレス</li><li>Azure 既定の SNAT</li></ul><p>「ユーザー定義ルート (UDR) と仮想アプライアンス (NVA) による SNAT」に関しては、SNAT 可否やその動作仕様が NVA 製品に依存しますので、今回は残る 4 つの「Azure プラットフォームそのものが提供する SNAT」についてお話します (UDR+NVA で SNAT する場合も、結局 NVA 上では残りのいずれかの方法で SNAT する必要があります)。</p><h2 id="判定フローチャート"><a href="#判定フローチャート" class="headerlink" title="判定フローチャート"></a>判定フローチャート</h2><p>個々の詳細を見る前に、SNAT オプション同士の依存関係を把握し、全体感を捉えておきましょう。</p><p>というのも、環境によっては複数の SNAT オプションが構成されている可能性がある為です。例えば、NAT Gateway を関連付けたサブネットの中に、パブリック IP アドレスを付与した VM をデプロイするとどうなるでしょうか?</p><p>そのような状況で役に立つフローチャートを作図しました。以下のフローに従えば、<strong>ある Azure VM のある NIC</strong> がどのように SNAT されるか判定できます。VM ではなく、<span style="color: #c00000">NIC に関する SNAT 方法判定</span>である点に注意してください。</p><img src="/blog/network/snat-options-for-azure-vm/flowchart-to-determine-snat-scenario.png"><p>なお、フローチャートに脚注で記載されているシナリオ {1, 2, 3} は、以下の公式ドキュメントのシナリオ番号に対応しています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-overview" target="_blank" rel="noopener">Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</a></li></ul><p><strong>フローチャートの使い方</strong></p><p>先程挙げた NAT Gateway とパブリック IP アドレスの共存環境の例を使って、フローチャートの使い方を説明します。</p><ol><li>左上の丸からスタートします。</li><li>まずはじめに、UDR で宛先が NVA に向いているか確認します。この情報は、NIC の [有効なルート] から確認することが出来ます。この例では NVA もルート テーブルもデプロイしておらず、判定は “NO” だったとして次の条件文に進みます。</li><li>サブネットに NAT Gateway が関連付けられているか確認します。この情報は、仮想ネットワークの [サブネット] から確認することが出来ます。この例では NAT Gateway が関連付けられています! 条件文の答えは “YES” なので、フローチャートはここで終了します。</li></ol><p>最終的に、パブリック IP アドレスではなく NAT Gateway が優先されて SNAT される動作であることが、このフローチャートから判定出来ました。</p><p><strong>Standard SKU の外部接続構成か?</strong></p><p>最後の「Standard SKU の外部接続構成か?」と記載された条件ボックスは、次のいずれか一つを満たす場合に “YES” と判定されます。</p><ul><li>VM には可用性セットが構成されていて、一つ以上の可用性セット内 VM が「Standard SKU の外部接続リソース」に関連付けられている。</li><li>VM は仮想マシン スケール セット (VMSS) であり、一つ以上の VMSS 内 VM が「Standard SKU の外部接続リソース」に関連付けられている。</li><li>複数の NIC が VM に関連付けられていて、一つ以上の NIC が「Standard SKU の外部接続リソース」に関連付けられている。</li></ul><p>ここで、Standard SKU の外部接続リソースとは、以下の Azure リソースを表します。</p><ul><li>Standard SKU のパブリック IP アドレス</li><li>Standard SKU の Azure Load Balancer</li></ul><p>上記の通り、NAT Gateway は “Standard SKU の外部接続リソース” に該当しないため、可用性セットの一部 VM にだけ外部接続を構成したい場合や、複数 NIC を持つ VM の一部 NIC に外部接続を構成したい場合に使えます。</p><p>このあたりの条件式を把握するのは難しく、個人的にも理解するのに最も時間がかかった部分ですが、 <strong>Standard SKU ではリソースの保護が強化されていて、明示的に通信設定をするまでは許可されない</strong> と理解すれば多少は飲み込みやすいと思います。同じ内容は、以下の公式ドキュメントにも記載されています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections" target="_blank" rel="noopener">Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</a></li></ul><blockquote><p>重要<br>…<br>アウトバウンド接続のコンテキストでは、単一スタンドアロン VM、可用性セット内のすべての VM、VMSS のすべてのインスタンスがグループとして動作します。 つまり、可用性セット内の単一 VM が Standard SKU に関連付けられている場合、この可用性セット内のすべての VM インスタンスが、Standard SKU に関連付けられている場合と同じ規則に従って動作するようになります。個々のインスタンスが直接関連付けられていない場合でも同様です。 この動作は、ロード バランサーに複数のネットワーク インターフェイスカードが接続されているスタンドアロン VM の場合にも見られます。 1 つの NIC をスタンドアロンとして追加された場合、同じ動作が行われます。</p></blockquote><p><strong>外部接続不可</strong></p><p>最後に、フローチャートの中で赤色で記された<span style="color: #c00000;">「外部接続不可」</span>のシナリオについて補足しておきます。</p><p>フローチャートからもわかるように、Azure では多くの SNAT オプションがあり、ほとんどの状況で外部接続が可能です。特に、NAT 装置を意識せずに VM をデプロイするだけでも (デフォルトゲートウェイが) SNAT を実施してくれる「Azure 既定の SNAT」のシナリオに関しては、特筆すべきポイントです。</p><p>しかしながら、一つだけ SNAT 出来ないシナリオがあります。それが<span style="color: #c00000;">「外部接続不可」</span>のシナリオです。具体的には、Standard SKU の外部接続構成の NIC に、明示的に外部接続リソースを関連付けない場合に該当します (こうして言葉で説明するより、フローチャートを見てもらうほうが早いと思います)。</p><p>「VM が外部接続できない、できなくなった」というお問い合わせは多数いただきますが、殆どの場合の根本原因は、単に<span style="color: #c00000;">「外部接続不可」</span>のシナリオに該当していたというものです。このため、過去にもブログ記事として紹介しています。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/Azure%E3%83%AD%E3%83%BC%E3%83%89%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B5%E3%83%BC%E5%88%A9%E7%94%A8%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9.html#outbound-cannot-connect" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 &gt; ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった</a></li></ul><blockquote><p>ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった<br>こちらの事象についてよくある原因としては以下があります。</p><ol><li>Standard SKU の内部ロードバランサーのバックエンドプールに所属している</li></ol></blockquote><p>上記ブログ記事は少し情報が古く (というより Azure の進化のスピードが本当にはやく)、現在はこのシナリオのワークアラウンドは以下の 4 つとなっていますが、<strong>明示的に外部接続のポリシーを構成する</strong> という根本的な考え方は変わりません。</p><ul><li>NVA (e.g. Azure Firewall) をデプロイし、0.0.0.0/0 のネクストホップを NVA に向ける UDR を構成する</li><li>NAT Gateway をデプロイし、VM が配置されているサブネットに関連付ける</li><li>Standard SKU のパブリック IP アドレスをデプロイし、VM に関連付ける</li><li>Standard SKU の外部ロードバランサーをデプロイし、そのバックエンド プールに VM を配置する</li></ul><h2 id="機能比較"><a href="#機能比較" class="headerlink" title="機能比較"></a>機能比較</h2><p>フローチャートの他に、幾つかの機能項目をピックアップし SNAT オプション間で比較した表も用意しました。俯瞰的に機能を比べる目的でご利用ください。</p><table><thead><tr><th align="center"></th><th align="center">AzFW/NVA + UDR</th><th align="center">NAT GW</th><th align="center">Public IP</th><th align="center">Public Azure Load Balancer</th><th align="center">Default SNAT</th></tr></thead><tbody><tr><td align="center">関連付け単位</td><td align="center">サブネット[^1]</td><td align="center">サブネット</td><td align="center">NIC</td><td align="center">バックエンド プール</td><td align="center">NIC</td></tr><tr><td align="center">送信元を固定出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">はい</td><td align="center">はい</td><td align="center">はい</td><td align="center">いいえ</td></tr><tr><td align="center">SNAT ポート数を拡張出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">はい</td><td align="center">いいえ</td><td align="center">はい</td><td align="center">いいえ</td></tr><tr><td align="center">SNAT ポート数が VM に静的割り当てされるか</td><td align="center">NVA 依存[^2]</td><td align="center">いいえ (動的確保)</td><td align="center">はい (64000 個)</td><td align="center">はい (数は構成依存)</td><td align="center">はい (1024 個)</td></tr><tr><td align="center">TCP アイドルタイムアウト</td><td align="center">NVA 依存[^2]</td><td align="center">4 ～ 120 分</td><td align="center">4 分</td><td align="center">4 ～ 120 分</td><td align="center">4 分</td></tr><tr><td align="center">利用可能なプロトコル</td><td align="center">NVA 依存[^2]</td><td align="center">TCP/UDP</td><td align="center">TCP/UDP/ICMP/ESP</td><td align="center">TCP/UDP</td><td align="center">TCP/UDP/ICMP</td></tr><tr><td align="center">インバウンド接続性も確保出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">いいえ</td><td align="center">はい</td><td align="center">はい</td><td align="center">いいえ</td></tr></tbody></table><p>それぞれの行で意図している内容は、以下の通りです。</p><ul><li><strong>関連付け単位</strong>: SNAT のポリシーを適用する単位です。例えばサブネットが SNAT ポリシーの単位である場合、サブネット内のすべての VM は同じ方法で SNAT が実施されます。</li><li><strong>送信元を固定出来るか</strong>: この項目が “はい” の SNAT オプションでは、特定の SNAT アドレス プールから送信元の IP アドレスを払い出す事ができます。”いいえ” の SNAT オプションでは、時間経過や VM の先道など、あるイベントをトリガーとして SNAT プールが変更される可能性があります。</li><li><strong>SNAT ポート数を拡張出来るか</strong>: この項目が “はい” の SNAT オプションでは、構成状況を変更することで、ユーザーが各 VM に割り当てる SNAT ポート数を変動させることが出来ます。”いいえ” のオプションでは、予め定められた値のポート数が各 VM に割り当てられます。</li><li><strong>SNAT ポート数が VM に静的割り当てされるか</strong>: この項目が “はい” の SNAT オプションでは、予め各 VM には最大の SNAT ポート数が定められます。基本的に SNAT ポート数は固定ですが、唯一の例外は NAT Gateway です。NAT Gateway では、利用状況に応じて SNAT ポート数は動的に VM に割り当てられます。</li><li><strong>TCP アイドルタイムアウト</strong>: 外部接続の TCP 接続に関するタイムアウト値 (分) です。範囲が記載されている SNAT オプションに関しては、ユーザーが定めることが出来ます。</li><li><strong>利用可能なプロトコル</strong>: 外部接続でサポートされているプロトコルです。すべての SNAT オプションで TCP/UDP はサポートされているものの、ICMP が利用できないオプションもあるので注意してください。</li><li><strong>インバウンド接続性も確保出来るか</strong>: この項目が “はい” の SNAT オプションでは、Azure リソースを追加でデプロイすることなく、インバウンドの接続ポリシーも構成することが出来ます。</li></ul><p>[^1]: UDR の関連付け単位がサブネットであることに起因しています<br>[^2]: NVA による SNAT も結局は NAT Gateway、パブリック IP アドレス、外部 Azure Load Balancer、Azure 既定の SNAT のいずれかのオプションを NVA で利用しています。したがって、NVA の動作制限に加えて、これらの制限も当然加わります。</p><h2 id="SNAT-オプションの詳細"><a href="#SNAT-オプションの詳細" class="headerlink" title="SNAT オプションの詳細"></a>SNAT オプションの詳細</h2><p>このセクションでは、各 SNAT オプションについて少し深堀りして説明します。</p><p>主な特徴やユースケース、注意事項等を記載しますので、ここまでの内容を踏まえて興味の湧いた SNAT オプションについて、詳しく確認してみてください。</p><h3 id="NAT-Gateway"><a href="#NAT-Gateway" class="headerlink" title="NAT Gateway"></a>NAT Gateway</h3><img src="/blog/network/snat-options-for-azure-vm/nat-gateway-snat.png"><p><em>NAT ゲートウェイ (NAT Gateway)</em> は、複数ある SNAT オプションの中で唯一「外部接続だけを目的とした」専用サービスです。専用サービスとだけあって、SNAT プールの固定化はもちろん、動的なポート確保など、他の SNAT オプションにはない機能を有します。</p><p><strong>特徴</strong></p><ul><li>フルマネージドな PaaS サービスで、高い可用性を有します。</li><li>動的に SNAT ポートを確保できるのは NAT Gateway だけです[^3]。</li><li>Public IP や Azure Load Balancer の SNAT よりも、NAT Gateway が優先されます[^4]。</li><li>外部接続の TCP アイドル タイムアウトを最大 120 分に伸ばせます。</li><li>NAT Gateway に追加できるパブリック IP アドレスの最大数は 16 個です。つまり、一つの NAT Gateway あたり、最大 64,000 * 16 = 1,024,000 ポートが SNAT ポートに使えます。</li></ul><p>[^3]: NAT Gateway の動的な SNAT ポート確保動作の詳細は、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource#on-demand" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 &gt; オンデマンド</a> をご覧ください。<br>[^4]: NAT Gateway と Public IP/Azure Load Balancer の共存環境における動作については、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource#nat-and-vm-with-instance-level-public-ip-and-public-load-balancer" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 &gt; インスタンスレベル パブリック IP とパブリック Load Balancer を使用した VM と NAT</a> をご覧ください。</p><p><strong>基本的な構成方法</strong></p><ol><li>NAT Gateway リソースを作成する。</li><li>対象のサブネットに NAT Gateway を関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>一般的な SNAT のシナリオ全般。</li><li>大量に SNAT ポートが必要となる場合。</li><li>複数の VM で SNAT プールを共有したいが、各 VM が消費する SNAT ポート数にばらつきがある場合。</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway では、インバウンドの接続性は提供されません。</li><li>UDR で特定の経路のネクスト ホップを NVA や仮想ネットワーク ゲートウェイに向けている場合、それらを宛先とする通信は NAT Gateway を利用して SNAT されません。</li><li>他の外部接続のサービスで言えば Standard SKU の扱いのサービスなので、Basic のサービスと共存出来ません (e.g. Basic SKU の Public IP が付与された VM がサブネットに存在すれば、NAT Gateway は関連付けできない)。</li><li>ICMP プロトコルはサポートされません。</li><li>その他の制限事項について、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-overview#limitations" target="_blank" rel="noopener">公式ドキュメント</a> をご確認ください。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-overview" target="_blank" rel="noopener">Azure Virtual Network NAT とは | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 - Azure Virtual Network NAT | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/troubleshoot-nat" target="_blank" rel="noopener">Azure Virtual Network NAT 接続のトラブルシューティング - Azure Virtual Network | Microsoft Docs</a></li></ul><h3 id="パブリック-IP-アドレス"><a href="#パブリック-IP-アドレス" class="headerlink" title="パブリック IP アドレス"></a>パブリック IP アドレス</h3><img src="/blog/network/snat-options-for-azure-vm/public-ip-address-snat.png"><p>Azure VM のネットワーク インターフェイス (NIC) にパブリック IP アドレス (Public IP) を関連付けると、その NIC からの外部接続は Public IP によって SNAT される動作となります。</p><p><strong>特徴</strong></p><ul><li>SNAT に利用される IP アドレスは必ず Public IP なので、送信元を固定することが出来ます。</li><li>割り当てられるポート数は、Public IP が利用できるエフェメラル ポートの最大数 64,000 で固定されます。この 64,000 という数字は、もちろん用途にもよりますが、多くのワークロードで十分な SNAT ポート数です。</li></ul><p><strong>基本的な構成方法</strong></p><ol><li>パブリック IP アドレス リソースを作成する。</li><li>対象の VM の NIC に関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>エフェメラル ポートを一つの VM で専有したい場合 (e.g. 多くの SNAT ポートを消費するフォワード プロキシ)。</li><li>外部接続だけでなく VM 単位でのインバウンド接続も確保したい場合 (e.g. 特定拠点からリモート アクセスされる踏み台サーバー)。</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway による SNAT が実施されていないことが前提条件です。</li><li>Basic SKU だと NAT Gateway と共存出来ない等、SKU 依存の制限が存在します。可用性ゾーンへの対応も考慮すると、基本的には Standard SKU の使用が推奨されます。</li></ul><p><strong>参考文献</strong></p><ul><li>[Azure の Outbound connections &gt; シナリオ 1:パブリック IP アドレスありの VM | Microsoft Docs](<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilPublic" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilPublic</a> IP)</li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-network-public-ip-address" target="_blank" rel="noopener">Azure パブリック IP アドレスの作成、変更、削除 | Microsoft Docs</a></li></ul><h3 id="Azure-Load-Balancer"><a href="#Azure-Load-Balancer" class="headerlink" title="Azure Load Balancer"></a>Azure Load Balancer</h3><img src="/blog/network/snat-options-for-azure-vm/auzre-load-balancer-snat.png"><p>外部ロードバランサーのバックエンド プールに Azure VM を配置すると、構成した規則に応じて、フロントエンドの Public IP で SNAT される動作となります。</p><!-- [^Azure Load Balancer-snat-trigger]: 厳密にはバックエンド プールに VM を配置するだけでは不十分で、規則 (送信規則、負荷分散規則、インバウンド NAT 規則) を作るまでは SNAT されません。 --><p>このシナリオでは、特に Azure Load Balancer の Standard SKU でのみ利用可能な <strong>送信規則 (outbound rule)</strong> が効果的に活用できます。送信規則を使うと、SNAT ポート割り当てのカスタマイズや、TCP アイドルタイムアウトの調節が柔軟に構成出来ます。</p><p><strong>特徴</strong></p><ul><li>バックエンド プール単位で SNAT ポリシーが構成されるため、サブネットにとらわれずに複数 VM を同じ方法で SNAT できる。</li><li>Standard SKU で利用可能な送信規則を使って、より仔細に SNAt ポリシーが構成できる。</li><li>送信規則で制御できるパラメータは、以下の通り。<ul><li>バックエンド プール (どの仮想マシンに SNAT ポリシーを適用するか)</li><li>SNAT ポート数の割り当てかた (各仮想マシンに何ポートずつ割り当てるか)</li><li>SNAT の対象とするプロトコル (TCP、UDP、または両方)</li><li>TCP アイドルタイムアウト (4 分から最大 120 分まで)</li><li>タイムアウト時の TCP リセット送信の有無</li></ul></li></ul><p><strong>基本的な構成方法</strong></p><ol><li>パブリック IP アドレスをフロントエンドに付与した Azure Load Balancer (外部ロードバランサー) をデプロイする。</li><li>バックエンド プールを作成し、SNAT ポリシーを適用したい VM を複数追加する。</li><li>送信規則、インバウンド NAT 規則、あるいは送信規則 (Standard SKU のみ) を構成する。</li></ol><p><strong>ユースケース</strong></p><ul><li>SNAT と同時に、インバウンド方向の負荷分散も同時に構成したい場合 (e.g. 処理の一部で外部送信が必要となる WEB サーバー)。</li><li>サブネット以外の単位で、複数 VM を同一 SNAT ポリシー下としたい場合 (e.g. サブネットの一部の VM にのみインターネット接続を許可する)</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway、Public IP による SNAT が実施されていないことが前提条件です。</li><li>Basic SKU と Standard SKU で、SNAT の動作が大きく異なります。これは、Standard SKU で送信規則が追加され、高い自由度で SNAT ポリシーを構成できるようになった為です。</li><li>Basic SKU の場合、SNAT ポート数はバックエンド プールの VM の台数に依存して、Azure 基盤が自動で割り当てます。<ul><li>具体的な対応表は、以下の公式ドキュメントに記載がある通りです。<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ephemeral-port-preallocation-for-port-masquerading-snat-pat" target="_blank" rel="noopener">Azure の Outbound connections &gt; ポート マスカレード SNAT (PAT) 用のエフェメラル ポートの事前割り当て | Microsoft Docs</a></li></ul></li><li>Standard SKU の場合、Basic SKU での自動割り当ての方法に加えて、送信規則を使って手動のポート数割り当てが行えます。<ul><li>送信規則によるポート数の調節については、以下の公式ドキュメントを参考にしてください。<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#azure-load-balancer-outbound-rules" target="_blank" rel="noopener">Azure の Outbound connections &gt; Azure Load Balancer のアウトバウンド規則 | Microsoft Docs</a></li></ul></li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-2-load-balanced-vm-without-a-public-ip-address" target="_blank" rel="noopener">Azure の Outbound connections &gt; シナリオ 2:パブリック IP アドレスなしの負荷分散 VM | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/configure-load-balancer-outbound-portal" target="_blank" rel="noopener">Azure portal を使用して負荷分散規則とアウトバウンド規則を構成する - Azure Load Balancer | Microsoft Docs</a></li></ul><h3 id="Azure-既定の-SNAT"><a href="#Azure-既定の-SNAT" class="headerlink" title="Azure 既定の SNAT"></a>Azure 既定の SNAT</h3><img src="/blog/network/snat-options-for-azure-vm/azure-default-snat.png"><p>パブリック IP アドレスや外部ロードバランサーにも関連づいていない状態でも、Azure VM は既定で外部接続できるようになっています。特に SNAT の構成をしていないのにも関わらず、外部接続ができることで驚いた経験をした方もいらっしゃるのではないでしょうか。</p><p>特にパブリック IP アドレスをユーザーが確保しているわけではないため、SNAT プールはオンザフライでの提供となります。具体的には、VM がデプロイされている Azure リージョンで使用されるグローバル IP アドレスのうち、未使用なものがランダムに割り当てられます。そのため、VM を再起動するたびに、SNAT に利用される NAT アドレスは変動します。</p><p>なお、各 Azure リージョンで使用されるグローバル IP アドレスは、以下ページからダウンロードできる JSON ファイルに定義されています。</p><ul><li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519" target="_blank" rel="noopener">Download Azure IP Ranges and Service Tags – Public Cloud from Official Microsoft Download Center</a></li></ul><p><strong>特徴</strong></p><ul><li>唯一パブリック IP アドレス リソースを作らずに SNAT が出来るシナリオ。</li><li>未使用な IP アドレスがランダムで割り当てられるため、VM が起動するたびに SNAT アドレスが変動する。</li><li>確保される SNAT ポート数は VM あたり 1024 で固定。</li></ul><p><strong>基本的な構成方法</strong></p><p>以下のいずれかの環境で、VM は「Azure 既定の SNAT」で外部接続されます。</p><ul><li>VM を Basic SKU の内部 Azure Load Balancer のバックエンド プールに配置する</li><li>NAT Gateway、パブリック IP アドレス、Azure Load Balancer と関係ないスタンドアロンな VM を構成する</li></ul><p><strong>ユースケース</strong></p><ul><li>テスト/開発用 VM で外部送信が必要になる場合 (e.g. ひとまずインターネットに通信できていれば特に問題ない開発マシン)</li></ul><p><strong>注意事項</strong></p><ul><li>パブリック IP アドレスを付与しなくても外部接続できるという利便性がある一方で、予期せず外部送信を許可していますケースもあります。外部接続を許可しない場合、VM を Standard SKU の内部ロードバランサー配下として意図的に「外部接続不可」環境にするか、NSG で外部送信を拒否する対策等を実施してください。</li><li>SNAT プールが固定出来ないため、外部接続の接続先となるサーバーで ACL を実施するのが難しくなります。</li><li>あくまでテスト目的か、インターネットとの接続性だけ得られていれば後は気にしないようなワークロードでのみご利用いただくことを推奨いたします。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-3-standalone-vm-without-a-public-ip-address" target="_blank" rel="noopener">Azure の Outbound connections &gt; シナリオ 3:パブリック IP アドレスなしのスタンドアロン VM | Microsoft Docs</a></li><li><a href="https://www.syuheiuda.com/?p=5074" target="_blank" rel="noopener">Azure VM の SNAT の話 – Made in container</a></li></ul><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>記事のボリュームからも推察できる通り、Azure では SNAT のオプションが多く用意されています。</p><p>ただ、自由度が上がる副作用として、どうしてもすべてのシナリオを網羅的に把握することが難しくなっています。外部接続できない時のトラブルシューティングや、他にどんな選択肢があるのかの確認に、ぜひ冒頭で紹介したフローチャートを活用していただければと思います。</p><p>また、SNAT オプションの比較には、機能比較のセクションで示した比較表もご活用ください。当該の比較表は、各 SNAT オプションのすべての側面を映し出しているわけではありませんが、大まかにどのような違いがあるのかを知るには十分の情報を記載してあります。ファーストステップとしては丁度よい情報量だと思いますので、参考にしていただければ幸いです。</p><hr><p>※本情報の内容（リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure VM がインターネットに接続する際には、パブリック IP アドレスでの送信元 NAT (SNAT) が必要です。Azure は、外部接続の SNAT に関して多くのオプションを提供していますが、オプションが多くて便利な反面、全オプションの列挙やオプション間の比較が難しいのも事実です。そうした難しさを少しでも緩和できるよう、本稿では外部接続の SNAT オプションを様々な角度から網羅的に紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
      <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
      <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
      <category term="SNAT" scheme="https://jpaztech.github.io/blog/tags/SNAT/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Peering 導入時の注意事項</title>
    <link href="https://jpaztech.github.io/blog/network/considerations-of-microsoft-peering/"/>
    <id>https://jpaztech.github.io/blog/network/considerations-of-microsoft-peering/</id>
    <published>2020-06-15T01:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.941Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure のネットワークとオンプレミス拠点ネットワークを直接接続する ExpressRoute と呼ばれるサービスがあります。ExpressRoute では利用目的に応じた複数のピアリング方法が用意されているのですが、今回は Microsoft Peering と呼ばれるピアリング サービスについて注目して、その構築時に留意いただく必要のあるポイントをいくつかご紹介したいと思います。</p><a id="more"></a><h2 id="Microsoft-Peering-とは何か"><a href="#Microsoft-Peering-とは何か" class="headerlink" title="Microsoft Peering とは何か"></a>Microsoft Peering とは何か</h2><p>ExpressRoute は、オンプレミスと Azure のネットワークをインターネットを介さずに直接接続するためのサービスです。ExpressRoute 回線と呼ばれる Azure リソースを作成し、その中にピアリング情報を構成することで利用できます。</p><p>接続先に応じて下記 2 種類のピアリング種類が用意されており、ひとつの ExpressRoute 回線上に両ピアリングを同時に構成することもできます。</p><ul><li><strong>Private Peering</strong>: 仮想ネットワークとの接続 (Azure 上の Private IP 帯との接続)</li><li><strong>Microsoft Peering</strong>: Azure のパブリック サービス / O365 との接続 (Azure のパブリック IP 帯との接続)</li></ul><p>※ 以前はこの他に Public Peering と呼ばれる種別もありましたが、現在は Microsoft Peering に統合されています。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/ExpressRoute%E3%81%AEPublicPeering%E3%81%A8MicrosoftPeering%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%A2%E3%83%8A%E3%82%A6%E3%83%B3%E3%82%B9.html" target="_blank" rel="noopener">ExpressRouteのPublicPeeringとMicrosoftPeeringに関するアナウンス</a></li></ul><p>今回の記事では、<strong>Microsoft Peering</strong> と呼ばれるピアリング種別についてお話します。ExpressRoute 回線で Microsoft Peering を構成すると、オンプレミス拠点から Azure 上のパブリックなサービスに回線経由で接続できます。</p><p>例えば、BLOB ストレージへのバックアップ通信を ExpressRoute 回線経由とすることが出来ます。</p><h2 id="物理的レイヤー"><a href="#物理的レイヤー" class="headerlink" title="物理的レイヤー"></a>物理的レイヤー</h2><p>高レベルな概念としては、オンプレミス拠点と Azure のネットワークを接続するイメージで間違いないのですが、具体的にルーターのレベルで何をやっているか落とし込むと下図のようになります。</p><img src="/blog/network/considerations-of-microsoft-peering/microsoft-peering-overview.png"><p>まず用語を整理すると、次の通りです。</p><ul><li>Microsoft Enterprise Edge (MSEE): Azure 側のエッジ ルーター</li><li>Privider Edge (PE): プロバイダー側のエッジ ルーター</li><li>Customer Edge (CE): お客様拠点のエッジ ルーター</li></ul><p>Azure リソース上で 1 つの ExpressRoute 回線を作成すると、物理的には Azure 側のルーター (MSEE) が 2 つ確保される動作となっています。MSEE は Active/Active で動作するため、万が一片系に障害が発生しても引き続き通信が可能となります。</p><p>なお、ExpressRoute 回線の契約時に選択いただく帯域幅は、各 MSEE で同じだけ確保されます。例えば、200 Mbps を選択頂いた場合、プライマリ側の MSEE でもセカンダリ側の MSEE でも、それぞれ 200 Mbps が確保されます。</p><h3 id="BGP"><a href="#BGP" class="headerlink" title="BGP"></a>BGP</h3><p>PE と MSEE の間では、インターネットで一般的に用いられている動的な経路交換プロトコルの <strong>BGPv4</strong> (RFC4271) を利用して、お互いのネットワークの経路情報を交換、学習します。</p><p>BGP でピア (ネイバー) を張るには、PE と MSEE のそれぞれのインターフェイスに IP アドレスを割り当てる必要があり、Microsoft Peering ではこのアドレスをお客様側で準備いただく必要があります。PE と MSEE に払い出す IP アドレスが、セカンダリ/プライマリのそれぞれで必要な為、/30 のグローバル IP アドレスのプレフィクスが 2 つ必要です。</p><p>例えば、203.0.113.0/30 と 203.0.113.4/30 をサブネットに利用する場合は、先の図の通りに IP アドレスが払い出されます。つまり、予約済みでない利用可能 IP アドレスのうち、若番が PE 側に、老番が MSEE 側に払い出されます。<code>traceroute</code> を実行したときに MSEE が応答する IP アドレスの参考としていただければ幸いです。</p><h3 id="経路広報"><a href="#経路広報" class="headerlink" title="経路広報"></a>経路広報</h3><p>オンプレミス側から広報する経路情報は、基本的に、PE ルーターで NAT 用に確保しているアドレス プレフィクスです。後述の通り、この経路情報は <code>Advertised public prefixes</code> のパラメータで指定します。</p><p>例えば 203.0.113.0/28 をオンプレミス/プロバイダー側から広報すれば、Microsoft のパブリック サービスから 203.0.113.0/28 に宛てたパケットは、この ExprsesRoute 回線を経由してフォワーディングされる動作となります。このため、オンプレミス側から Azure への通信を 203.0.113.0/28 を SNAT することで、戻り通信が対称的に返ってくるようになります。</p><p>一方で、Azure 側から広報する経路情報は、<strong>ルート フィルター (route filter)</strong> と呼ばれる Azure リソースを利用で指定することが出来ます。逆に言えば、ルート フィルターで広報するまで、Azure 側からは一切経路が広報されません。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/how-to-routefilter-portal" target="_blank" rel="noopener">ExpressRoute:ルート フィルター - Microsoft ピアリング:Azure portal | Microsoft Docs</a></li></ul><h3 id="BGP-コミュニティ"><a href="#BGP-コミュニティ" class="headerlink" title="BGP コミュニティ"></a>BGP コミュニティ</h3><p>ルート フィルターでは、<strong>BGP コミュニティ (BGP Community)</strong> と呼ばれるアドレス プレフィクスの集合を単位として、目的のサービスに適したアドレス帯を Azure 側から広報することが出来ます。</p><p>選択できる BGP コミュニティの一覧は、以下の公式ドキュメントにまとまっています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#support-for-bgp-communities" target="_blank" rel="noopener">Azure ExpressRoute: ルーティングの要件 | Microsoft Docs</a></li></ul><p>簡単に例を挙げると、東日本リージョンのリージョン BGP コミュニティ (12076:51012) をルートフィルターで選択すれば、東日本リージョンで利用しているすべてのパブリック IP アドレスとの通信が ExpressRoute 回線を経由するようになります。</p><h3 id="その他の参考情報"><a href="#その他の参考情報" class="headerlink" title="その他の参考情報"></a>その他の参考情報</h3><p>より詳細については、以下の公式ドキュメントやブログ等をご参考にしていただければ幸いです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-circuit-peerings#expressroute-peering" target="_blank" rel="noopener">Azure ExpressRoute: 回線とピアリング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-faqs#microsoft-peering" target="_blank" rel="noopener">よくあるご質問 (FAQ) - Azure ExpressRoute | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/expressroute-deep-dive-part1" target="_blank" rel="noopener">詳説 Azure ExpressRoute - Part1: ExpressRoute を導入する前に | Microsoft Docs</a></li></ul><h2 id="導入手順"><a href="#導入手順" class="headerlink" title="導入手順"></a>導入手順</h2><p>Microsoft Peering は、大まかに以下の手順で構成いただけます。</p><ol><li>ExpressRoute 回線リソースを作成</li><li>プロバイダー側でプロビジョニング作業を実施</li><li>Microsoft Peeirng の構成を実施</li><li>NAT アドレス利用の承認を待機</li><li>ルートフィルターを構成</li></ol><p>Azure Portal 上での操作方法等は公式ドキュメントに記載されておりますので、詳細はこちらをご覧ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><p>続くセクションでは、導入に際してご留意いただく必要がある点を幾つかご紹介します。</p><h3 id="注意点-プロビジョニング作業の要不要"><a href="#注意点-プロビジョニング作業の要不要" class="headerlink" title="注意点: プロビジョニング作業の要不要"></a>注意点: プロビジョニング作業の要不要</h3><p>まずはじめに注意が必要なのは、手順 2. のプロビジョニング作業です。多くの ExpressRoute 回線プロバイダーでは、回線のプロビジョニング作業を代行して実施するサービスを提供しており、その場合はお客様側で実際に作業が必要となる工程は存在いたしません (このような回線プロバイダーは、L3 プロバイダーと呼ばれることもあります)。</p><p>一方で、お客様側でルーターの管理/構成を実施する必要のある回線プロバイダー (L2 プロバイダーと呼ばれます) も存在します。L2 プロバイダーの場合は、インターフェイスへの IP の割り当て、BGP、経路広報の設定といったルーターの構成を、お客様ご自身で実施して頂く必要があります。お客様の所有するルーターの構成方法については弊サポートでご支援することが叶わない為、プロビジョニング時の技術支援に関しては、別途ベンダー様にお問い合わせいただく必要があります。</p><p>以下の弊社エンジニアによる発表スライド (p10–12) でも L2 / L3 プロバイダーの違いを簡単にご説明をしていますので、こちらも併せてご参考ください。</p><ul><li><a href="https://eventmarketing.blob.core.windows.net/mstechsummit2018-after/CI27_PDF_TS18.pdf" target="_blank" rel="noopener">詳説 Azure ExpressRoute | 発表スライド</a></li><li><a href="https://www.youtube.com/watch?v=xBI-RA8wLqc" target="_blank" rel="noopener">[TS18] CI27 | 詳説 Azure ExpressRoute</a></li></ul><h3 id="注意点-Microsoft-Peering-構成時のパラメータ"><a href="#注意点-Microsoft-Peering-構成時のパラメータ" class="headerlink" title="注意点: Microsoft Peering 構成時のパラメータ"></a>注意点: Microsoft Peering 構成時のパラメータ</h3><p>次に、手順 3. で Microsoft Peering 構成時に入力する項目 (パラメータ) についてです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#to-create-microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><p>基本的な説明は上記ドキュメント内に記載されていますが、特にご質問をいただくことが多いパラメータについて以下で簡単に説明させていただきます。</p><p><strong>アドバタイズされたパブリック プレフィクス (Advertised public prefixes)</strong>:</p><p>オンプレミス側のルーターから広報するプレフィックスをご設定ください。10.x.x.x/28 等のプライベート IP アドレス (RFC 1918) は利用できず、ICANN や RIR から分配されたグローバル IP アドレスを利用する必要があります。<br>Microsoft Peering は、グローバル IP アドレス (いわゆるインターネット) の世界でルーティングを変更するサービスです。一般に、オンプレミス拠点のプライベート ネットワークからインターネットに出ていく際は、グローバル IP アドレスで SNAT する必要がありますが、その NAT アドレスのプールが <code>Advertised public prefixes</code> に該当することが一般的です。</p><p><strong>顧客 ASN (Customer ASN)</strong>:</p><p>前述の <code>Advertised public prefixes</code> として設定されるパブリック IP アドレスが、Peer AS と異なる AS に所属している場合に設定が必要となる場合があります。例えば、PE ルーターではプロバイダーの AS 番号 (これは <code>Peer AS</code> と呼ばれるパラメータです) を利用し、<code>Advertised public prefixes</code> はお客様所有の AS (これが <code>Customer AS</code> です) のパブリック IP アドレスを利用する場合などが該当します。</p><p><strong>ルーティング レジストリ名 (Routing registry name)</strong>:</p><p>BGP ハイジャッキングを防止する目的で、<code>Advertised public prefixes</code> がお客様所有のパブリック IP アドレスかを確認・検証しております。この検証時に RIR / IRR のデータベースを参照しますので、当該アドレスの割り当て元にあたる機関をご選択ください。</p><h3 id="注意点-Advertised-public-prefixes-の手動検証"><a href="#注意点-Advertised-public-prefixes-の手動検証" class="headerlink" title="注意点: Advertised public prefixes の手動検証"></a>注意点: Advertised public prefixes の手動検証</h3><p>選択したルーティング レジストリ (RIR/IRR) のデータベースに <code>Advertised public prefixes</code> が存在しない場合、システムによる自動検証が失敗します。この場合、サポート窓口お問い合わせをいただくことで、担当部門で手動の検証を実施することが出来ます。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#to-create-microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><blockquote><p>‘検証が必要です’ というメッセージが表示された場合は、ルーティング レジストリにプレフィックスの所有者として一覧表示されているエンティティによって組織にパブリック プレフィックスが割り当てられていることを示すドキュメントを収集し、下に示すようにサポート チケットを開くことにより、これらのドキュメントを手動検証のために送信してください。</p></blockquote><p>お問い合わせの際には、承認を受ける ExpressRoute 回線を対象製品としてご選択ください。また、手動検証には以下の 5 つの情報が必要となりますので、こちらの情報を含めてご起票いただければスムーズに手動検証が実施出来ます。</p><ul><li>ExpressRoute 回線のサービス キー</li><li>ExpressRoute 回線をデプロイしたリージョン</li><li><code>Advertised public prefixes</code> (オンプレミス拠点から広報するパブリック IP アドレス)</li><li><code>Peer ASN</code> (MSEE と BGP ピアを張る AS 番号。<code>Customer ASN</code> ではありません)</li><li><code>Advertised public prefixes</code> を <code>Peer ASN</code> で利用出来ることを示す証跡。例えば、他社様から借り受けたグローバル IP アドレスであれば、借り受けたことを示すメールの文面や pdf の文書等が該当します</li></ul><h3 id="注意点-O365-利用時の承認について"><a href="#注意点-O365-利用時の承認について" class="headerlink" title="注意点: O365 利用時の承認について"></a>注意点: O365 利用時の承認について</h3><p>BGP コミュニティのうち、”その他の Office 365 Online サービス” (12076:5100) を選択するには、事前に Microsoft から承認を受ける必要があります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#service-to-bgp-community-value" target="_blank" rel="noopener">Azure ExpressRoute: ルーティングの要件 | Microsoft Docs</a></li></ul><blockquote><p>** Microsoft からの承認が必要です。「Microsoft ピアリングにルート フィルターを構成する\」を参照してください</p></blockquote><p>承認のフォームは以下のリンクから提供しておりますが、フォーム冒頭にも記載がある通り、法的規制などにより閉域網接続の正当性が認められる金融機関などのお客様を除いては、原則申請は承認されない点については予めご留意ください。</p><ul><li><a href="https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbRyOZxByRF1dLgv7k6ye5z8pUQkdLRTQ5QkcyOTU3VkNEOFdOWk9IRDZTUy4u" target="_blank" rel="noopener">ExpressRoute for Office 365 Request Form</a></li></ul><blockquote><p>Microsoft authorization is required to use ExpressRoute for Office 365. Microsoft reviews every customer request and authorizes ExpressRoute for Office 365 usage when a customer’s regulatory requirement mandates direct connectivity. If you have such requirements, please provide the text excerpt and web link to the regulation which you interpret to mean that direct connectivity is required in the ExpressRoute for Office 365 Request Form to begin a Microsoft review. </p><p>(抄訳)<br>ExpressRoute for Office 365 のご利用には Microsoft による承認が必要です。<br>Microsoft では、お客様の申請を検証して、閉域網での接続がお客様の規制要件によって義務付けられていると判断した場合に限り、ExpressRoute for Office 365 の使用を承認しています。<br>そのような要件がある場合は、ExpressRoute for Office 365 リクエスト フォームにて、閉域網接続が必要であることを示す規制文章の抜粋や Web リンクを提供してください。</p></blockquote><h2 id="Microsoft-Peering-に関する-FAQ"><a href="#Microsoft-Peering-に関する-FAQ" class="headerlink" title="Microsoft Peering に関する FAQ"></a>Microsoft Peering に関する FAQ</h2><p>最後に、頻繁にお問い合わせをいただくものの、公式ドキュメントには掲載のないご質問について簡単に回答を掲載させていただきます。</p><p>公式ドキュメントの FAQ ページは以下からアクセス出来ますので、こちらも併せてご参考としていただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-faqs" target="_blank" rel="noopener">よくあるご質問 (FAQ) - Azure ExpressRoute | Microsoft Docs</a></li></ul><p>以下でも解決できないご不明点等がありましたら、ご利用の ExpressRoute 回線を対象製品として選択いただき、弊社技術サポートまでお問い合わせいただければ幸いです。</p><h3 id="Q-選択すべき-BGP-コミュニティはどれですか"><a href="#Q-選択すべき-BGP-コミュニティはどれですか" class="headerlink" title="Q. 選択すべき BGP コミュニティはどれですか?"></a>Q. 選択すべき BGP コミュニティはどれですか?</h3><p>BGP コミュニティでは、サービス カットで IP アドレスを集約していません。そのため、ある 1 つのサービス (製品) を利用する為に、複数 BGP コミュニティの広報が必要となる場合があります。</p><p>必要な BGP コミュニティはサービスの通信要件に依存しますので、通信要件が不明であれば、Azure Portal から技術サポートを起票する際の製品選択において該当するサービス名を選択し、弊社の技術サポートまでお問い合わせください。</p><h3 id="Q-ルート-フィルターで広報経路を追加した際の影響はありますか"><a href="#Q-ルート-フィルターで広報経路を追加した際の影響はありますか" class="headerlink" title="Q. ルート フィルターで広報経路を追加した際の影響はありますか?"></a>Q. ルート フィルターで広報経路を追加した際の影響はありますか?</h3><p>基本的には、新たに経路を追加しても既存の通信に関して影響が出ることはありません。</p><p>ただ、SLA で無影響 (ダウンタイムが発生しないこと) を保証している訳ではなく、さらにプロバイダー側やお客様でご利用されているルーターの動作については保証いたしかねます。少しでも影響が懸念される場合は、夜間帯等での作業実施を推奨させていただきます。</p><h3 id="Q-回線の切り替え時にはダウンタイムは発生しますか"><a href="#Q-回線の切り替え時にはダウンタイムは発生しますか" class="headerlink" title="Q. 回線の切り替え時にはダウンタイムは発生しますか?"></a>Q. 回線の切り替え時にはダウンタイムは発生しますか?</h3><p>はい。別の回線に切り替える際には NAT アドレス (Advertised public prefixes) も変わることが一般的ですので、既存回線の PE で NAT されている既存セッションは切断されることが期待されます。</p><h3 id="Q-Azure-から広報する経路をフィルターできますか"><a href="#Q-Azure-から広報する経路をフィルターできますか" class="headerlink" title="Q. Azure から広報する経路をフィルターできますか?"></a>Q. Azure から広報する経路をフィルターできますか?</h3><p>恐れ入りますが、現時点 (2020/06/13) では Azure から広報する経路を ExpressRoute 回線でフィルタリングする機能は提供がございません。別の言い方をすれば、BGP コミュニティよりも小さい単位で経路を広報することが出来ません。<br>PE ルーター、あるいはお客様拠点のルーターで経路のフィルタリングをご実施ください。</p><hr><p>※本情報の内容（リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure のネットワークとオンプレミス拠点ネットワークを直接接続する ExpressRoute と呼ばれるサービスがあります。ExpressRoute では利用目的に応じた複数のピアリング方法が用意されているのですが、今回は Microsoft Peering と呼ばれるピアリング サービスについて注目して、その構築時に留意いただく必要のあるポイントをいくつかご紹介したいと思います。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
      <category term="Microsoft Peering" scheme="https://jpaztech.github.io/blog/tags/Microsoft-Peering/"/>
    
  </entry>
  
  <entry>
    <title>Azure 環境における Windows Server 2019 の日本語の言語パック適用手順について</title>
    <link href="https://jpaztech.github.io/blog/vm/win2019-jp-lpk/"/>
    <id>https://jpaztech.github.io/blog/vm/win2019-jp-lpk/</id>
    <published>2020-06-10T08:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.957Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの山下です。</p><p>Azure Marketplace における Windows Server イメージは、基本的に英語版をベースとしたものが公開されておりますが、言語パックをインストールいただくことで、表示言語を日本語に変更してご利用いただくことが可能でございます。しかしながら、現在の Windows Server 2019 においては、Windows Server 2016 とは手順が異なることから、下記画像の赤枠のように日本語を追加したにも関わらず、表示言語に日本語を設定できないというお問い合わせをよくいただきます。  </p><img src="/blog/vm/win2019-jp-lpk/1-issue.png">  <p>そこで今回は Windows Server 2019 における日本語の言語パックの適用手順についてご紹介させていただきます。</p><p>なお、Windows Server 2016 以前の手順については、以下の Blog 記事をご参照いただけますと幸いです。</p><blockquote><p>Azure 環境における Windows Server の日本語環境化について<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc</a>  </p></blockquote><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>言語パックのインストールは、更新プログラムやアプリをインストールする前に実施いただく必要があります。詳細は以下の弊社公開情報をご確認くださいますと幸いです。</p><blockquote><p>Windows イメージへの言語の追加 - 考慮事項<br><a href="https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/add-language-packs-to-windows#considerations" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/add-language-packs-to-windows#considerations</a>  </p><blockquote><p>言語をインストールしてから、更新プログラムとアプリをインストールします。 アプリまたは更新プログラム (サービス スタック更新プログラム (SSU) または累積更新プログラム (CU) など) を既に含むイメージに言語を追加する場合は、アプリと更新プログラムを再インストールします。</p></blockquote></blockquote><h2 id="適用手順"><a href="#適用手順" class="headerlink" title="適用手順"></a>適用手順</h2><p>以下の操作は Windows Server 2019 の Azure VM 上で行います。  </p><ol><li><p>下記より言語パックの iso ファイルをダウンロードします。  </p><blockquote><p>Windows Server 2019 デスクトップ エクスペリエンスの言語パックを構成できない<br><a href="https://support.microsoft.com/ja-jp/help/4466511/cannot-configure-language-pack-for-windows-server-2019" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/4466511/cannot-configure-language-pack-for-windows-server-2019</a><br>※ 方法 2: LPKSetupを使用 の手順 1 の [ここ] をクリックすることでダウンロードが可能です。<br>※ ダウンロード先の URL が変更される可能性もございますので、本記事では公開情報へのリンクを紹介しております。  </p></blockquote><img src="/blog/vm/win2019-jp-lpk/2-lpk-dl.png">  </li><li><p>ダウンロードした言語パックをマウントします。下記画像では、E ドライブにマウントしています。  </p><img src="/blog/vm/win2019-jp-lpk/3-mount.png">  </li><li><p>Windows キー を押下、”lpksetup.exe” と入力し、検索結果から起動します。  </p><img src="/blog/vm/win2019-jp-lpk/4-lpksetup.png">  </li><li><p>“Install display languages” をクリックします。  </p><img src="/blog/vm/win2019-jp-lpk/5-install.png">  </li><li><p>[Browse…] をクリックします。  </p><img src="/blog/vm/win2019-jp-lpk/6-browse.png">  </li><li><p>“マウントされている言語パックのドライブ” &gt; “x64” &gt;  “langpacks” &gt; “Microsoft-Windows-Server-LanguagePack_x64_ja-jp” を選択し、[OK] をクリックします。  </p><img src="/blog/vm/win2019-jp-lpk/7-select-ja-jp.png">  </li><li><p>Language 欄に「Japanese(日本語)」が表示されたことを確認し、[Next] をクリックします。  </p><img src="/blog/vm/win2019-jp-lpk/8-select2.png">  </li><li><p>「マイクロソフト ソフトウェア追加ライセンス契約」の内容をご確認いただき、問題がなければ、”I accept the license terms. (同意する)” ラジオボタンにチェックを入れ、[Next] をクリックします。  </p><img src="/blog/vm/win2019-jp-lpk/9-license.png">  </li><li><p>「Japanese(日本語)」のインストールが完了しましたら、[Close] をクリックします。  </p><img src="/blog/vm/win2019-jp-lpk/10-completed.png">  </li><li><p>“Setting”  &gt; ”Time &amp; Language” &gt; “Language” を開き、[Language pack installed] が表示されていることを確認し、プルダウンより [日本語] を選択します。  </p><img src="/blog/vm/win2019-jp-lpk/11-language.png">  </li><li><p>Windows display language に [日本語] が表示され、次回サインイン時に表示言語が切り替わることを示す [Will be display language after next sign-in] が表示されていることを確認し、一度サインアウトします。  </p><img src="/blog/vm/win2019-jp-lpk/12-select-jp.png">  </li><li><p>サインインしなおすことで、表示言語が日本語になったことをご確認ください。下記画像はサーバー マネージャー の表示例です。  </p><img src="/blog/vm/win2019-jp-lpk/13-servermanager-jp.png">  </li></ol><p>表示言語の切り替え後、更新プログラムやアプリのインストールをご実施ください。<br>タイムゾーンの変更等の手順は Windows Server 2016 と同様となりますので、再掲となりますが、以下の Blog 記事をご参照いただきますようお願い申し上げます。</p><blockquote><p>Azure 環境における Windows Server の日本語環境化について<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc</a></p></blockquote><p>こちらの情報が、少しでも皆様のご参考となれば幸いでございます。</p><style>#article-entry img{  border: 1px royalblue solid !important;}</style>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの山下です。&lt;/p&gt;
&lt;p&gt;Azure Marketplace における Windows Server イメージは、基本的に英語版をベースとしたものが公開されておりますが、言語パックをインストールいただくことで、表示言語を日本語に変更し
      
    
    </summary>
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway の証明書関連のトラブルシューティング</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-troubleshooting-cert/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-troubleshooting-cert/</id>
    <published>2020-05-11T03:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.937Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチーム檜山です。</p><p>今回は Application Gateway の証明書まわりについてよくお問い合わせをいただくものをご紹介させていただきます。</p><hr><p>Application Gateway をご利用時に証明書が関連する設定としては、リスナーと HTTP 設定があります。<br>リスナーはクライアントからのアクセスを受け付ける部分で、HTTP 設定はバックエンドの Web サーバーへ接続するための定義を行う部分となります。Application Gateway の設定や構成例については以下もご参照ください。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/ApplicationGateway%E3%81%AE%E6%A7%8B%E6%88%90%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6.html" target="_blank" rel="noopener">Application Gateway の構成について</a></li></ul><p>Application Gateway にて End to End の TLS (クライアントからバックエンドまですべて HTTPS による通信) を構成する場合、リスナーとバックエンドの Web サーバーにて証明書を構成する必要があります (HTTP 設定も構成により証明書の設定が必要)。</p><img src="/blog/network/appgw-troubleshooting-cert/TLS-End2End.png"><p>End to End の TLS にはせずに、クライアントと Application Gateway の間だけを TLS 化する場合は、バックエンドのサーバーや HTTP 設定に対する証明書の設定は必要ありません。Application Gateway に証明書を設定したり、証明書の更新などを行う場合、どちらの証明書が必要か、どの証明書の更新が必要かなどを区別して考える必要があります。</p><img src="/blog/network/appgw-troubleshooting-cert/TLS-Offload.png"><p><span id="application-gateway-error"></span></p><h2 id="Application-Gateway-へアクセスした際の証明書エラー"><a href="#Application-Gateway-へアクセスした際の証明書エラー" class="headerlink" title="Application Gateway へアクセスした際の証明書エラー"></a><a href="#application-gateway-error" style="color:#f60;">Application Gateway へアクセスした際の証明書エラー</a></h2><p>FQDN を使用して Application Gateway のフロントエンド IP アドレスにアクセスした際に証明書のエラーが出る場合、リスナーの証明書に問題がある可能性があります。ブラウザ/ OS により動作が変わる場合があるので、念のため、複数のブラウザ/ OS にてご確認いただくことをお勧めいたします。</p><h4 id="出力例"><a href="#出力例" class="headerlink" title="出力例"></a>出力例</h4><p>Windows の Firefox ブラウザ</p><img src="/blog/network/appgw-troubleshooting-cert/Windows-FireFox.jpg"><p>Windows の Chrome ブラウザ</p><img src="/blog/network/appgw-troubleshooting-cert/Windows-Chrome.png"><p>Linux の curl コマンド</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl https://xxxxx.com</span><br><span class="line">curl: (60) SSL certificate problem: unable to get local issuer certificate</span><br><span class="line">More details here: https://curl.haxx.se/docs/sslcerts.html</span><br><span class="line"></span><br><span class="line">curl failed to verify the legitimacy of the server and therefore could not</span><br><span class="line">establish a secure connection to it. To learn more about this situation and</span><br><span class="line">how to fix it, please visit the web page mentioned above.</span><br></pre></td></tr></table></figure><p>念のため、以下の点についてもご確認ください。</p><ul><li>証明書の CN (Common Name) と URL で指定した FQDN があってない</li><li>証明書の有効期限が切れている</li><li>自己証明書を使用しており、ルート証明書とのチェーンの検証で失敗している</li><li>リスナーに登録した証明書に中間証明書が含まれていない</li></ul><p>4 点目の中間証明書についてですが、リスナーに登録した証明書に中間証明書が含まれていない場合、証明書の検証に失敗し、エラーになる場合があることを確認しております。(クライアントやブラウザによって動作が異なりますが、特に Linux 系のクライアントにて失敗することを確認済)<br>そのため、Application Gateway のリスナーに登録する PFX 形式の証明書は中間証明書を含む形で構成いただく必要がございます。</p><p>Edge や Chrome ブラウザの場合、クライアント側で中間証明書を補完するため、中間証明書に起因する問題が発生しているかがわからないことがあります。その場合、下記に記載の openssl コマンドにて証明書の状態を確認することが可能ですので、念のためご確認いただくことをお勧めいたします。</p><p><span id="probe-error"></span></p><h2 id="正常性プローブのエラー"><a href="#正常性プローブのエラー" class="headerlink" title="正常性プローブのエラー"></a><a href="#probe-error" style="color:#f60;">正常性プローブのエラー</a></h2><p>Application Gateway V2 のバックエンドプールにて証明書が正しく構成されていない場合、バックエンド正常性の画面に以下のエラーが出ることがあります。</p><img src="/blog/network/appgw-troubleshooting-cert/RootCert.png"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The root certificate of the server certificate used by the backend does not match the trusted root certificate added to the application gateway.</span><br><span class="line">Ensure that you add the correct root certificate to whitelist the backend</span><br><span class="line">(バックエンドによって使用されるサーバー証明書のルート証明書が、アプリケーション ゲートウェイに追加されている信頼されたルート証明書と一致しません。バックエンドをホワイトリストに登録するために適切なルート証明書を追加していることを確認してください。)</span><br></pre></td></tr></table></figure><p>以下は SNI が不一致している場合の例。</p><img src="/blog/network/appgw-troubleshooting-cert/SNI-error.png"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The Common Name (CN) of the backend certificate does not match the host header of the probe. </span><br><span class="line">(バックエンド証明書の共通名 (CN) が probe のホスト ヘッダーと一致しません。)</span><br></pre></td></tr></table></figure><p>原因としては以下が考えられます。</p><ul><li>証明書の CN (Common Name) と 正常性プローブの SNI が一致していない</li><li>証明書の有効期限が切れている</li><li>自己証明書を使用しており、ルート証明書とのチェーンの検証で失敗している</li><li>証明書に中間証明書が含まれていない</li></ul><p>バックエンド側にバインドされている証明書の構成が正しいかどうかについても、下記に記載の openssl コマンドにて証明書の状態を確認することが可能ですので、念のためご確認いただくことをお勧めいたします。</p><p><span id="openssl-command"></span></p><h2 id="openssl-コマンドによる確認方法"><a href="#openssl-コマンドによる確認方法" class="headerlink" title="openssl コマンドによる確認方法"></a><a href="#openssl-command" style="color:#f60;">openssl コマンドによる確認方法</a></h2><p>openssl はオープンソースのソフトウェアで Linux 系の OS で利用することができます。<br>Windows OS (Windows 10) の場合でも Windows Subsystem for Linux (WSL) を導入することで利用可能となります。</p><p>以下のコマンドを実行し、実行結果の CN が正しいか、エラーが表示されていないかを等を確認します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Application Gateway への接続確認]</span><br><span class="line">openssl s_client -connect &lt;Application Gateway の IP アドレス&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">[バックエンドへの接続確認]</span><br><span class="line">openssl s_client -connect &lt;バックエンドの IP アドレス&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">※バックエンドが内部 IP の場合は同一 VNET 上の VM からコマンドの実施を行ってください。</span><br></pre></td></tr></table></figure><p>以下の例の赤字部分のようなエラーが表示された場合、使用している証明書に中間証明書が含まれていない可能性がありますので、証明書の構成をご確認ください。</p><p>例 )<br>openssl s_client -connect 52.224.201.173:443 -servername azurecerttest.testacert.com -showcerts</p><p>CONNECTED(00000003)</p><p>depth=0 OU = Domain Control Validated, CN = azurecerttest.testacert.com</p><p><span style="color: red">verify error:num=20:unable to get local issuer certificate</span></p><p>verify return:1</p><p>depth=0 OU = Domain Control Validated, CN = azurecerttest.testacert.com</p><p><span style="color: red">verify error:num=21:unable to verify the first certificate</span></p><p>verify return:1</p><p>～省略～</p><p>Timeout   : 7200 (sec)</p><p><span style="color: red">Verify return code: 21 (unable to verify the first certificate)</span></p><p><span id="intermediate-cert"></span></p><h2 id="中間証明書の構成方法"><a href="#中間証明書の構成方法" class="headerlink" title="中間証明書の構成方法"></a><a href="#intermediate-cert" style="color:#f60;">中間証明書の構成方法</a></h2><p>AppService 証明書を Powershell で Export した場合は中間証明書が含まれていない構成となり、別途、中間証明書を含む形で構成する必要があります。</p><p>AppService 証明書を Azure Portal, Azure CLI でエクスポートした場合、中間証明書は含まれた状態となりますので問題ありませんが、証明書のパスワードを明示的に設定する必要があります。その場合も以下の手順を実施することでパスワードを設定できますのでご利用ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/app-service/configure-ssl-certificate#export-certificate" target="_blank" rel="noopener">App Service 証明書を管理する (証明書をエクスポートします。)</a></li></ul><p>他の証明書においても PFX 形式の証明書に中間証明書が含まれていない場合、Windows 端末にて以下の手順を実施することで中間証明書を含む形で PFX 形式の証明書を構成可能ですので、お試しください。</p><p>※ 以下は Windows 10 の手順ですので、OS によっては少し手順が異なる場合がございます。</p><p>【証明書のインポート &amp; エクスポート】</p><ol><li><p>Azure ポータルから Export した証明書 (PFX) を Windows 端末の任意の場所に配置します。</p></li><li><p>証明書をダブルクリックし、”現在のユーザー” を選択し、”次へ” をクリックします。 </p></li><li><p>インポートするファイルが選択されていることを確認し、”次へ” をクリックします。</p></li><li><p>証明書の“パスワード” を入力し、”このキーをエクスポート可能にする” にチェックをいれ “次へ” をクリックします。<br>※証明書の ”パスワード” が空の場合は ”パスワード” を空にしたまま、”次へ” をクリックします。</p></li><li><p>“証明書の種類に基づいて、自動的に証明書ストアを選択する” を選択し、”次へ” をクリックします。</p></li><li><p>“完了” をクリックします。</p></li><li><p>Windows 端末の左下の Windows マークをクリックし、”certmgr.msc” と入力し、Enter キーを押します。</p></li><li><p>“個人” &gt; “証明書” をクリックし、Import した証明書を右クリックし、”すべてのタスク” &gt; “エクスポート” をクリックします。</p></li><li><p>最初の画面で “次へ” をクリックします。</p></li><li><p>秘密キーのエクスポート画面で “はい、秘密キーをエクスポートします” を選択肢、”次へ” をクリックします。</p></li><li><p>“証明のパスにある証明書を可能であればすべて含む” にチェックが入っていることを確認し、”次へ” をクリックします。</p></li><li><p>証明書の “パスワード” を設定して、”暗号化” が ”TripleDES-SHA1” であることを確認し、”次へ” をクリックします。</p></li><li><p>配置場所を選択して、証明書のファイル名を入力し、”次へ” をクリックします。</p></li><li><p>“完了” をクリックします。</p></li></ol><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq" style="color:#f60;">FAQ</a></h2><h4 id="リスナーに設定した証明書の更新時に切断は発生しますか？"><a href="#リスナーに設定した証明書の更新時に切断は発生しますか？" class="headerlink" title="- リスナーに設定した証明書の更新時に切断は発生しますか？"></a>- リスナーに設定した証明書の更新時に切断は発生しますか？</h4><p>現時点で確認できている動作として V1, V2 共に証明書の更新時に数秒程度の切断が発生することを確認できております。そのため、少しの切断も許容されない環境である場合は、メンテナンス期間等の影響が少ないタイミングで更新いただくことをご検討ください。</p><h4 id="PFX-証明書の中身を確認する方法はありますか？"><a href="#PFX-証明書の中身を確認する方法はありますか？" class="headerlink" title="- PFX 証明書の中身を確認する方法はありますか？"></a>- PFX 証明書の中身を確認する方法はありますか？</h4><p>以下のコマンドを実施することで証明書の構成を確認することができます。</p><p>【Windows】</p><p>コマンドプロンプトで以下を実施します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -dump &quot;ファイルのパス/xxxxx.pfx&quot;</span><br></pre></td></tr></table></figure><p>【Linux】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -info -in &lt;ファイルのパス/xxxxx.pfx&gt;</span><br></pre></td></tr></table></figure><h4 id="利用可能な証明書の一覧はありますか？"><a href="#利用可能な証明書の一覧はありますか？" class="headerlink" title="- 利用可能な証明書の一覧はありますか？"></a>- 利用可能な証明書の一覧はありますか？</h4><p>公開情報として利用可能な証明書の情報はありません。<br>公開情報の要件を満たす証明書であれば利用可能です。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview#certificates-supported-for-tls-termination" target="_blank" rel="noopener">TLS 終了でサポートされる証明書</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits" target="_blank" rel="noopener">Application Gateway の制限</a></li></ul><h4 id="ポータルから証明書を削除する方法はありますか？"><a href="#ポータルから証明書を削除する方法はありますか？" class="headerlink" title="- ポータルから証明書を削除する方法はありますか？"></a>- ポータルから証明書を削除する方法はありますか？</h4><p>現状、ポータルから証明書を削除する方法は提供されておりません。以下の Powershell or Azure CLI のコマンドにて削除可能ですので、ご確認ください。使用中の証明書は削除できませんので、証明書が利用されていないことを事前にご確認ください。<br>また、HTTP 設定用の証明書削除手順は V1, V2 SKU でコマンドが異なりますので、ご留意ください。</p><ul><li>証明書削除 (リスナー用)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. Application Gateway の情報を取得します。</span><br><span class="line">$appgw = Get-AzApplicationGateway -Name &quot;アプリケーション ゲートウェイ名&quot; -ResourceGroupName &quot;リソース グループ名&quot;</span><br><span class="line"> </span><br><span class="line">2. 削除したい SSL サーバー証明書の名前を指定します。</span><br><span class="line">Remove-AzApplicationGatewaySslCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"> </span><br><span class="line">3. Application Gateway に設定を反映します。</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway ssl-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><ul><li>証明書削除 (HTTP 設定用 [V1 のバックエンド認証用証明書])</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. 対象の Application Gateway を取得します。</span><br><span class="line">$appgw = Get-AzApplicationGateway -Name &quot;Application Gateway 名&quot; -ResourceGroupName &quot;ResourceGroup 名&quot;</span><br><span class="line"> </span><br><span class="line">2. 既存のサーバ証明書を削除します。※現在登録されている証明書名を指定します。</span><br><span class="line">Remove-AzApplicationGatewayAuthenticationCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"></span><br><span class="line">3. Application Gateway に設定を反映します</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway auth-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><ul><li>証明書削除 (HTTP 設定用 [V2 のルート証明書])</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. 対象の Application Gateway を取得します。</span><br><span class="line">$appgw = Get-AzApplicationGateway -Name &quot;Application Gateway 名&quot; -ResourceGroupName &quot;ResourceGroup 名&quot;</span><br><span class="line"></span><br><span class="line">2. 既存のルート証明書を削除します。※現在登録されている証明書名を指定します。</span><br><span class="line">Remove-AzApplicationGatewayTrustedRootCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"></span><br><span class="line">3. Application Gateway に設定を反映します</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway root-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><p><span id="reference"></span></p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a><a href="#reference" style="color:#f60;">参考情報</a></h2><p>Application Gateway のトラブルシューティングについては以下にも情報がございますので、ご参照ください。</p><ul><li><a href="./application-gateway-troubleshooting-502">Application Gateway での無効なゲートウェイによるエラーのトラブルシューティング</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting" target="_blank" rel="noopener">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></li></ul><p>証明書の要件については以下にも記載がありますので、ご参照ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview" target="_blank" rel="noopener">Application Gateway での TLS 終了とエンド ツー エンド TLS の概要</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチーム檜山です。&lt;/p&gt;
&lt;p&gt;今回は Application Gateway の証明書まわりについてよくお問い合わせをいただくものをご紹介させていただきます。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Application Gateway をご利用時に証明
      
    
    </summary>
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ApplicationGateway" scheme="https://jpaztech.github.io/blog/tags/ApplicationGateway/"/>
    
      <category term="Certficate" scheme="https://jpaztech.github.io/blog/tags/Certficate/"/>
    
      <category term="SSL" scheme="https://jpaztech.github.io/blog/tags/SSL/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway でサブネットを変更する方法</title>
    <link href="https://jpaztech.github.io/blog/network/appgw_change_subnet/"/>
    <id>https://jpaztech.github.io/blog/network/appgw_change_subnet/</id>
    <published>2020-04-21T05:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.941Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの薄井です。<br>今回は Application Gateway V1 および V2 でサブネットを変更する方法についてご紹介します。</p><p>残念ながら現在の Azure ポータルからは、すでにデプロイした Application Gateway のサブネットを後から変更することはできません。<br>サブネットを変更する必要性が生じたら、新しく Application Gateway を作り直すしかありません。</p><p>しかし Azure PowerShell を使うことで、 Application Gateway を作り直すことなく、既存のサブネットの設定を変更することができます。</p><h2 id="サブネット変更方法"><a href="#サブネット変更方法" class="headerlink" title="サブネット変更方法"></a>サブネット変更方法</h2><p>※ 弊社検証環境でも動作の確認を行っておりますが念のため、お客様環境におかれましても事前に検証環境で動作をご確認のうえ本番環境への適用をお願いいたします。</p><p>※ Application Gateway のフロントエンド IP 構成において、プライベート IP アドレスが固定で設定されている場合は、プライベート IP アドレスと関連するリスナー設定等を削除しておく必要があります。</p><hr><ol><li><p>あらかじめ同一 VNET 内に変更先の新しいサブネットを作成しておきます。</p></li><li><p>Azure PowerShell または ポータルより Cloud Shell を起動し、以下のコマンドレットを入力します。（&lt;&gt;の部分は環境に合わせて変更が必要となります）</p></li><li><p>構成を変更する対象のサブスクリプションを指定します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select-AzSubscription -SubscriptionId &lt;サブスクリプション ID&gt;</span><br></pre></td></tr></table></figure></li><li><p>構成を変更する対象の仮想ネットワークを指定します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$VNet</span> = Get-AzVirtualNetwork -Name &lt;対象の仮想ネットワーク&gt; -ResourceGroupName &lt;変更対象のリソースグループ&gt;</span><br></pre></td></tr></table></figure></li><li><p>変更先のサブネットを取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Subnet</span> = Get-AzVirtualNetworkSubnetConfig -Name &lt;変更先のサブネット名&gt; -VirtualNetwork <span class="variable">$VNet</span></span><br></pre></td></tr></table></figure></li></ol><ol start="4"><li><p>変更対象の Application Gateway を取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$gw</span>=Get-AzApplicationGateway -name &lt;変更対象の Application Gateway 名&gt; -ResourceGroupName &lt;変更対象のリソースグループ&gt;</span><br></pre></td></tr></table></figure></li><li><p>サブネットの変更を加えます。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$gw2</span>=Set-AzApplicationGatewayIPConfiguration -ApplicationGateway <span class="variable">$gw</span> -Name <span class="string">"appGatewayIpConfig"</span> -Subnet <span class="variable">$Subnet</span></span><br></pre></td></tr></table></figure></li><li><p>稼働中の Application Gateway を停止します。※ 停止に数分かかります</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stop-AzApplicationGateway -ApplicationGateway <span class="variable">$gw</span></span><br></pre></td></tr></table></figure></li><li><p>Application Gatewayを設定、開始します。※ 開始に 10 分以上かかります</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AzApplicationGateway -ApplicationGateway <span class="variable">$gw2</span></span><br></pre></td></tr></table></figure></li><li><p>開始後に以前と同様に Web サーバへアクセスできるか確認します。</p></li></ol><hr><p>以上、ご参考になれば幸いです。</p><h2 id="その他の-Application-Gateway-のサブネットに関連する情報"><a href="#その他の-Application-Gateway-のサブネットに関連する情報" class="headerlink" title="その他の Application Gateway のサブネットに関連する情報"></a>その他の Application Gateway のサブネットに関連する情報</h2><p>Application Gateway のサブネットについて関連する情報が以下のページにあります。<br>併せてご参考いただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/configuration-overview#size-of-the-subnet" target="_blank" rel="noopener">アプリケーション ゲートウェイ構成の概要 &gt; サブネットのサイズ</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/configuration-overview#network-security-groups-on-the-application-gateway-subnet" target="_blank" rel="noopener">アプリケーション ゲートウェイ構成の概要 &gt; アプリケーション ゲートウェイ サブネット上のネットワーク セキュリティ グループ</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-faq" target="_blank" rel="noopener">Application Gateway に関してよく寄せられる質問</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの薄井です。&lt;br&gt;今回は Application Gateway V1 および V2 でサブネットを変更する方法についてご紹介します。&lt;/p&gt;
&lt;p&gt;残念ながら現在の Azure ポータルからは、すでにデプロイした Applicati
      
    
    </summary>
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ApplicationGateway" scheme="https://jpaztech.github.io/blog/tags/ApplicationGateway/"/>
    
  </entry>
  
  <entry>
    <title>Azure リソースの意図しない削除について</title>
    <link href="https://jpaztech.github.io/blog/vm/resource-delete/"/>
    <id>https://jpaztech.github.io/blog/vm/resource-delete/</id>
    <published>2020-03-12T08:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.949Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの安田です。</p><p>今回は意図せずリソースやリソースグループを消してしまった際のトラブルシューティングおよび、誤削除が発生しないような運用についてご案内させていただきます。</p><span style="color:gray;"></span><h2 id="リソースの復旧について"><a href="#リソースの復旧について" class="headerlink" title="リソースの復旧について"></a>リソースの復旧について</h2><p>トラブルシューティングと銘打っておきながら大変恐縮ですが、基本的に IaaS 領域のリソースについては削除されたリソースを復元するということはできません。<br><span style="font-size: 75%">(お客様から消してください。と言われたリソース・データを保持しておく方が色々と問題となりますので。。。) </span></p><p>このような背景からも、「リソースグループ / リソースを誤って削除してしまいました。どうにかなりませんか？」と弊サポート部門にお問い合わせいただいても大変心苦しいのですが、復旧することは叶いません。<br>ただし、Storage Account に限ってはわずかですが復旧できる可能性があります。</p><h2 id="Storage-Account-の復旧について"><a href="#Storage-Account-の復旧について" class="headerlink" title="Storage Account の復旧について"></a>Storage Account の復旧について</h2><p>Storage Account （の特定の SKU）に限り、Azure 基盤側から復旧を行うことが可能な場合があります。具体的には GRS と RA-GRS （セカンダリリージョンへの地理冗長が組まれている SKU） が前提となります。<br>これは Storage Account のセカンダリリージョンのデータが削除されるまでに時差があるため、セカンダリリージョンからデータを持ってくることとなります。<br>なお、復旧対象は Storage Account か コンテナ を丸ごと消してしまった場合のみが対象となり、単一のデータを誤削除しても復旧することは叶いませんので、予めご了承ください。</p><p>万が一、誤ってストレージアカウント・コンテナを削除してしまった場合は、削除してしまった Storage Account 名・サブスクリプション ID (英数字32桁)・削除されたおおまかな時刻を記載のうえ弊サポート部門までお問い合わせください。基本的には時間との勝負なので、判明次第すぐにお問い合わせください。<br>また、復旧を行う際に整合性の問題が発生することを避けるため、同名の Stoage Account・コンテナは<span style="font-size: 150%; color: red;">作成しないように</span>お願いいたします。</p><p>なお、復旧が可能となる期間についてはリージョンやデータセンター内部の動作等、様々な要因にて前後するためお伝えすることはできません。過去の事例から削除後すぐにお問い合わせをしたものの、復旧できなかったという事例もございますし、お問い合わせの起票が削除から数日後であったものの復元できたというケースもございます。弊サポート部門でもできる限り復旧できるようにご支援いたしますが、ベストエフォートでの対応となり、復旧が叶わない可能性も十分ございますので、予めご了承ください。</p><h2 id="リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）"><a href="#リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）" class="headerlink" title="リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）"></a>リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）</h2><p>リソースの誤削除は得てしてヒューマンエラーから発生するものであり、注意していても発生してしまうものです。<br>よくある事例として、検証用環境と運用環境でサブスクリプションを分けていたものの、リソース名が同名となっており、コマンドラインから検証用環境のリソースを削除しようとして誤って運用環境リソースを消してしまう等、様々なシナリオが挙げられます。<br>そのため検証用環境と本番用環境で名前を明確に区別しておく、Backup 用のリソースのみ別のリソースグループに保存しておく等、構築段階でヒューマンエラーをできるだけを招きにくくし、発生しても影響が最低限となるように設計しておくことを推奨いたします。</p><p>また、Azure のリソースにはロック機能という誤削除・誤操作防止用の機能を無償にて提供しております。リソースグループやサブスクリプション単位でリソースの削除を防止するだけでなく、Read Only として変更を実行できないようにすることも可能なので、”運用環境に展開済みでこれ以上手を加えたくない。”という場合にもお使いいただく事のできる機能となります。</p><p>設定方法や注意事項については下記のドキュメントに記載されておりますので、ご確認ください。</p><blockquote><p>参考URL: リソースのロックによる予期せぬ変更の防止<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources</a></p></blockquote><p>画像例: 仮想マシンにロック機能を使用</p><img src="/blog/vm/resource-delete/delete.jpg"><p>画像例: 削除時に失敗する</p><img src="/blog/vm/resource-delete/delete2.jpg"><p>なお、下記の通り、リソースロックは 所有者 と ユーザー アクセス管理者 等、Microsoft.Authorization/* または Microsoft.Authorization/locks/* アクション へアクセス可能であるユーザーしか作成・削除することはできません。</p><p>※上記公開情報より抜粋</p><blockquote><p><strong>誰がロックを作成または削除できるか</strong><br>管理ロックを作成または削除するには、Microsoft.Authorization/* または Microsoft.Authorization/locks/* アクションにアクセスできる必要があります。 組み込みロールのうち、所有者とユーザー アクセス管理者にのみこれらのアクションが許可されています。</p></blockquote><p>そのため、IAM の項目から対象のリソースやリソースグループに対して、下記のように特定のユーザーに対して “所有者” か “ユーザー アクセス管理者” の権限を割り当てください。</p><p>Azure Portal &gt; Virtual Machines &gt; 対象の仮想マシン &gt; アクセス制御(IAM) &gt; ロール割り当て &gt; 追加 &gt; 役割とユーザーを選択し、追加</p><p>画像例: 仮想マシンに特定のユーザーに “ユーザー アクセス管理者” を付与</p><img src="/blog/vm/resource-delete/IAM.jpg"><h2 id="BLOB-ファイルの誤削除を未然に防ぐ方法について（Soft-Delete-機能のご紹介）"><a href="#BLOB-ファイルの誤削除を未然に防ぐ方法について（Soft-Delete-機能のご紹介）" class="headerlink" title="BLOB ファイルの誤削除を未然に防ぐ方法について（Soft Delete 機能のご紹介）"></a>BLOB ファイルの誤削除を未然に防ぐ方法について（Soft Delete 機能のご紹介）</h2><p>リソースロック機能は Azure のリソースが対象ですが、”Soft Delete (論理的な削除)機能” を事前に登録いただく事で、Storage Account 内の BLOB ファイルを操作ミス等で削除してしまっても設定した期間内であれば復旧することが可能となります。</p><p>ポータルからさくっと設定・復元することができるため、重要なデータを保護している場合には、有効化いただくことを推奨いたします。設定手順や詳細については下記公開ドキュメントをご確認ください。</p><blockquote><p>参考URL: Azure Storage Blob の論理的な削除<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/blobs/storage-blob-soft-delete?tabs=azure-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/blobs/storage-blob-soft-delete?tabs=azure-portal</a></p></blockquote><p># 現段階では Azure Data Lake Storage Gen2 の Storage Account についてはSoft Deleteの機能はサポートされておりませんので、予めご了承ください。</p><blockquote><p>参考URL: Azure Data Lake Storage Gen2 に関する既知の問題<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/blobs/data-lake-storage-known-issues#support-for-other-blob-storage-features" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/blobs/data-lake-storage-known-issues#support-for-other-blob-storage-features</a><br>※ 抜粋<br>論理的な削除 : まだサポートされていません</p></blockquote><p>以上、少しでもご参考となれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの安田です。&lt;/p&gt;
&lt;p&gt;今回は意図せずリソースやリソースグループを消してしまった際のトラブルシューティングおよび、誤削除が発生しないような運用についてご案内させていただきます。&lt;/p&gt;
&lt;span style=&quot;color:gray
      
    
    </summary>
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Troubleshooting" scheme="https://jpaztech.github.io/blog/tags/Troubleshooting/"/>
    
  </entry>
  
  <entry>
    <title>リソース正常性（Resource Health）アラートの構成方法</title>
    <link href="https://jpaztech.github.io/blog/vm/resource-health-alert/"/>
    <id>https://jpaztech.github.io/blog/vm/resource-health-alert/</id>
    <published>2020-01-24T08:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.953Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの安田です。</p><p>「Azure 基盤側の障害によって仮想マシンが ダウン / 復旧 した際に通知を受け取りたい。」<br>サポート業務をしていてそういったご要望をよくいただきます。<br>そこで今回は、リソース正常性アラートという機能を用いて、障害発生時に仮想マシンがダウンした際に、アラートを受け取る方法をお伝えします。</p><span style="color:gray;"><ul>    <li>ブログ執筆時点では本機能はプレビュー段階となりますので、通知が正常に送付されない可能性がありますので、予めご了承ください。</li>    <li>(鋭意開発中ですが、現段階では一般公開の目途は決まっておりません。)</li>    <li>また、リソース正常性についても、正しく表記されないことがあることもあるため、表記に差異があれば、サポート部門までお問い合わせください。</li></ul></span><h2 id="サービス正常性監視やハートビート監視との住み分けについて"><a href="#サービス正常性監視やハートビート監視との住み分けについて" class="headerlink" title="サービス正常性監視やハートビート監視との住み分けについて"></a>サービス正常性監視やハートビート監視との住み分けについて</h2><p>Azure が提供している他のリソース監視サービスとの違いを簡単に記載します。それぞれ用途や動作が異なるため、ご要件にあったものを選択ください。</p><h3 id="■-リソース正常性アラート"><a href="#■-リソース正常性アラート" class="headerlink" title="■ リソース正常性アラート"></a>■ リソース正常性アラート</h3><p>リソース正常性アラートはリソース正常性に変化が発生した際に、任意の連絡先に通知を飛ばす機能となります。リソース正常性ではリソース単位で発生した障害について確認することができます。仮想マシンに限らず、Storage Account や Microsoft SQL 等、様々なリソースの稼働状況を確認することができます。</p><p>リソース正常性の詳細については、公式ドキュメントおよび、過去の記事とはなりますが、以下の URL を参照ください。</p><blockquote><p>Resource Health の概要<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-overview</a></p></blockquote><blockquote><p>リソース正常性を使って、自分のリソースに何が起きたのかを確認する<br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/04/12/resourcehealth/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2017/04/12/resourcehealth/</a></p></blockquote><p>仮想マシンの場合、リソース正常性は Azure 基盤側から仮想マシンを展開する物理ホストサーバー単位で下記の内容を監視しており、ゲスト OS にて異常を検知した際に、”使用不可”　に変更されることが想定されます。</p><blockquote><p>Azure Resource Health で利用できるリソースの種類と正常性チェック<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines</a><br><br>　　・　ホスト サーバーが稼働しているか<br>　　・　ホスト OS の起動が完了しているか<br>　　・　仮想マシン コンテナーがプロビジョニングされ、オンになっているか<br>　　・　ホストとストレージ アカウント間のネットワーク接続が存在する<br>　　・　ゲスト OS の起動が完了しているか<br>　　・　進行中の定期的なメンテナンスはあるか</p></blockquote><h3 id="■-サービス正常性アラート"><a href="#■-サービス正常性アラート" class="headerlink" title="■ サービス正常性アラート"></a>■ サービス正常性アラート</h3><p>下記の公開情報の通り、サービス正常性アラートはサービスに変更があった際にアラートが発報されます。サービス正常性は仮想マシンのメンテナンス通知やお使いいただいている各サービスの障害についての情報を確認することができます。本機能はリージョン単位での障害など、大規模な障害に対してのみ通知を行うため、物理ホストサーバー単位といった個別の障害についてはアラートは発報されません。</p><p>※公開情報より抜粋</p><blockquote><p>Azure Resource Health の FAQ<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-faq#how-is-resource-health-different-from-azure-status-or-the-service-health-dashboard" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-faq#how-is-resource-health-different-from-azure-status-or-the-service-health-dashboard</a><br><br>Resource Health は Azure の状態や Service Health ダッシュボードと何が違うのでしょうか。<br>Resource Health の方が、Azure の状態や Service Health ダッシュボードと比べて具体的な細かい情報が得られます。<br><a href="https://status.azure.com/" target="_blank" rel="noopener">Azure の状態</a>と Service Health ダッシュボードでは広範な顧客 (Azure リージョンなど) に影響するサービスの問題に関する情報を通知しますが、Resource Health では特定のリソースのみに関連するより詳細なイベントを公開します。<br>たとえば、ホストが予期せず再起動するとき、Resource Health はそのホスト上で仮想マシンが実行されている顧客のみに警告します。<br>リソースに影響を与えるイベントを完全に可視化することが重要であるため、Resource Health には、Service Health ダッシュボードで発行されたイベントも表示されます。</p></blockquote><p>サービス正常性アラートについては下記ドキュメントをご確認ください。</p><blockquote><p>サービス通知のアクティビティ ログ アラートを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/alerts-activity-log-service-notifications" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/alerts-activity-log-service-notifications</a></p></blockquote><h3 id="■-ハートビート監視（Log-Analytics）"><a href="#■-ハートビート監視（Log-Analytics）" class="headerlink" title="■ ハートビート監視（Log Analytics）"></a>■ ハートビート監視（Log Analytics）</h3><p>仮想マシン内にインストールした Log Analytics のエージェントから定期的に Azure 基盤通信を行い、仮想マシンが正常かどうか確認します。特定の期間、仮想マシンからの通信が途絶えた場合に、アラートが発報されます。仮想マシン内で発生したや通信断等の問題を検知できる一方で、エージェントの不具合やAzure 基盤側のワイヤーサーバー側が原因となってアラートが誤発報されることもあります。また、Log Analytics では OS 内のメトリック（メモリ使用率や CPU 使用率等）をトリガーとしてアラートを発報することも可能です。ハートビート監視の設定手順については、下記のドキュメント内の「Q. データ収集が停止したときに通知を受けるにはどうすればよいですか?」の項目を参照ください。</p><blockquote><p>Log Analytics についてよく寄せられる質問<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/platform/log-faq#q-how-can-i-be-notified-when-data-collection-stops" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/azure-monitor/platform/log-faq#q-how-can-i-be-notified-when-data-collection-stops</a></p></blockquote><h2 id="アラート作成前に"><a href="#アラート作成前に" class="headerlink" title="アラート作成前に"></a>アラート作成前に</h2><p>前提として、現段階ではアラートはポータルから作成することはできず、 Resource Manager テンプレートをデプロイして作成する必要があります。テンプレート内容やデプロイ手順の詳細は下記ドキュメントを参考ください。</p><blockquote><p>Resource Manager テンプレートを使用して Resource Health アラートを構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-alert-arm-template-guide" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-alert-arm-template-guide</a></p></blockquote><h3 id="■-Azure-PowerShell-のインストール"><a href="#■-Azure-PowerShell-のインストール" class="headerlink" title="■ Azure PowerShell のインストール"></a>■ Azure PowerShell のインストール</h3><p>テンプレートは Azure PowerShell というモジュールを用いてデプロイを行います。そのため、Azure PowerShell が既に導入されている Cloud shell で代用いただくか、下記のドキュメントよりお手元の環境にインストールください。</p><blockquote><p>Azure Cloud Shell の概要<br><a href="https://docs.microsoft.com/ja-jp/azure/cloud-shell/overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cloud-shell/overview</a></p></blockquote><blockquote><p>Azure PowerShell モジュールのインストール<br><a href="https://docs.microsoft.com/ja-jp/powershell/azure/install-Az-ps?view=azps-3.1.0" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/powershell/azure/install-Az-ps?view=azps-3.1.0</a></p></blockquote><h3 id="■-アクション-グループの作成"><a href="#■-アクション-グループの作成" class="headerlink" title="■ アクション グループの作成"></a>■ アクション グループの作成</h3><p>本アラート作成前に、アクション グループというリソースを作成しておく必要があります。<br>アクショングループはアラートのトリガーを満たした際に、何処の宛先にどういった通知を行うかを登録しておくリソースとなります。<br>作成手順については下記ドキュメントをご確認ください。</p><h2 id="JSONテンプレートの内容について"><a href="#JSONテンプレートの内容について" class="headerlink" title="JSONテンプレートの内容について"></a>JSONテンプレートの内容について</h2><p>リソース正常性アラート設定について、公開ドキュメントの補足、Json 内の各パラメータについて自分流にカスタマイズを行うにあたってのポイントを記載します。まずは、公開ドキュメント内の「Resource Health アラートの Resource Manager テンプレート オプション」のテンプレートを参考にして参考にしましょう。手を加える必要のある部分についてそれぞれ説明します。</p><h3 id="■-スコープ-“scopes”"><a href="#■-スコープ-“scopes”" class="headerlink" title="■ スコープ(“scopes”)"></a>■ スコープ(“scopes”)</h3><p>本項目で、対象とするリソースを選択します。規定ではサブスクリプション内の（リソース正常性が確認できる）リソース全てを対象としていますが、リソースグループ単位で対象を選択することができます。リソースは下記のように指定ください。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;scopes&quot;: [</span><br><span class="line">#リソースグループをスコープとした場合</span><br><span class="line">&quot;/subscriptions/\&lt;subscription id&gt;/resourcegroups/\&lt;resource group&gt;&quot;</span><br><span class="line"></span><br><span class="line">#1つのリソースをスコープとした場合</span><br><span class="line">&quot;/subscriptions/\&lt;subscription id&gt;/resourcegroups/\&lt;resource group&gt;/providers/&lt;resource&gt;&quot;</span><br><span class="line"></span><br><span class="line">#サブスクリプション全体をスコープとした場合</span><br><span class="line">&quot;/subscriptions/\&lt;subscription id&gt;&quot;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>providers 以下の項目は、Azure ポータルにてリソースのプロパティ内画面を確認いただき、“リソース ID” の項目から引用ください。</p><p>#抜粋例</p><img src="/blog/vm/resource-health-alert/resoruceid.png"><p>また、サブスクリプションやリソースグループ単位でアラートを設定する場合、特定のサービスからのみ通知を受け取りたい場合には、「アラートを生成するリソースの種類の調整」の項目に従って、受け取るサービスを指定ください。</p><h3 id="■-発報のトリガー-リソースの状態-“condition”"><a href="#■-発報のトリガー-リソースの状態-“condition”" class="headerlink" title="■ 発報のトリガー / リソースの状態 (“condition”)"></a>■ 発報のトリガー / リソースの状態 (“condition”)</h3><h4 id="▼-発報のトリガーについて"><a href="#▼-発報のトリガーについて" class="headerlink" title="▼ 発報のトリガーについて"></a>▼ 発報のトリガーについて</h4><p>アラートはリソースのステータス（<strong>Available</strong> / <strong>Unavailable</strong> 等）の変化（<strong>Active</strong> や <strong>Resolved</strong> 等）をトリガーとして発報されます。リソース正常性の変更が発生したタイミング、解消したタイミングでアラートを受け取るために <strong>Active</strong> および  <strong>Resolved</strong> のみをスコープに含めます。 <strong>Update</strong> / <strong>In Progress</strong> は問題の継続中に常に出力されるステータスなので、取得することは推奨しません。 <strong>Degraded</strong> の項目は Storage Account 等の可用性が下がり、一部のアクセスに失敗する際などに発生しますが、仮想マシンの場合に、このステータスが発生することはありません。</p><h4 id="▼-Unkown-状態について"><a href="#▼-Unkown-状態について" class="headerlink" title="▼ Unkown 状態について"></a>▼ Unkown 状態について</h4><p>リソース正常性には Azure 基盤側から仮想マシンまでの正常性が一時的に確認ができない際に表記される <strong>Unknown</strong> という状態があります。 <strong>Unknown</strong> 状態となった際にも、リソース正常性のトリガーは <strong>Active</strong> となり、<strong>Active</strong> をトリガーとしていた状態ではアラートが発報されます。 <strong>Unknown</strong> は基盤側にて問題が発生していない場合にも発生することがあるため、正確なアラートを受け取るためには、<strong>Unknown</strong> 時にアラートが発報されないように設定しておくことが無難です。<br>アラートが <strong>Active</strong> / <strong>Resolved</strong> で、且つ前回 / 現在の仮想マシンの状態が　<strong>Available</strong>　や <strong>Unavailable</strong> であるときにアラートを発生するように指定しておきましょう。（前述の通り、仮想マシンに関しては <strong>Degraded</strong> は発生しないため、こちらは記載してもしなくても大丈夫です。）</p><p>記載の方法については、「”Unknown” イベントを回避するための Resource Health アラートの調整」/ 「完全な Resource Health アラート テンプレート」の項目にて記載されているロジックを参考ください。</p><h4 id="▼-発生起因の指定について"><a href="#▼-発生起因の指定について" class="headerlink" title="▼ 発生起因の指定について"></a>▼ 発生起因の指定について</h4><p><strong>properties.cause</strong> の項目では、原因となるトリガーの発生起因について、指定することができます。  <strong>PlatformInitiated</strong>  と指定することで、基盤側の障害発生時のみアラート対象とすることができます。一方、<strong>UserInitiated</strong> と指定することで、ユーザー起因の操作（停止 / 再起動 / OS 内再起動 等）でアラートが発報されます。<strong>PlatformInitiated</strong> を指定しない場合には、どちらが原因でもアラートが発報されることとなります。記載手順は、「ユーザーが開始したイベントを回避するためのアラートの調整」の項目を参照ください。</p><p>テンプレートが完了したらドキュメント内の ”Instructions”  の項目に従って Azure PowerShell からデプロイを行います。ProvisioningState が Succeeded であれば、作成が正常に完了しています。（アラートが適用されるまで 5 分程度かかる可能性があります。）</p><h3 id="■-発報されるアラートのサンプル"><a href="#■-発報されるアラートのサンプル" class="headerlink" title="■ 発報されるアラートのサンプル"></a>■ 発報されるアラートのサンプル</h3><p>アラートが発報されると下記画像のようなアラートが <a href="mailto:azure-noreply@microsoft.com" target="_blank" rel="noopener">azure-noreply@microsoft.com</a> から届きます。</p><img src="/blog/vm/resource-health-alert/sample.png"><p>上記のサンプルでは対象の仮想マシン （”Resource ID”  に記載）が使用可能状態<font color="Lightblue">（青下線部）</font>から使用不可の状態<font color="red">（赤下線部）</font>に変更されたこと。ユーザーの操作<font color="green">（緑下線部）</font>による発生であることが記載されております。（基盤側の問題の場合には、<strong>PlatformInitiated</strong>  となることが想定されます。）</p><h3 id="■-アラートのテストについて"><a href="#■-アラートのテストについて" class="headerlink" title="■ アラートのテストについて"></a>■ アラートのテストについて</h3><p>残念ながら、現段階で意図的に Azure 基盤の障害を再現することはできません。そのため、 <strong>UserInitiated</strong>  をトリガーに加えた上で、仮想マシンを Azure ポータルから停止 / 起動等、一時的に使用不可能の状態を作りアラートが発報されるか確認ください。</p><h3 id="■-アラートの停止-削除について"><a href="#■-アラートの停止-削除について" class="headerlink" title="■ アラートの停止 / 削除について"></a>■ アラートの停止 / 削除について</h3><p>アラートの停止 / 削除 / 再有効化については、Azure ポータルから行うことが可能です。</p><p>Azure ポータル　＞　Azure Monitor　＞　アラート　＞　アラート ルールの管理　＞　対象のアラートを選択　＞　無効化 / 削除 / 再有効化</p><p>※画像例</p><img src="/blog/vm/resource-health-alert/delete.png"><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>アラートには最低限の情報しか記載されないため、発生した事象のより詳細な切り分け・調査報告等が必要な場合には、Azure Portal より弊サポート部門へのお問い合わせを起票ください。  <br></p><p>以上、ご参考となれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの安田です。&lt;/p&gt;
&lt;p&gt;「Azure 基盤側の障害によって仮想マシンが ダウン / 復旧 した際に通知を受け取りたい。」&lt;br&gt;サポート業務をしていてそういったご要望をよくいただきます。&lt;br&gt;そこで今回は、リソース正常性アラートと
      
    
    </summary>
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Resource Health" scheme="https://jpaztech.github.io/blog/tags/Resource-Health/"/>
    
  </entry>
  
  <entry>
    <title>なぜ今サポートエンジニアが熱いか</title>
    <link href="https://jpaztech.github.io/blog/other/technical_support_engineer_explained/"/>
    <id>https://jpaztech.github.io/blog/other/technical_support_engineer_explained/</id>
    <published>2019-12-05T04:00:00.000Z</published>
    <updated>2020-06-19T12:16:02.949Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、マイクロソフトの石井 哲平です。<br>2007年に新卒でマイクロソフトのサポートエンジニアとして入社をし、長らくエンジニアを楽しんで来ました。<br>2018 年より、サポートエンジニアのチームでマネージャー職をしています。</p><p>サポートエンジニアという職業に魅力を感じ、都度サポートエンジニアであることを選び続けてきたという自負はありますが、あらためて、マネージャーという職について、その価値の言語化が必要だと感じた次第です。<br>サポートエンジニアって何？という方に知ってもらいたい。<br>あるいは、今サポートエンジニアだよという方、自信を持ちましょう！<br>そういう気持ちを込めて書いていきます。</p><p>極力一般化して書きたい部分ではありますが、経験上、部分部分でマイクロソフトに言及する点はあらかじめご了承ください。</p><h2 id="サポートエンジニアの仕事とは"><a href="#サポートエンジニアの仕事とは" class="headerlink" title="サポートエンジニアの仕事とは"></a>サポートエンジニアの仕事とは</h2><p>技術職です。IT (ソフトウェア、ハードウェア) 関連の技術を持って、お客様のお困りごとを解決するというサポートです。</p><p>私の5歳の子供には、「<u>コンピューターのお医者さんだよ</u>」と伝えています。医者や弁護士に負けないぐらい、日々専門知識を研鑽し、社会に役立つという側面では合っていると思います。</p><p>プログラマーやSIerさんとの違いは、トラブルシュートに重きが置かれている点でしょう。担当製品によってソースコードを読む・ネットワークパケットを分析する・デバッグをするといったことはありますが、プログラミングをすることが主業務ではありません。顧客と直接の電話・メール、あるいはチャット等を駆使して、問題点をヒアリング、到達目標を交渉します。このソフトスキルも重要となる点が大きな違いです。</p><p>コールセンターとの違いは、ある範囲の製品群・機能群にオーナーシップを持ち、調査と回答の責任を有するということです。企業によって、「初動をとり簡単な案件を対応するフロント・難しい案件の詳細調査を行うバックエンド」の分類がある場合があります。(マイクロソフトではこの分類はほぼ存在しません。) また、クレームを聞くだけ、というケースも非常に少ないです。技術力があること、そして会社の中でも製品へのフィードバックが出来る部署であるが故、技術的なソリューションや、今後の製品としてのロードマップなど、何らしか未来に繋げることが出来ることが多いためです。</p><p>私の主観が入ってしまいますが、様々にある仕事の中で、「目の前のお客様を助けてあげたい、そのために何ができるだろう」ということだけに真剣になれるということがとても響きます。お給料以外のところで、自分の社会的な価値が実感できる部分です。「何千万円の商談」「何百人の聴衆の前でプレゼン」といった派手さはなく、あくまで1人1人のお客様と向き合っての地道なやりとりですが、確かに「必要とされ、時に感謝していただける」という温度感がわかるものでした。</p><h2 id="なぜ今サポートが熱いか"><a href="#なぜ今サポートが熱いか" class="headerlink" title="なぜ今サポートが熱いか"></a>なぜ今サポートが熱いか</h2><p><u>皆さん、Youtubeを見ますか？</u>広告が出ますが、そのときにどのように感じるでしょうか。中には面白いものがあって、うっかり全部見てしまうようなこともあるでしょう。一方で、いかなる内容であれ、実際に見たいコンテンツではないものが強制的に表示され、時間が奪われてしまうわけですから、多少なりとも「鬱陶しい」「時間の無駄」「広告をスキップはよ」といったネガティブな感情を抱くことがあるのではないでしょうか。</p><p>企業は莫大な費用を払って、少しでも多くの人に商品や企業イメージの良さを伝えたいという一心でこれを行っていますが、必ずしもこれを広範に行うということが、個々人にとっての良い印象に繋がるわけではありません。</p><p>他方、サポートとはどういうものでしょうか。最初は「せっかく製品を買ったのに、問題があった、どうしてくれるんだ？」という<u>最悪の印象</u>からスタートします。問題が解消しなければ、その悪い印象を拭い去ることは難しいかもしれません。しかしながら、<u>時に何時間、何日といった期間、サポート担当者がその問題に向き合い、要望をしっかり聞いてくれる。</u>この体験を通じて、「<u>この会社、信頼出来るな。今回はちょっと苦労したけど、また次も使ってあげよう。</u>」という気持ちになる。</p><p>15秒のCMを我慢できない一方で、トラブルに対して何時間も付き合った結果、この時間のかけ方とはかけ離れた信頼関係に繋がるチャンスがあります。</p><p>※「ザッポス伝説」(トニー・シェイ著)という書籍もオススメです。サポートサービスの重要性、サービスを提供する人間の価値について書かれています。ひいては、サポートを提供する人間が「他者を幸福にする」という文化を持つことがいかに大事なのか、というような内容です。</p><p>現在、クラウドに限らず多くの業界がサブスクリプション ビジネスです。常に信頼と魅力を伝えていかないといけない中、サポートがどのような役割を担うのかという観点で見るとその重要性が分かります。</p><p>マイクロソフトでは、パブリッククラウドの世界一を目指して強烈に力を入れています。クラウドでは、「やーめた！乗り換えよう」が簡単にできる世界です。お客様となる企業は、製品の機能リストを見て比べているわけではなく、信頼を出来る会社かどうかを見ています。「自社のデータを置いてもいいのか？撤退しない？」「自社が使っている機能で問題が出たらさじを投げるのではないか」「お客様のことを見てくれているのか？自分たちに都合がよいように、儲かるものだけを続けて他を捨てるといったことがないか」このような不信感を拭うのは、CMでも現在の華々しい機能リストでもありません。サポート、ひいては「お客様を大事にする文化」です。サポートは、エンジニアとお客様、一対一のやりとりを通じてこれを行います。</p><p>本当に困ったとき、トラブったときこそ、人の本性が出るといいます。ここで粘り強く解決に向けて対応ができるかどうかが、そのお客様にとっての最後の砦ということです。</p><h2 id="サポートエンジニアで伸びる能力と価値"><a href="#サポートエンジニアで伸びる能力と価値" class="headerlink" title="サポートエンジニアで伸びる能力と価値"></a>サポートエンジニアで伸びる能力と価値</h2><p><strong>１. 技術力</strong> - 当然のことながら、特定の製品については内部的なドキュメント、トレーニング資料、データセンターに残るデータ分析、日々様々な角度からのお問い合わせを通じて圧倒的な速度で成長します。マイクロソフトでは、開発部門も多くは Dev&amp;Ops で運用していますので、現在進行形で仕様を把握し判断できる開発部門と問題について協議をすることも出来ます。彼らが、その製品の業界事情などをどのように見ているかが垣間見れる点も面白いところです。</p><p><strong>２．問題解決力</strong> – お客様からのお問い合わせは、その文面通り回答すればハッピー、というわけにはいきません。テック、ソフト、両面から問題を聞き混み、どのように力になれるのかということを考えます。マイクロソフトに限らずだと思いますが、メーカーのサポートは、「こうすれば万事OK」というソリューションがない世界です。大小様々な企業で、自社独自の製品の問題をどのように解決していくか、ということを試行錯誤しています。<u>プログラムを書いて新製品を生み出しているわけではありませんが、この世界の誰もがやったことのない、未知の世界で頑張っているわけです。</u>マイクロソフトはそれはもう特に顕著で、「パブリッククラウド特有の問題」「クラウド＋オンプレミスの複雑な問題」「インフラ、Windows、OSS、Office等々の異なる製品とそのカルチャーの混在」などなど、うまくいかないことを手探りでやり、お客様にとって今できるベストとは？を考えています。とてもクリエイティブな仕事です。</p><p><strong>３．チームワーク</strong> – もはや、1人のスーパーエンジニアが何もかも把握している、ということは不可能です。新人でも二ヶ月もすれば、その人しかしらない知識と経験が存在するでしょう。(そもそも、一部の限られた超人がいて、それに頼ったとしても、世界中で急速に成長するクラウドの領域において、スケールするのでしょうか。) このため、チームワークが何よりも大事です。マイクロソフトでは、Swarming (スウォーミング) というオペレーションを促進しており、これは、案件ごとに異なるテクノロジーを担当する複数のエンジニアを招集して、「問題解決チーム」を作りましょう、という文化であり仕組みです。このため、案件のオーナーは、知らない領域であっても、その問題にヘルプになる人間を集めるというリーダーシップをとる練習になりますし、何より、広域な問題について打ち込むという経験を積めるということになります。サポートエンジニアとして、特定の製品群に詳しいけども、さらに未知の様々な製品が関連した問題にもアプローチが出来るようになる、ということです。</p><p><strong>４．個人の価値と認知度</strong> – サポートエンジニアの仕事の多くは、日々お客様の困りごとを解決することです。しかしながら、今後は、個人としての価値も上げていく時代です。積み上げてきたナレッジを基に、情報を発信する (本を書く・イベントで登壇する)、社内外でコミュニティを築く、といったことに目を向けると、個人としての価値もより有形になってくるでしょう。</p><p><strong>５．英語力</strong> - 外資系企業の場合、日々、開発部門との連携において英語でやりとりをします。多くは読み書きでなんとかなりますが、興味があれば Teams で電話をしてみてもよいでしょう。かつて、外資系企業では、ミーティングで発言をしない参加者は無価値である、といった事が言われていましたが、今は時代が変わっています。Diversity &amp; Inclusion (D&amp;I) といった言葉がありますが、これはいわゆる女性採用に限らず、様々な文化圏、価値観がある人を尊重し、全員の意見を漏らさないようにしましょうということです。このため、特に社内の英語のオンライン会議では、「What else?(他には?)」というキーワードが飛び出し、完全な沈黙が続かない限り誰かがしゃべるタイミングを設けるということが増えてきました。ミーティングの後「英語が早くてしゃべりにくかったでしょ？後でメールしてもらったら、私が代わりに皆に伝えておくよ」といった個別の声がかかることがあります。技術的なやりとりでは、画面を共有して「THIS! THIS!ストレンジ！エラー！」と叫び続けることでなんとか相手に問題を伝えたらなんとかなるということも。相手も同じチームなわけですから、「これはまずい問題がおきているな。こっちで人をかきあつめて直しておくから、アップデートを待っててくれよ。」という感じで、オーナーシップを引き取ってくれることも。世界のエンジニアと協力して、お客様の問題が解決できたとしたら、カッコよすぎませんか？たぶんその日はスキップして家に帰ると思います。</p><p>最後に、サポートエンジニアそれぞれの心の持ち方も重要です。一部では、「過去にやったことのある、既知の問題について対応する案件はつまらなく飽きてしまう」という声を聞きます。程度の問題ではありますが、私はそうは思いません。あらゆるお客様について、腑に落ちていない点や、それを踏まえた説明の仕方は異なります。サポートエンジニアは、(少なくともマイクロソフトでは) 技術的な回答をすることは必要最低限の仕事であり、その先にある信頼の獲得がゴールです。お客様ごとに異なる特徴と、コミュニケーションにおける差が必ずあり、それに真摯に向き合った先には必ず自分、ひいては組織の成長があるはずです。</p><h2 id="転職-サポートエンジニア-→-他社のサポートエンジニア"><a href="#転職-サポートエンジニア-→-他社のサポートエンジニア" class="headerlink" title="転職: サポートエンジニア → 他社のサポートエンジニア"></a>転職: サポートエンジニア → 他社のサポートエンジニア</h2><p>同じサポートエンジニアという業務形態はそのままで、他の会社にいく必要性、これは3つほど理由があります。</p><h3 id="サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ"><a href="#サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ" class="headerlink" title="サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ"></a>サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ</h3><p>既にサポートエンジニア職についている技術者が、他のサポートエンジニア職に応募するとしたら、やはり<u>サポートに脚光があたり、投資がしっかりしている所を探す</u>のがよいでしょう。業界としてスポットライトが当たっている、口コミ、色々とあると思います。<br>サポート業務は、時と場合によっては「コストセンター」という扱いになります。新製品を開発し、販売するというプロフィット (利益) センターに対して、コストがかかるだけの組織、という見方ですね。そうなると、コストカットとなると少ない人員で、より短い解決時間でといった余計な達成目標が設定されてしまいます。コストとは非常にアンフェアな言い方だと思います。営業だってプログラマーだってコストは生じているでしょうに、会社によっては一部の組織に対してのみ、そう認識されてしまうようです。マイクロソフトも、私が入社した12年前はそう呼んでいましたが、カスタマーサービスの重要性に気付いてからはめっきりそのような呼ばれ方はしなくなりました。今や、製品の印象や将来を担う重要なドライバーという位置づけです。</p><p>サポートの声を会社として聞く気があるのか、ということにも繋がります。お客様の声を、よかれと思って開発部門に伝えて、それが反映されるかどうか。</p><p>是非、サポートエンジニアが輝ける職場を求められることをお勧めします。そして、今そういう場所にいるよ、という方は、あらためてその価値を再認識してほしいです。</p><h3 id="成長ができる企業文化を選ぶ"><a href="#成長ができる企業文化を選ぶ" class="headerlink" title="成長ができる企業文化を選ぶ"></a>成長ができる企業文化を選ぶ</h3><p>無駄なルールが無い合理性、人間としての成長、お互い尊敬をしあえる仲間、お客様や仲間の成功を喜ぶ、そういったものは、共通の価値観となる企業文化にて醸成されるものです。多くの企業がそういった素晴らしい企業文化を持っていると思いますが、そういった根本的な価値観 (コア バリュー) に変化を持たせるという観点で転職してみることも良いかもしれません。</p><p>マイクロソフトでは、「Growth Mindset(成長する考え方)」を根幹においてます。前述のとおり、世界最大規模のクラウドの構築・運用・サポート・営業、全てにおいて、手探りであり、今の時点での正解はありません。常に「あれがないこれがない」という世界で、成長に繋げられるようにという思いがあります。また、様々な部署・国・価値観によって構成される人間が手をとりあって成功に繋げられるよう、「お客様」を共通のキーワードにしています。外資ですが、なんとなくイメージされるような激しい競争、ライバルとの蹴落としあい、といったものとは正反対の文化です。</p><h3 id="スキルが伸びる職場を選ぶ"><a href="#スキルが伸びる職場を選ぶ" class="headerlink" title="スキルが伸びる職場を選ぶ"></a>スキルが伸びる職場を選ぶ</h3><p>ソフトスキル、技術スキル問わず、成長が行き詰まるということは、エンジニアを続ける上で危険信号です。日々、何かを覚えて成長したなという実感がありますか。無ければ、次のステージに行くきっかけかもしれません。</p><p>「決まったマニュアルを試したらすぐにバックエンド部隊に投げる」「深い調査権限を持たせてもらえない」このあたりに不満がある場合に、現職にて解決策が無いのであれば、是非外にも目を向けてみてください。</p><h2 id="転職-他の技術職-→-サポートエンジニア"><a href="#転職-他の技術職-→-サポートエンジニア" class="headerlink" title="転職: 他の技術職 → サポートエンジニア"></a>転職: 他の技術職 → サポートエンジニア</h2><p>前述のサポートエンジニア → 他社のサポートエンジニアの部分とも多くが共通します。加えるなら、他業種からのサポートエンジニアへの転向は、結局のところ、技術者である前に、「目の前で困っている人がいたら助けたいか」に興味が持てなければなりません。その点を除いては、おそらく IT 関係の技術職でしっかり研鑽を積んできたのであれば活躍できるでしょう。</p><p>さらに、「サポートエンジニアで伸びる能力と価値」の項に記載した領域に興味があれば、それは立派な「次のキャリアステップ」になります。</p><h2 id="キャリアプラン-サポートからさらに先の転職"><a href="#キャリアプラン-サポートからさらに先の転職" class="headerlink" title="キャリアプラン - サポートからさらに先の転職"></a>キャリアプラン - サポートからさらに先の転職</h2><p>サポートエンジニアとして、日々お客様の声を聞き、チームワークと技術力を発揮して解決する。それまでに身を置いてきた現場がチャレンジングであればあるほど、このスキルセットにかけ算で魅力が追加されるでしょう。</p><p>アーキテクトやプリセールス ロールに行って重宝されたという話も聞きます。お客様の目線や問題を抑止したいという目線も持ちうる開発者になる人もいます。</p><p>お客様の環境での Good / Bad Example を沢山目にしますから、SIer としてのさらに高度なロールにいくことも可能でしょう。</p><p>マイクロソフトでも、広範にわたる役職があります。営業職・データセンター運営・開発職・アカウントマネージャー・管理職・他の製品のサポートetc。マイクロソフトは幸い、会社自体が「Customer Obsession」(顧客への執着) というほどのお客様志向をかかげていますから、サポート出身者でこのマインドで負けることはありません。</p><h2 id="補足-マイクロソフトでは面接で何を見るか"><a href="#補足-マイクロソフトでは面接で何を見るか" class="headerlink" title="補足: マイクロソフトでは面接で何を見るか"></a>補足: マイクロソフトでは面接で何を見るか</h2><p>マイクロソフトでは、Growth Mindset (成長する考え方) というものを尊重しています。今できることをやるのではなく、今できないことについてどのようにして出来るようになるのか、そのアプローチ努力して継続し、効果的にプランすることが重要です。</p><p>面接でも、経験やスキルセットも見るには見るのですが、どちらかというと我々が知りたいのは「この人は、知らないことについてどのようにアプローチして、身につけるのだろう？(これまで身につけてきたのだろう？)」ということです。Azure のように、年間何十という機能追加や変更が行われる世界では、今持っているものだけではその人の適性は図れません。(前述のように、お客様はクラウドという製品を買うのではなく、信頼性を買うのだ、というのとちょっと似ていますね)</p><p>また、こう言ってしまうとなんですが、私達、特にエンジニアが面接する場合、彼らは面接という技術のプロではありません。ですので、面接中の質問に対して答えを持っていない場合も、是非、臆さず双方向にコミュニケーションを取ってみてください。</p><p>「何故そのような質問をするのでしょうか」と深掘りをしてみましょう。</p><p>面接官となるエンジニアも、おそらく技術力をみたい、その一心だと思います。質問には直接わからないけど、それに近い何かを深く追求したことに自信があれば、そちらに誘導してみてもよいでしょう。<u>その質問をしているのがお客様だったとしたら？</u>「分からないです、すいません・・・」と暗い雰囲気で終わらせるのではなく、建設的な、未来を向いたアプローチがあるはずです。</p><p>「その技術について直接はわからないけど、○○という情報を参照することで答えられます。」「私の知識の中で、類似するこういうものがあり、それに近い考え方だとすると～」といった会話を極力繋いでみましょう。</p><h2 id="宣伝-マイクロソフトのサポートエンジニア募集中"><a href="#宣伝-マイクロソフトのサポートエンジニア募集中" class="headerlink" title="宣伝: マイクロソフトのサポートエンジニア募集中"></a>宣伝: マイクロソフトのサポートエンジニア募集中</h2><p>現在、マイクロソフトのサポート職を募集しています。この項、あるいは私の LinkedIn では、募集要項や採用イベントがありましたらお伝えしていきます。</p><p>私のチームでは、Azure の Networking 分野で募集しています。IaaS/インフラ/ネットワークあたりのキーワードが刺さる方は是非ご検討下さい。</p><p>Support Escalation Engineer - Azure Networking (複数枠有り！)<br><a href="https://careers.microsoft.com/i/us/en/job/715208/Support-Escalation-Engineer-Azure-Networking" target="_blank" rel="noopener">https://careers.microsoft.com/i/us/en/job/715208/Support-Escalation-Engineer-Azure-Networking</a></p><p>他にも、様々なエリアで募集がありますので、もし興味がありましたら、是非「石井の LinkedIn を見たよ」と記載下さい。直接のご相談も Welcome です。</p><p>私のチームに限らず、マイクロソフトのサポートとして、少しでもチャンスに繋げられるようご協力させていただきます。</p><iframe width="560" height="315" src="https://www.youtube.com/embed/yThRRLBnxJ4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、マイクロソフトの石井 哲平です。&lt;br&gt;2007年に新卒でマイクロソフトのサポートエンジニアとして入社をし、長らくエンジニアを楽しんで来ました。&lt;br&gt;2018 年より、サポートエンジニアのチームでマネージャー職をしています。&lt;/p&gt;
&lt;p&gt;サポートエンジニアと
      
    
    </summary>
    
    
      <category term="Other" scheme="https://jpaztech.github.io/blog/tags/Other/"/>
    
      <category term="Support Explained" scheme="https://jpaztech.github.io/blog/tags/Support-Explained/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft ピアリングを経由するかどうかの確認方法</title>
    <link href="https://jpaztech.github.io/blog/network/judge-via-ms-peering/"/>
    <id>https://jpaztech.github.io/blog/network/judge-via-ms-peering/</id>
    <published>2019-11-26T08:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.941Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの山崎です。<br>今回は対象の通信が Microsoft ピアリングを経由するかどうかの確認方法についてご紹介します。</p><h2 id="Microsoft-ピアリングで広報される経路について"><a href="#Microsoft-ピアリングで広報される経路について" class="headerlink" title="Microsoft ピアリングで広報される経路について"></a>Microsoft ピアリングで広報される経路について</h2><p>ExpressRoute の Microsoft ピアリングをご利用の場合、ルートフィルターの設定でどのような経路を広報するかを設定します。</p><p><strong>(ルートフィルターの設定画面 - Azure ポータル)</strong></p><img src="/blog/network/judge-via-ms-peering/judge-via-ms-peering-01.png"> <p><strong>(実行コマンド)</strong><br>各サービスコミュニティで広報される経路については以下の PowerShell コマンドからご確認いただけます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AzBgpServiceCommunity</span><br></pre></td></tr></table></figure><p><strong>(出力例)</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Name           : Exchange</span><br><span class="line">Id             : /subscriptions//resourceGroups//providers/Microsoft.Network/bgpServiceCommunities/Exchange</span><br><span class="line">Type           : Microsoft.Network/bgpServiceCommunities</span><br><span class="line">BgpCommunities : [</span><br><span class="line">                   &#123;</span><br><span class="line">                     &quot;ServiceSupportedRegion&quot;: &quot;Global&quot;,</span><br><span class="line">                     &quot;CommunityName&quot;: &quot;Exchange&quot;,</span><br><span class="line">                     &quot;CommunityValue&quot;: &quot;12076:5010&quot;,</span><br><span class="line">                     &quot;CommunityPrefixes&quot;: [</span><br><span class="line">                       &quot;13.107.6.152/31&quot;,</span><br><span class="line">                       &quot;13.107.18.10/31&quot;,</span><br><span class="line">                       &quot;13.107.128.0/22&quot;,</span><br><span class="line">                       &quot;23.103.160.0/20&quot;,</span><br><span class="line">                       &quot;40.92.0.0/15&quot;,</span><br><span class="line">                       &quot;40.96.0.0/13&quot;,</span><br><span class="line">                       &quot;40.104.0.0/15&quot;,</span><br><span class="line">                       &quot;40.107.0.0/16&quot;,</span><br><span class="line">                       &quot;52.96.0.0/14&quot;,</span><br><span class="line">                       &quot;52.100.0.0/14&quot;,</span><br><span class="line">                       &quot;52.238.78.88/32&quot;,</span><br><span class="line">                       &quot;104.47.0.0/17&quot;,</span><br><span class="line">                       &quot;131.253.33.215/32&quot;,</span><br><span class="line">                       &quot;132.245.0.0/16&quot;,</span><br><span class="line">                       &quot;150.171.32.0/22&quot;,</span><br><span class="line">                       &quot;191.234.140.0/22&quot;,</span><br><span class="line">                       &quot;204.79.197.215/32&quot;,</span><br><span class="line">                       &quot;13.107.128.0/24&quot;,</span><br><span class="line">                       &quot;13.107.129.0/24&quot;,</span><br><span class="line">                       &quot;150.171.32.0/24&quot;,</span><br><span class="line">                       &quot;150.171.34.0/24&quot;,</span><br><span class="line">                       &quot;150.171.35.0/24&quot;,</span><br><span class="line">                       &quot;52.96.38.0/24&quot;</span><br><span class="line">                     ],</span><br><span class="line">                     &quot;IsAuthorizedToUse&quot;: false,</span><br><span class="line">                     &quot;ServiceGroup&quot;: &quot;O365&quot;</span><br><span class="line">                   &#125;</span><br><span class="line">                 ]</span><br><span class="line"></span><br><span class="line">Name           : OtherOffice365Services</span><br><span class="line">Id             : /subscriptions//resourceGroups//providers/Microsoft.Network/bgpServiceCommunities/OtherOffice365Servic</span><br><span class="line">                 es</span><br><span class="line">Type           : Microsoft.Network/bgpServiceCommunities</span><br><span class="line">BgpCommunities : [</span><br><span class="line">                   &#123;</span><br><span class="line">                     &quot;ServiceSupportedRegion&quot;: &quot;Global&quot;,</span><br><span class="line">                     &quot;CommunityName&quot;: &quot;Other Office 365 Services&quot;,</span><br><span class="line">                     &quot;CommunityValue&quot;: &quot;12076:5100&quot;,</span><br><span class="line">                     &quot;CommunityPrefixes&quot;: [</span><br><span class="line">                       &quot;13.80.125.22/32&quot;,</span><br><span class="line">                       &quot;13.91.91.243/32&quot;,</span><br><span class="line">                       &quot;13.106.4.128/25&quot;,</span><br><span class="line">                       (... 省略)</span><br></pre></td></tr></table></figure><h2 id="宛先が-FQDN-の場合"><a href="#宛先が-FQDN-の場合" class="headerlink" title="宛先が FQDN の場合"></a>宛先が FQDN の場合</h2><p>通信対象が IP の場合、上記の手順で IP をご確認いただくことで対象のサービスコミュニティが確認可能で、ルートフィルターの設定状況により Microsoft ピアリングを経由するかどうかを確認することが可能です。また、各サービス毎に以下のようなドキュメントでも ExpressRoute の対応状況について記載がされています。</p><p>  [Office 365 の URL と IP アドレスの範囲]<br>  <a href="https://docs.microsoft.com/ja-jp/office365/enterprise/urls-and-ip-address-ranges" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/office365/enterprise/urls-and-ip-address-ranges</a></p><p>  [Azure ExpressRoute と Azure Site Recovery]<br>  <a href="https://docs.microsoft.com/ja-jp/azure/site-recovery/concepts-expressroute-with-site-recovery" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/site-recovery/concepts-expressroute-with-site-recovery</a></p><p>ドキュメントに記載がなく、対象が FQDN の場合には個別に調査が必要となります。Microsoft ピアリング観点としては IP を特定いただくことで経由、非経由が判断出来ますため、調査としては対象の FQDN に紐づく IP 情報についてご確認いただく必要がございます。</p><blockquote><p>対象の FQDN に紐づく IP アドレスの調査については FQDN が利用されるサービス毎に調査が必要となりますので、ご利用サービス宛てにお問い合わせをお願いします。</p></blockquote><p>対象の FQDN によっては IP が固定でわかる場合もあれば、情報公開されておらず不定の場合もあります。IP が明確に特定できないような場合には Internet 経由で通信できるようネットワークを構成いただければ幸いです。</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの山崎です。&lt;br&gt;今回は対象の通信が Microsoft ピアリングを経由するかどうかの確認方法についてご紹介します。&lt;/p&gt;
&lt;h2 id=&quot;Microsoft-ピアリングで広報される経路について&quot;&gt;&lt;a href=&quot;#Micros
      
    
    </summary>
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
  </entry>
  
  <entry>
    <title>Azure IaaS における有償 Azure テクニカル サポートの対応範囲</title>
    <link href="https://jpaztech.github.io/blog/other/azure_technical_support_explained/"/>
    <id>https://jpaztech.github.io/blog/other/azure_technical_support_explained/</id>
    <published>2019-11-20T08:30:00.000Z</published>
    <updated>2020-06-19T12:16:02.949Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームです。</p><p>Azure の IaaS 仮想マシンをご利用のお客様における、Azure の有償テクニカル サポート範囲と留意点について以下の通りご説明します。<br>本ドキュメントでは、課金・サブスクリプション サポートについては言及しません。<br>有償である Professional Developer, Professional Standard, Professional Direct, Premier サポートについてのみのご説明となります。</p><h2 id="Azure-サポートで提供しているサポート-プランと対応範囲"><a href="#Azure-サポートで提供しているサポート-プランと対応範囲" class="headerlink" title="Azure サポートで提供しているサポート プランと対応範囲"></a>Azure サポートで提供しているサポート プランと対応範囲</h2><p>Azure サポートにどのようなプランがあるのかや、その比較は以下をご参照ください。</p><p>ご参考: <a href="https://azure.microsoft.com/ja-jp/support/plans/" target="_blank" rel="noopener">Azure のサポート プランの比較</a></p><h2 id="障害対応-Break-fix-とアドバイザリの違いについて"><a href="#障害対応-Break-fix-とアドバイザリの違いについて" class="headerlink" title="障害対応 (Break/fix) とアドバイザリの違いについて"></a>障害対応 (Break/fix) とアドバイザリの違いについて</h2><p>Azure の有償テクニカル サポート、つまり Developer / Standard / Professional Direct / Premier のすべてにおいて、障害対応 (Break/fix) のサポートが提供されています。障害対応の定義は以下に記載がされています。</p><p>ご参考: <a href="https://azure.microsoft.com/ja-jp/support/faq/" target="_blank" rel="noopener">Azure サポートに関する FAQ</a></p><blockquote><p>障害対応の問題とは、Azure サービスの使用中に経験する技術的な問題です。”障害対応” という業界用語は、”あるテクノロジが正常に機能しなくなり、正常運転状態に復帰するためにサポート組織の介入が必要になった場合の、そのテクノロジをサポートする作業” を指します。</p></blockquote><p>「障害対応」に対して、アドバイザリとは、「障害対応以外」のご相談ごと、つまり手順確認 (ハウツー) やベスト プラクティスの提供といった範囲でのご質問内容となります。</p><p>このアドバイザリ サービスは Professional Direct 契約もしくは Premier サポート契約のみで利用可能となります。Premier サポートでは、マイクロソフトから提供されている、有償サポート対応の製品がすべてサポート対応範囲となりますが、Azure の Professional Direct サポートでは Azure 側の内容のみのサポートが提供されます。</p><p>つまり、Azure ではないマイクロソフト製品、例えば Windows や SQL Server 製品などの設定方法、構築手順、仕様確認といった内容については Premier サポート契約が必要です。<br>一方、Professional Direct では、Azure 基盤側の設定方法などについては、公開情報をベースに調査し、回答させていただくことが可能です。</p><p>Professional Direct と Premier においては、アドバイザリの提供範囲も異なります。Azure サポートに関する FAQから抜粋しますと、以下の通りです。</p><blockquote><p>Q. Premier Advisory サポートと比較して、Professional Direct Limited Advisory サポートではどのようなサポートを提供していますか？</p></blockquote><blockquote><p>A. Professional Direct (ProDirect) Advisory サポートは、(1) Microsoft Azure に関して一般に公開されているベスト プラクティスのドキュメント、および (2) Azure フォーラムからの情報に基づいて、Azure サポート ガイダンスへのアクセスを提供するものです。 ProDirect のアドバイザーは、マイクロソフト関連のドキュメント、Microsoft Azure サポート エンジニア、および Microsoft Azure 製品グループへの各自のアクセスに基づいて、サポートを提供します。 ベスト プラクティス ガイダンスには、例として、以下のものがあります。</p></blockquote><h2 id="お問い合わせの重要度・緊急対応について"><a href="#お問い合わせの重要度・緊急対応について" class="headerlink" title="お問い合わせの重要度・緊急対応について"></a>お問い合わせの重要度・緊急対応について</h2><p>Azure のサポートには、重要度が A ~ C に分類されております。</p><p>通常重要度 (重要度 B、もしくは C) は、日本時間の営業時間 (土日祝日を除く、9:00 ～ 17:30) でのみ対応しています。<br>Professinal Standard、Professinal Direct、Premier サポートにおいて 24 時間 365 日の緊急対応 (重要度 A) が提供されています。</p><p>緊急対応は、運用環境における「障害対応」つまり、正常な状態で稼働していたサービスが正常に機能しなくなった場合の復旧・問題の回避を目的として行われます。<br>原因追求や、ハウツー (※) については重要度 B、もしくは C として、通常営業時間内での対応となります。<br>※ 原因追求やハウツーは障害対応ではないため、重要度を落としたとしても、ご契約や内容によってお受けできない場合がございます。</p><p>Professinal Developer サポートは、開発環境を想定しているため、24 時間 365 日の対応は行えず、重要度 A でも通常時間内での優先対応となります。</p><h2 id="留意点-お問い合わせ番号-1-つにつき-1-つのソリューション提供となります"><a href="#留意点-お問い合わせ番号-1-つにつき-1-つのソリューション提供となります" class="headerlink" title="留意点: お問い合わせ番号 1 つにつき 1 つのソリューション提供となります"></a>留意点: お問い合わせ番号 1 つにつき 1 つのソリューション提供となります</h2><p>Azure には、多岐に渡るテクノロジーが存在します。<br>案件に応じて、データセンターへのエスカレーションや、適切な専任部門にエンジニアが交代となる可能性がございますため、サポートの際に発行させていただくお問い合わせ番号 1 つにつき 1  つの問題・ 1 つのソリューション提供とさせていただいております。</p><p>お問い合わせ内容が多岐にわたる場合、1 つのソリューションごとに新しいお問い合わせ番号の発行をお願いする場合がございます。</p><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h2><p>以下に、具体例を挙げて対応範囲の Q&amp;A を記載させていただきます。</p><p><strong>Q. オンプレミスの PC やサーバーにおいて不調が発生した場合、Azure サポートで対応が行えるか</strong></p><p>オンプレミス、つまり自社や自宅の環境のサポート対応は Azure サポートでは対応範囲外となります。Premier サポートであれば、マイクロソフトの製品に限って対応が可能です。</p><p><strong>Q. Azure 上の Windows において、問題が発生しているため障害対応を行ってほしい</strong></p><p>前述の 「障害対応」 に該当するお問い合わせ内容であり、Azure 上の Windows で発生している場合には、Azure サポートで対応が行える範囲となります。Windows 専任部隊と連携し、障害状態からの復旧のため対応を行います。<br>障害対応以外のお問い合わせ内容については、チケット制のプロフェッショナル サポート インシデントをご購入いただくか、アドバイザリの対応範疇となる場合には Premier サポートが必要です。</p><ul><li><a href="https://www.microsoft.com/ja-jp/services/professional.aspx" target="_blank" rel="noopener">プロフェッショナル サポート</a><br>(※ Azure ではなく、Windows 、Office、SQL Server などマイクロソフト製品をインシデントというチケット制で問い合わせる形態となります)</li><li><a href="https://www.microsoft.com/ja-jp/services/premier.aspx" target="_blank" rel="noopener">プレミア サポート</a></li></ul><p><strong>Q. Azure 上における特定製品のライセンスについての問い合わせをしたい</strong></p><p>マイクロソフト製品のライセンス (Windows Server や SQL Server 等) については、ライセンス リセラーとなるパートナー各社にお問い合わせください。</p><p>パートナー ネットワークに加入されている弊社パートナー様の場合、弊社パートナー コールセンターにご相談ください。</p><ul><li><a href="https://partner.microsoft.com/ja-jp/support/call-center" target="_blank" rel="noopener">パートナー コールセンター</a></li></ul><p><strong>Q. IaaS 仮想マシンの利用にて、パフォーマンスが出ない</strong><br>構築後、正常にパフォーマンスが出ていた状態から、一時的に極端に悪化している場合には障害対応の範囲となり、Azure サポートでの対応が可能です。</p><p>障害対応の範囲外となるパフォーマンス チューニングは Premier サポートにおいてのみ承れます。<br>Professional Direct サポート契約においては、アドバイザリ サポートにてパフォーマンス上のベストプラクティスを公開情報の範囲からご案内可能です。</p><p><strong>Q. Azure 上の Windows Server 仮想マシンにおける OS 内の設定について、ベストプラクティス・特定機能の設定方法・仕様確認などを行いたい</strong></p><p>Azure サポートの対応範囲外となりますが、Premier サポートであれば対応可能です。<br>(Professional Direct 契約では、Windows OS 内部の動作は障害対応を除いてサポート対象外です。)</p><p><strong>Q. Azure 上の Windows Server 仮想マシンにおけるサードパーティ製品について問い合わせが可能か</strong></p><p>サードパーティ製品のサポートは行っておりませんので、開発元にお問い合わせをいただきますようお願いいたします。</p><p><strong>Q. Office 365 製品の問合せが可能か</strong></p><p>Office 365 の製品についてのサポートは Azure サポート契約ではお受けできないため、Office 365 サポートをご利用いただく必要がございます。<br>しかしながら、Azure 上に導入いただいた Office 365 製品において、Azure プラットフォーム側の問題が発生している可能性がある場合など、Azure プラットフォームとしての見解が必要な内容については Azure サポートにご相談ください。</p><p><strong>Q. Azure 仮想マシンの予期しない再起動が発生したため Azure 基盤側が要因であるか教えてほしい</strong></p><p>Azure テクニカル サポートに対して、予期しない再起動が Azure 起因であるか否かの判断、ならびにその理由についての公式見解をリクエストすることが可能です。</p><p>なお、Azure 仮想マシンでは、基盤側のハードウェア・ソフトウェア要因による不調の際、仮想マシンが予期せず再起動される可能性があります。この際に、仮想マシンは「サービス ヒーリング」と呼ばれる、正常な物理マシンへの移動が自動的に行われ、稼働を再開されます。</p><p>「障害対応」の定義に従いますと、仮想マシンが予期せず再起動したとしても、仮想マシンがサービス ヒーリングして起動した時点で既に復旧済みという理解となります。仮想マシン単体のダウンがお客様のサービス自体のダウンに繋がらないよう、可用性を構成していただく必要がございます。</p><p>ご参考: <a href="https://blogs.msdn.microsoft.com/ainaba-csa/2017/05/31/availability-of-azure-virtual-machines/" target="_blank" rel="noopener">Azure 仮想マシンにおける可用性の考え方</a></p><p><strong>Q. Azure 上の OSS（オープン ソース ソフトウェア) において、障害対応を行ってほしい</strong></p><p>マイクロソフトでは、以下技術情報に沿ったオープン ソース テクノロジーのサポートを行っております。</p><p>また、障害対応・アドバイザリ といった対応範囲は Azure テクニカル サポートと差異はありません。<br>特に、仕様確認など、開発元でなければ回答ができない内容の場合にはディストリビューターとお客様において個別にサポート契約を締結し、ご相談をいただく必要がありますので、下記ドキュメントをご一読ください。</p><ul><li><a href="https://support.microsoft.com/en-us/help/2941892/support-for-linux-and-open-source-technology-in-azure" target="_blank" rel="noopener">Support for Linux and open source technology in Azure</a> (英語原文)</li><li><a href="https://support.microsoft.com/ja-jp/help/2941892/support-for-linux-and-open-source-technology-in-azure" target="_blank" rel="noopener">Linux と Azure のオープン ソース ・ テクノロジーのサポート</a> (日本語機械翻訳版)</li></ul><p><strong>Q. Azure 上の Linux や OSS に関してのベストプラクティス・特定機能の設定方法・仕様確認などを行いたい</strong></p><p>Azure の Linux や OSS については、前述の技術情報 “Linux と Azure のオープン ソース ・ テクノロジーのサポート” に記載の範囲で行います。Professional Direct ないしは Premier サポートの契約が必要です。</p><p><strong>Q. Azure の特定の技術・挙動について仕様確認をしたい</strong></p><p>仕様の確認に関する調査については、Professional Direct、もしくは Premier サポートでのアドバイザリ サービスに含まれます。Professional Direct の場合、公開されている技術情報からのご案内のみとなります。</p><p><strong>Q. Azure Marketplace におけるサードパーティ製品の質疑応答・トラブルシューティングの依頼は可能か</strong></p><p>Azure 基盤側の問題、例えば「サードパーティ製として提供されている仮想マシンが、Azure 基盤側の要因で接続が出来なくなった」といったケースであれば Azure テクニカル サポートにて対応が可能です。<br>それ以外の、価格、ライセンス、製品固有のご質問・トラブルシュートは提供元にご質問をいただく必要があります。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームです。&lt;/p&gt;
&lt;p&gt;Azure の IaaS 仮想マシンをご利用のお客様における、Azure の有償テクニカル サポート範囲と留意点について以下の通りご説明します。&lt;br&gt;本ドキュメントでは、課金・サブスクリプション サポートについて
      
    
    </summary>
    
    
      <category term="Other" scheme="https://jpaztech.github.io/blog/tags/Other/"/>
    
      <category term="Support Explained" scheme="https://jpaztech.github.io/blog/tags/Support-Explained/"/>
    
  </entry>
  
  <entry>
    <title>Japan Azure IaaS Support Blog リニューアルのお知らせ</title>
    <link href="https://jpaztech.github.io/blog/information/test/"/>
    <id>https://jpaztech.github.io/blog/information/test/</id>
    <published>2019-09-13T09:29:20.000Z</published>
    <updated>2020-06-19T12:16:02.937Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure IaaS Support チームです。</p><p><font color="gray">本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</font></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure IaaS Support チームです。&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gray&quot;&gt;本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。&lt;/font&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway (WAF) での脆弱性検知について</title>
    <link href="https://jpaztech.github.io/blog/archive/application-gateway-waf-vulnerability-detection/"/>
    <id>https://jpaztech.github.io/blog/archive/application-gateway-waf-vulnerability-detection/</id>
    <published>2018-10-18T00:27:51.000Z</published>
    <updated>2020-06-19T12:16:02.913Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの山崎です。<br>今回は Application Gateway で Web アプリケーション ファイアウォール（WAF） 機能をご利用の際によくお問い合わせをいただく “949110” ルールについてご紹介します。</p><h2 id="■-WAF-機能で検知した情報をログから確認したい"><a href="#■-WAF-機能で検知した情報をログから確認したい" class="headerlink" title="■ WAF 機能で検知した情報をログから確認したい"></a>■ WAF 機能で検知した情報をログから確認したい</h2><p>一般的な WAF の導入シナリオとして、WAF 機能をいきなり本番環境に導入してしまうとフォールスポジティブや (誤検知) フォールスネガティブ (見逃し) に合致してしまう可能性があります。<br>そのため、まずは本番導入前に通信の破棄は行わず、検知のみを行ってログ情報からフォールスポジティブ、フォールスネガティブが発生していないか確認したいというご要望を多くいただきます。<br>Application Gateway の WAF 機能でも検知モード、ログ出力に対応しており、以下を設定することで導入前のテストを実施いただけます。</p><h3 id="検知モード-防止モード"><a href="#検知モード-防止モード" class="headerlink" title="検知モード / 防止モード"></a>検知モード / 防止モード</h3><p>検知モードでは脆弱性の診断は実施されますが、対象の通信が異常と判定された場合でも通信をブロックせず、後述の Firewall ログにログを保存します。<br>防止モードでは異常と判定された通信をログに保存しつつ、通信もブロックします。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [Web アプリケーション ファイアウォール] から設定します。</p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_mode.png"><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_403_error.png"><h3 id="Firewall-ログ"><a href="#Firewall-ログ" class="headerlink" title="Firewall ログ"></a>Firewall ログ</h3><p>脆弱性を検知したログを保存するためには、診断ログの “ApplicationGatewayFirewallLog” を設定します。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [診断ログ] から設定します。</p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_firewalllog.png"><h2 id="■-Firewall-ログについて"><a href="#■-Firewall-ログについて" class="headerlink" title="■ Firewall ログについて"></a>■ Firewall ログについて</h2><p>以下は OWASP 3.0 を利用し SQL Injection Attack を検知した際の Firewall ログです。脆弱性が検知された通信毎にログが記録されます。1つの通信に対して複数の脆弱性を検知した場合には、複数の情報が出力されます。<br>複数検知されたかどうかについては “time”, “requestUri”, “clientIp” の項目が同じかどうかで判断することが可能です。</p><pre>{  "records": [    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T10:01:31.3790913Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "//?=!@rx%20%5E0$",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "942130",        "message": "SQL Injection Attack: SQL Tautology Detected.",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Warning. Pattern match \"(?i:([\\\\s'\\\"`\\\\(\\\\)]*?)([\\\\d\\\\w]++)([\\\\s'\\\"`\\\\(\\\\)]*?)(?:(?:=|<=>|r?like|sounds\\\\s+like|regexp)([\\\\s'\\\"`\\\\(\\\\)]*?)\\\\2|(?:!=|<=|>=|<>|<|>|\\\\^|is\\\\s+not|not\\\\s+like|not\\\\s+regexp)([\\\\s'\\\"`\\\\(\\\\)]*?)(?!\\\\2)([\\\\d\\\\w]+)))\" at ARGS:.",          "data": "Matched Data: rx ^0 found within ARGS:: !@rx ^0$",          "file": "rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf",          "line": "554"        },        "hostname": "1fe5ea76-fd34-480c-9b8d-a0b0d35cd19e.cloudapp.net"      }    },    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T10:01:31.3790913Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "//?=!@rx%20%5E0$",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "949110",        "message": "Mandatory rule. Cannot be disabled. Inbound Anomaly Score Exceeded (Total Score: 5)",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score.",          "data": "",          "file": "rules/REQUEST-949-BLOCKING-EVALUATION.conf",          "line": "57"        },        "hostname": "1fe5ea76-fd34-480c-9b8d-a0b0d35cd19e.cloudapp.net"      }    }  ]}</|></=|></=></pre><h2 id="■-“949110”-ルールの検知"><a href="#■-“949110”-ルールの検知" class="headerlink" title="■ “949110” ルールの検知"></a>■ “949110” ルールの検知</h2><p>OWASP 3.0 ではスコア判定方式で対象の通信を判定しており、スコアを超えた（= 異常通信と判定した）場合に “949110” が判定されます。上記 Firewall ログの例では SQL Injection Attack を検知した “942130” と、スコア判定によりスコアを超えたことを示す “949110” の2つが検知されています。</p><p>ここで、例えば今回脆弱性として検知された通信について、実はフォールスポジティブで誤検知されてしまったため、検知を無効化して通信を許可したい場合、以下設定による個別の検知ルールの無効化が可能です。</p><h3 id="個別ルールの設定-無効化、有効化"><a href="#個別ルールの設定-無効化、有効化" class="headerlink" title="個別ルールの設定 (無効化、有効化)"></a>個別ルールの設定 (無効化、有効化)</h3><p>Firewall ログから検知した “ruleId” を確認し、同じ番号のルールを探して検知の無効化、有効化を設定することができます。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [Web アプリケーション ファイアウォール] から設定します。</p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_rulesetes.png"><p>よくあるお問い合わせとして、同様に “949110” を無効化しようと設定を確認したところ、”949110” の設定項目がないというお問い合わせをいただきます。</p><p>ご確認いただいた通り、”949110” については WAF 設定で有効/無効を切り替えることは出来ませんが、今回の例の場合、SQL Injection Attack を検知した “942130” を無効化いただければ、”949110” も検知されなくなります。前述の通り、OWSAP 3.0 ではスコア判定方針でスコアを超えた場合に “949110” が検知されますが、”942130” を無効化いただくことでスコア判定のスコアに加算されないため “949110” でも検知されなくなるためです。</p><p>そのため、”949110” については個別に無効化する必要はなく、”949110” とともに検知されたルールをご確認いただき、無効化いただくことで制御することが可能です。</p><blockquote><p>[参考] OWASP 2.2.9 ではスコア判定方式ではないため “949110” が Firewall ログに出力されることはありません。</p></blockquote><h2 id="■-Firewall-ログで検知しているのに通信がブロックされない"><a href="#■-Firewall-ログで検知しているのに通信がブロックされない" class="headerlink" title="■ Firewall ログで検知しているのに通信がブロックされない"></a>■ Firewall ログで検知しているのに通信がブロックされない</h2><p>OWASP 3.0 で防止モードご利用の際、Firewall ログで脆弱性を検知しているにも関わらず通信がブロックされない場合があります。<br>（ログ例）</p><pre>    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T11:39:47.2243486Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "/vendor/bootstrap/css/bootstrap.min.css.map",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "920350",        "message": "Host header is a numeric IP address",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Warning. Pattern match \"^[\\\\d.:]+$\" at REQUEST_HEADERS:Host.",          "data": "40.114.66.69",          "file": "rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf",          "line": "791"        },        "hostname": "40.114.66.69"      }    }</pre><p>通信が異常と判定された場合には “949110” が検知されますので、上記のログのような “920350” で検知し、スコア加算されたとしても、異常と判定されるスコアを超えない場合には通信はブロックされず、許可される場合があります。<br>そのため、通信がブロックされたかどうかを確認する場合には “949110” が同時に検知されているかどうかを Firewall ログからご確認ください。</p><blockquote><p>スコア判定の基準については OWASP で管理されており、OWASP CRS の各ルールや、その判定条件についてはサポートチームとしては回答が出来かねますため、GitHub のリポジトリをご参照いただくか、OWASP コミュニティのメーリングリスト等へご相談いただけますと幸いです。</p><p>[参考] <a href="https://jpaztech.github.io/blog/archive/applicationgaetway-waf-01/">Application Gateway で利用できる WAF について </a></p></blockquote><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの山崎です。&lt;br&gt;今回は Application Gateway で Web アプリケーション ファイアウォール（WAF） 機能をご利用の際によくお問い合わせをいただく “949110” ルールについてご紹介します。&lt;/p&gt;
&lt;h2 
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
      <category term="WAF" scheme="https://jpaztech.github.io/blog/tags/WAF/"/>
    
  </entry>
  
  <entry>
    <title>(PowerShell編) Azure仮想マシン (管理ディスク) の交換を活用して元のネットワークにリストアする</title>
    <link href="https://jpaztech.github.io/blog/archive/restore-vm-by-swap-manageddisk/"/>
    <id>https://jpaztech.github.io/blog/archive/restore-vm-by-swap-manageddisk/</id>
    <published>2018-06-04T06:31:32.000Z</published>
    <updated>2020-06-19T12:16:02.937Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートチームの三國です。<br>今回は 2018 年 4 月にリリースされた、管理ディスクの交換 (スワップ) 機能を用いて仮想マシンを元のネットワークにリストアする方法をご案内します。</p><p>本ブログは Azure PowerShell 編です。ポータルでの手順は以下の投稿をご参照下さい。<br><a href="http://blogs.technet.microsoft.com/jpaztech/2018/05/30/restore-vm-by-swap-manageddisk/" target="_blank" rel="noopener">(旧) Azure 仮想マシン (管理ディスク) の交換を活用して元のネットワークにリストアする</a></p><p><span style="color:red;">本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</span></p><h2 id="■-注意事項"><a href="#■-注意事項" class="headerlink" title="■ 注意事項"></a>■ 注意事項</h2><ul><li>Azure PowerShell のバージョンは 6.1.0 にて検証を行っておりますが、バージョンによってパラメータが異なる可能性や実行頂けない可能性があります。</li><li>ストレージアカウントに vhd が作成され、管理ディスクが新規で作成されます。</li><li>リストアする仮想マシンの情報を記載した json ファイルが PowerShell 実行元のローカルにダウンロードされます。</li><li>バックアップは別途取得頂く必要がございます。</li><li>仮想マシンの停止が発生します。</li><li>仮想マシンのリストアが行われますので、実行には長時間を要します。</li><li><span style="color:red;">サンプルのスクリプトである為、責任は一切負いかねます。十分に検証いただいた上でご利用をお願いいたします。</span></li></ul><h2 id="■-はじめに"><a href="#■-はじめに" class="headerlink" title="■ はじめに"></a>■ はじめに</h2><p>Azure Backup での仮想マシンの復元には2つの選択肢があります。</p><ul><li>特定の時点のバックアップ VM である VM を新しく作成する。</li><li>ディスクを復元し、そのプロセスに含まれるテンプレートを使用して、復元された VM をカスタマイズするか、個別にファイルを回復する。</li></ul><p><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms" target="_blank" rel="noopener">(参考) Azure Portal を使用して仮想マシンを復元する</a></p><p>しかし、可能であれば復元前の仮想マシンと同じネットワークにリストアしたいというニーズも強くあるかと存じます。<br>そこで、以下のような手順で実現する方法をご案内いたします。</p><ol><li>仮想マシンのディスクを VHD に復元する</li><li>VHD を管理ディスク化する</li><li>復元後のディスクを復元前のディスクと交換する (仮想マシンの停止が伴います)</li></ol><p>これは、2018年4月より管理ディスクでも可能になった機能を用いております。<br><a href="https://blogs.technet.microsoft.com/jpitpro/2018/05/11/os-disk-swap-managed-disks/" target="_blank" rel="noopener">(参考) Managed Virtual Machines で OS ディスク スワップの一般提供を開始</a></p><p>それでは、サンプルスクリプトおよび使用法をご案内します。</p><h2 id="■-サンプルスクリプトの使用法"><a href="#■-サンプルスクリプトの使用法" class="headerlink" title="■ サンプルスクリプトの使用法"></a>■ サンプルスクリプトの使用法</h2><p>‘変数の指定’ における各変数をカスタマイズしてご利用ください。<br>過去 7 日間に取得した Backup のうち最新のものをリストアする動作となります。</p><p>リストア先のストレージアカウントにおいて、自動で決められたコンテナ名、vhd 名で vhd がリストアされますが、作成される管理ディスク名は指定する必要があります。スクリプトでは接頭辞を付ける動作としております。<br>(例: ‘testdisk’ というディスク名なら ‘res-testdisk’ となります)</p><p>その他ご不明点等ございましたらコメント欄に記載ください。</p><h2 id="■-サンプルスクリプト"><a href="#■-サンプルスクリプト" class="headerlink" title="■ サンプルスクリプト"></a>■ サンプルスクリプト</h2><pre>########################################################## 変数の指定########################################################$subscriptionId = 'xxxxx-xxxxx-xxxxx-xxxxx-xxxxx'# 仮想マシンのリソース グループ名$vmResourceGroupName = 'sample-RG'# 仮想マシン名$vmName = 'sample-VM'# Backup の vault 名$vaultName = 'sample-vault'# ストレージ アカウントのリソース グループ名$storageAccountResourceGroupName = 'sample-RG'# ストレージ アカウント名$storageAccountName = 'samplestorage'# リストア用の管理ディスクの接頭辞$prefix = 'res-'########################################################## ログイン、サブスクリプションの選択########################################################Login-AzureRmAccountSelect-AzureRmSubscription -SubscriptionId $subscriptionId########################################################## リストア・管理ディスク作成の準備######################################################### 過去7日間に取得したBackUpのうち最新のものをディスクにリストアGet-AzureRmRecoveryServicesVault -Name $vaultName | Set-AzureRmRecoveryServicesVaultContext$namedContainer = Get-AzureRmRecoveryServicesBackupContainer  `  -ContainerType "AzureVM"  `  -Status "Registered"  `  -FriendlyName $vmName$backupitem = Get-AzureRmRecoveryServicesBackupItem  ` -Container $namedContainer  ` -WorkloadType "AzureVM"$startDate = (Get-Date).AddDays(-7)$endDate = Get-Date$rp = Get-AzureRmRecoveryServicesBackupRecoveryPoint  `  -Item $backupitem  `  -StartDate $startdate.ToUniversalTime()  `  -EndDate $enddate.ToUniversalTime()$restorejob = Restore-AzureRmRecoveryServicesBackupItem  `  -RecoveryPoint $rp[0]  `  -StorageAccountName $storageAccountName  `  -StorageAccountResourceGroupName $storageAccountResourceGroupNameWait-AzureRmRecoveryServicesBackupJob -Job $restorejob -Timeout 43200# Config JsonのURI取得$job = Get-AzureRmRecoveryServicesBackupJobDetails -JobId $restorejob.JobId$jsonContainer = $job.Properties["Config Blob Container Name"]$jsonBlob = $job.Properties["Config Blob Name"]# Config Jsonのダウンロード$ctx = (Get-AzureRmStorageAccount  `  -ResourceGroupName $storageAccountResourceGroupName  `  -Name $storageAccountName).ContextGet-AzureStorageBlobContent -Blob $jsonBlob -Container $jsonContainer -Destination .\  -Context $ctx # Jsonのオブジェクト化$jsonObj = (Get-Content .\$jsonBlob -Encoding Unicode -Raw).TrimEnd([char]0x00) |ConvertFrom-Json# VMオブジェクトの取得 $vmObj = Get-AzureRmVM -ResourceGroupName $vmResourceGroupName -Name $vmName########################################################## OSディスクの作成######################################################### OSディスクの作業用オブジェクトの作成$osDiskObj = $jsonObj.'properties.storageProfile'.osDisk# 現在のOSディスク情報の取得$currentOSdisk = Get-AzureRmDisk  `  -ResourceGroupName $vmResourceGroupName  `  -DiskName $vmObj.StorageProfile.OsDisk.Name# 管理ディスクの作成(OSディスク)$newOsDiskName = $prefix + $currentOSdisk.Name$osDiskConfig = New-AzureRmDiskConfig  `  -Location $vmObj.Location  `  -AccountType $currentOSdisk.Sku.Name  `  -CreateOption Import  `  -OsType $vmObj.StorageProfile.OsDisk.OsType  `  -SourceUri $osDiskObj.vhd.uri$newOSdisk = New-AzureRmDisk  `  -ResourceGroupName $vmResourceGroupName  `  -DiskName $newOsDiskName  `  -Disk $osDiskConfig########################################################## データディスクの作成######################################################### データディスクの作業用オブジェクトの作成$dataDiskObj = $jsonObj.'properties.storageProfile'.dataDisks$currentDataDiskObj = $vmObj.StorageProfile.DataDisks$newDataDiskArray = @()if ($dataDiskObj){    $dataDiskObj | foreach{        $lunNum = $_.Lun        # 現在のデータディスク情報の取得        $currentDataDiskName = ($currentDataDiskObj | Where-Object {$_.Lun -eq $lunNum}).Name        $currentDataDisk = Get-AzureRmDisk -ResourceGroupName $vmResourceGroupName -DiskName $currentDataDiskName        # 管理ディスクの作成(データディスク)        $newDataDiskName = $prefix + $currentDatadiskName        $dataDiskConfig = New-AzureRmDiskConfig -Location $vmObj.Location -AccountType $currentDatadisk.Sku.Name -CreateOption Import -SourceUri $_.vhd.uri        $newDataDisk = New-AzureRmDisk -ResourceGroupName $vmResourceGroupName -DiskName $newDataDiskName -Disk $dataDiskConfig        $newDataDiskArray = $newDataDiskArray + $newDataDisk    }}########################################################## 仮想マシンの停止######################################################### 仮想マシンを停止するStop-AzureRmVM -ResourceGroupName $vmResourceGroupName -Name $vmName -Force########################################################## OSディスクの差し替え######################################################### 最新状態のVMオブジェクトの取得 $vmObj = Get-AzureRmVM -ResourceGroupName $vmResourceGroupName -Name $vmName# OSディスクの差し替え  Set-AzureRmVMOSDisk -VM $vmObj -ManagedDiskId $newOSdisk.Id -Name $newOSdisk.Name# 仮想マシン情報の更新をするUpdate-AzureRmVM -ResourceGroupName $vmResourceGroupName -VM $vmObj ########################################################## データディスクの差し替え########################################################if ($dataDiskObj){    $dataDiskObj | foreach{        $lunNum = $_.Lun        # デタッチするデータディスク情報の取得        $currentDataDiskName = ($currentDataDiskObj | Where-Object {$_.Lun -eq $lunNum}).Name        # アタッチするデータディスクオブジェクトの取得        $sourceVhd = $_.vhd.uri        $newDataDiskObj = $newDataDiskArray | Where-Object {$_.CreationData.SourceUri -eq $sourceVhd}        # 既存のデータディスクのデタッチ        Remove-AzureRmVMDataDisk -VM $vmObj -DataDiskNames $currentDataDiskName        # 仮想マシン情報の更新をする        Update-AzureRmVM -ResourceGroupName $vmResourceGroupName -VM $vmObj        # 新規のデータディスクのアタッチ        Add-AzureRmVMDataDisk -VM $vmObj -CreateOption Attach -Lun $_.lun -ManagedDiskId $newDataDiskObj.Id        # 仮想マシン情報の更新をする        Update-AzureRmVM -ResourceGroupName $vmResourceGroupName -VM $vmObj    }}########################################################## 仮想マシンの起動######################################################### 仮想マシンを起動するStart-AzureRmVM -Name $vmName -ResourceGroupName $vmResourceGroupName</pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。Azure サポートチームの三國です。&lt;br&gt;今回は 2018 年 4 月にリリースされた、管理ディスクの交換 (スワップ) 機能を用いて仮想マシンを元のネットワークにリストアする方法をご案内します。&lt;/p&gt;
&lt;p&gt;本ブログは Azure PowerShell 
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="PowerShell" scheme="https://jpaztech.github.io/blog/tags/PowerShell/"/>
    
      <category term="Managed Disk" scheme="https://jpaztech.github.io/blog/tags/Managed-Disk/"/>
    
      <category term="Backup / Restore" scheme="https://jpaztech.github.io/blog/tags/Backup-Restore/"/>
    
  </entry>
  
  <entry>
    <title>5 月のセキュリティ更新を適用後、Windows 仮想マシンに RDP 接続時にエラーが発生する事象の回避策</title>
    <link href="https://jpaztech.github.io/blog/archive/mayupdate_unable-to-rdp/"/>
    <id>https://jpaztech.github.io/blog/archive/mayupdate_unable-to-rdp/</id>
    <published>2018-05-17T06:19:37.000Z</published>
    <updated>2020-06-19T12:16:02.917Z</updated>
    
    <content type="html"><![CDATA[<p>Azure サポートチームの石井です。<br>2018 年 5 月第 2 週目頃から、突然 Windows 仮想マシンに RDP すると以下のエラーが出て接続が出来なくなったというケースが報告されています。</p><img src="/blog/archive/mayupdate_unable-to-rdp/mayupdate_unable-to-rdp.png"><p>このエラーは、5 月にリリースされたセキュリティ更新プログラムの影響です。接続元側にのみ、5 月の更新プログラムが適用されており、接続先の VM に 3 月以降の更新プログラムが未適用の場合に当該の状況が発生します。Windows Update の自動更新をせず、自社にてタイミングを管理しているようなお客様に該当する恐れがあります。</p><p>以下の Windows サポート部門からの情報に詳しくまとめられていますので、お読みいただき、回避策を実施下さい。</p><p>2018 年 5 月の更新プログラム適用によるリモート デスクトップ接続への影響<br><a href="https://blogs.technet.microsoft.com/askcorejp/2018/05/02/2018-05-rollup-credssp-rdp/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/askcorejp/2018/05/02/2018-05-rollup-credssp-rdp/</a><br><span style="color:gray;">※ Ask CORE Blog は 2019 年 3 月をもちまして、弊社システム刷新の都合により終了いたしました。<br>※ 2019 年 8 月現在、過去の記事を閲覧することは可能でございますが、予告なく削除される可能性がございます</span></p><p>端的にいうと、以下の対策となります。</p><ol><li>回避策の項にある 1 ないしは 2 をクライアント側で実施することで、まずはエラーを回避して RDP 接続が行えるようになります。</li><li>サーバー側で “5. 参考情報” に記載のセキュリティ更新プログラムを適用します。</li></ol><p>-&gt; 更新プログラムの適用が難しい場合、サーバー側でポリシーを当てることで回避が出来ますが、セキュリティ レベルが低くなるため、あくまで暫定回避策とお考え下さい。</p><h3 id="lt-5-27-更新-gt-以下の事象は解消済みです。"><a href="#lt-5-27-更新-gt-以下の事象は解消済みです。" class="headerlink" title="&lt;5/27 更新&gt; 以下の事象は解消済みです。"></a>&lt;5/27 更新&gt; 以下の事象は解消済みです。</h3><p><del>※ 補足: Azure Marketplace のイメージにおいて、Windows 10 クライアント イメージでも事象が発生しますため、上記の回避策を実施して下さい。Azure Marketplace のイメージは、都度のセキュリティ更新プログラムを適用し、開発部門でテスト後に更新されていくため、<a href="https://docs.microsoft.com/ja-jp/azure/security/azure-security-best-practices-vms#manage-your-vm-updates" target="_blank" rel="noopener">数週間の遅延が発生する可能性があります</a>。今回の事象を受け、弊サポート部からも開発に、更新版のイメージのリリースを急ぐようプッシュをかけております。解消までの間、今しばらくお待ちください。</del></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Azure サポートチームの石井です。&lt;br&gt;2018 年 5 月第 2 週目頃から、突然 Windows 仮想マシンに RDP すると以下のエラーが出て接続が出来なくなったというケースが報告されています。&lt;/p&gt;
&lt;img src=&quot;/blog/archive/mayup
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="RDP" scheme="https://jpaztech.github.io/blog/tags/RDP/"/>
    
      <category term="Update / Upgrade" scheme="https://jpaztech.github.io/blog/tags/Update-Upgrade/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway における 502 Error について</title>
    <link href="https://jpaztech.github.io/blog/archive/application-gateway-502-error-info/"/>
    <id>https://jpaztech.github.io/blog/archive/application-gateway-502-error-info/</id>
    <published>2018-03-16T11:39:33.000Z</published>
    <updated>2020-06-19T12:16:02.913Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは、Azure テクニカルサポートの平原です。<br>今回のトピックでは、比較的お問い合わせをいただくものである Application Gateway (Reverse Proxy) における 502 エラーについて解説させていただきます。<br>ご案内内容がお役に立てば幸いです。</p><h2 id="■-Http-Status-Code-502-とは"><a href="#■-Http-Status-Code-502-とは" class="headerlink" title="■ Http Status Code 502 とは"></a>■ Http Status Code 502 とは</h2><p>Application Gateway を使っている過程で、HTTP ステータスコード 502 エラーに遭遇することがあります。<br>おそらく多くの人が、Application Gateway を使う過程でご覧いただいたことがあるものなのでは、と思います。<br>一番簡単に出す方法は、Application Gateway を作成して、バックエンドに何も入れずに、作ったサーバーにアクセスすれば、502 エラーが返ります。<br>まずは、502 エラーはどういうものなのかを見ていきます。</p><p>HTTPステータスコード<br><a href="https://ja.wikipedia.org/wiki/HTTPステータスコード" target="_blank" rel="noopener">https://ja.wikipedia.org/wiki/HTTPステータスコード</a></p><p>Wikipedia ですと、以下のような記述があります。</p><blockquote><p>502 Bad Gateway : 不正なゲートウェイ。ゲートウェイ・プロキシサーバは不正な要求を受け取り、これを拒否した。</p></blockquote><p>もう少し正確な情報で、RFC を見てみると、502 Bad Gateway に関する記述があります。</p><p>Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content<br><a href="https://tools.ietf.org/html/rfc7231#section-6.6.3" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7231#section-6.6.3</a></p><blockquote><p>6.6.3.  502 Bad Gateway<br>The 502 (Bad Gateway) status code indicates that the server, while<br>acting as a gateway or proxy, received an invalid response from an<br>inbound server it accessed while attempting to fulfill the request.</p></blockquote><p>すなわち、ゲートウェイなりプロキシなりの機能を有しているサーバーが接続先のサーバーに対して有効な情報を得られないときに症状が出るものになります。<br>そう考えると、Application Gateway もプロキシですので、何もバックエンドにサーバーを設定していないときや、バックエンドに接続できないときなどは、502 エラーを返すことになります。</p><h2 id="■-Application-Gateway-における-502-エラー"><a href="#■-Application-Gateway-における-502-エラー" class="headerlink" title="■ Application Gateway における 502 エラー"></a>■ Application Gateway における 502 エラー</h2><p>では、どういうときに 502 エラーを返すのでしょうか？<br>Application Gateway の場合は、よくある症状として、以下の時に 502 エラーを返すことがあります。</p><ul><li>バックエンドサーバーに何もない時。</li><li>バックエンドサーバーの正常性チェックで、すべてのサーバーがダウンしているとき。</li><li>バックエンドサーバーが、リセットパケットを返すとき。</li><li>バックエンドサーバーへの接続が、タイムアウトした時。</li><li>バックエンドサーバーへの名前解決に失敗する場合</li></ul><p>もし症状に遭遇した時には、この観点で見ていく必要があります。<br>とくに、今まで動いていたものが、急に 502 を返すようになったという症状の場合には、バックエンドの正常性を疑ってみてください。</p><h2 id="■-トラブルシュート方法"><a href="#■-トラブルシュート方法" class="headerlink" title="■ トラブルシュート方法"></a>■ トラブルシュート方法</h2><p>トラブルシュート方法としては、マイクロソフトの用意しているドキュメントによくまとまっていますので、こちらをご参考ください。</p><p>Application Gateway での「無効なゲートウェイ」によるエラーのトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-troubleshooting-502" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-troubleshooting-502</a></p><p>よくある問題は以下の通りです。</p><ul><li>ネットワーク セキュリティ グループ、ユーザー定義ルート、またはカスタム DNS に関する問題</li><li>既定の正常性プローブに関する問題</li><li>カスタムの正常性プローブに関する問題</li><li>要求のタイムアウト</li><li>空の BackendAddressPool</li><li>BackendAddressPool の異常なインスタンス</li></ul><h2 id="■-参考情報"><a href="#■-参考情報" class="headerlink" title="■ 参考情報"></a>■ 参考情報</h2><p>これ以外の情報で、バックエンドに Apache にてリバースプロキシーを構築し、プロキシーの 2 段構成にした場合に、散発的に 502 エラーが発生することが報告されています。<br>これは、Apache をご利用の際に、他の環境でも 2 段構成にすると事象が発生することが報告されているようです。<br>もし遭遇された場合は、Apache 側の構成で Keep Alive を OFF にすることで事象回避の報告があるようですので、もし同じ事象に合われましたらお試しください。</p><p>Web 上を検索すると種々方法はあるようですので、Apache に関して検索をかけていただくと別の方法もある可能性があります。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;皆さんこんにちは、Azure テクニカルサポートの平原です。&lt;br&gt;今回のトピックでは、比較的お問い合わせをいただくものである Application Gateway (Reverse Proxy) における 502 エラーについて解説させていただきます。&lt;br&gt;ご案内内容
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
      <category term="WAF" scheme="https://jpaztech.github.io/blog/tags/WAF/"/>
    
  </entry>
  
  <entry>
    <title>2018 年 1 月 4 日以降で Disk 11 のエラーが発生し MARS Agent バックアップが失敗する (0x8007045D)</title>
    <link href="https://jpaztech.github.io/blog/archive/disk11-after20180104/"/>
    <id>https://jpaztech.github.io/blog/archive/disk11-after20180104/</id>
    <published>2018-01-23T14:15:17.000Z</published>
    <updated>2020-06-19T12:16:02.917Z</updated>
    
    <content type="html"><![CDATA[<p><span style="color:red;">※ 2018/02/01 更新<br>修正版の MARS Agent が公開されましたので、更新方法を追記いたしました。</span></p><p>こんにちは、Azure IaaS Support チームです。</p><p>本日は 1 月 4 日に発生しましたメンテナンスによる仮想マシンの再起動以降、Azure VM で MARS Agent によるファイルとフォルダーのバックアップが「仮想ディスク サービスで予期しないエラーが発生したため、バックアップを開始できませんでした。 I/O デバイス エラーが発生したため、要求を実行できませんでした。 (0x8007045D)」のメッセージで失敗する弊社製品不具合の事象についてご案内いたします。</p><p><span style="color:gray;">※ 本情報の内容（添付文書、リンク先などを含む）は作成日時点でのものであり、予告なく変更される場合があります。</span></p><h2 id="■-事象について"><a href="#■-事象について" class="headerlink" title="■ 事象について"></a>■ 事象について</h2><p>MARS Agent による Azure VM のファイルとフォルダーのバックアップが下記イベント ID 11 の記録とともに失敗します。</p><img src="/blog/archive/disk11-after20180104/diskerr.jpg"><p>当該事象はバックアップ取得時に作成される VHD ファイルのマウント/アンマウントの内部処理に問題があり、IO エラー (0x8007045D) が返されることでバックアップが失敗します。<br>根本原因としては、Agent の処理に問題があることが分かっており現在 Microsoft 開発チームにて修正対応が進められております。</p><h2 id="■-対処策"><a href="#■-対処策" class="headerlink" title="■ 対処策"></a>■ 対処策</h2><p>本事象につきましては、回避策としてキャッシュの場所変更がございます。<br>VM に OS ディスク以外のデータ ディスクが接続されている場合にはキャッシュの場所変更についてご検討をいただけますようお願いいたします。<br>また、2018 年 1 月 23 日時点で Private Fix が公開されておりますので、上記対処策の実施が難しい場合には Private Fix の適用についてご検討を頂ければと存じます。</p><h3 id="キャッシュの場所変更方法"><a href="#キャッシュの場所変更方法" class="headerlink" title="キャッシュの場所変更方法"></a>キャッシュの場所変更方法</h3><ol><li><p>タスク マネージャー (Ctrl + Shift + Esc キー) を起動し、[サービス] タグの「obengine (Microsoft Azure Recovery Services Agent)」を停止します。</p></li><li><p>現在のスクラッチ フォルダーのバックアップ対象ファイルやフォルダーを十分な空き容量のあるスクラッチ フォルダーへコピーします。<br>(規定 C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch)<br>   ↓<br>(例えば E:\Scratch など)</p></li><li><p>新しい Scratch フォルダーへ既定の Scratch フォルダー内にある OnlineBackup.KEK ファイルをコピーします。</p></li><li><p>レジストリ エディター (スタートボタン ＋ R キーし、「regedit」と入力) を起動し、以下設定を手順 2 と同じ場所に変更します。<br>レジストリ パス :<br>   HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config<br>   HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config\CloudBackupProvider</p><p>レジストリ キー :<br>ScratchLocation</p></li><li><p>バックアップを実行します。</p></li></ol><h2 id="■-参考"><a href="#■-参考" class="headerlink" title="■ 参考"></a>■ 参考</h2><p>Azure Backup サービスについての質問<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-file-folder-backup-faq#backup" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-file-folder-backup-faq#backup</a><br>参考箇所 : [バックアップ] の “Azure Backup エージェント用に指定されたキャッシュの場所を変更する方法を教えてください。”</p><h3 id="Private-Fix-適用方法について"><a href="#Private-Fix-適用方法について" class="headerlink" title="Private Fix 適用方法について"></a>Private Fix 適用方法について</h3><ol><li><p>タスク マネージャー (Ctrl + Shift + Esc キー) を起動し、[サービス] タグの「obengine (Microsoft Azure Recovery Services Agent)」を停止します。</p></li><li><p>Agent を最新の 2.0.9105.0 のバージョンにアップデートします。</p><ol><li>URL (<a href="https://aka.ms/azurebackup_agent" target="_blank" rel="noopener">https://aka.ms/azurebackup_agent</a>) より最新版の MARS エージェントをダウンロードします。 </li><li>ダウンロードした “MARSAgentInstaller.exe” を対象のサーバーで実行します。</li><li>更新プログラムをインストールするかの画面では [次へ] をクリックします。</li><li>インストールの画面で必要なソフトウェアのアップグレードをするかメッセージが表示されますので、[アップグレード] をクリックします。</li><li>アップグレードが完了した事を確認し [完了] をクリックします。</li></ol></li><li><p>下記からダウンロードした最新版の VhdFileProvider.dll ファイルを既存のものと置き換えます。<br><a href="http://blogs.technet.microsoft.com/jpaztech/2018/01/23/__trashed/vhdfileprovider/" target="_blank" rel="noopener">VhdFileProvider</a><br>既定のパス C：\Program Files\Microsoft Azure Recovery Services Agent\bin\VhdFileProvider.dll<br>※ 元々の VhdFileProvider.dll ファイルは任意の場所に保管をお願いします。</p></li><li><p>バックアップを実行します。<br>※ 最初のバックアップは下記メッセージが表示され失敗する可能性がございます。<br>※ これは、キャッシュ ロケーションを含むディスクのエラーが原因でございます。</p><blockquote><p>「バックアップが失敗しました。これは、Azure Backup が設定されたキャッシュ ロケーションでメタデータ vhd を準備できなかったためです。」</p></blockquote></li><li><p>別のバックアップをトリガーし、再度バックアップを取得します。</p></li></ol><h2 id="■-修正情報-2018-02-01-更新"><a href="#■-修正情報-2018-02-01-更新" class="headerlink" title="■ 修正情報 (2018/02/01 更新)"></a>■ 修正情報 (2018/02/01 更新)</h2><p><span style="color:red;">※ 2018/02/01  時点で最新版の MARS Agent (2.0.9109.0) が公開されました。</span></p><h3 id="最新版の-MARS-エージェントへのアップデート方法について"><a href="#最新版の-MARS-エージェントへのアップデート方法について" class="headerlink" title="最新版の MARS エージェントへのアップデート方法について"></a>最新版の MARS エージェントへのアップデート方法について</h3><ol><li>最新版の MARS エージェントをダウンロードします。</li><li>ダウンロードした “MARSAgentInstaller.exe” を対象のサーバーで実行します。</li><li>更新プログラムをインストールするかの画面では [次へ] をクリックします。</li><li>インストールの画面では必要なソフトウェアのアップグレードをするかのメッセージが表示されますので、[アップグレード] をクリックします。</li><li>アップグレードが完了した事を確認し [完了] をクリックします。</li></ol><p>以上でアップデートは完了です。</p><p>バックアップを実行時にエージェントのアップデートを実施した場合には、現在進行しているバックアップ処理はキャンセルされ、アップデート完了後、再度バックアップ処理が開始されます。尚、イベント ログ情報においてジョブの結果は失敗となります。</p><h3 id="※-注意点"><a href="#※-注意点" class="headerlink" title="※ 注意点"></a>※ 注意点</h3><ul><li>バックアップ操作または復元操作が実行中でないことを確認してください。実行中の操作はすべて取り消されます。</li><li>バックアップに使用される管理コンソールが閉じていることを確認してください。</li><li>実行中のレプリケーション操作は更新中にすべて取り消されます。これらの操作は、更新が完了すると再開されます。</li><li>スケジュールされたバックアップが、更新プログラムの適用中に実行された場合、バックアップ ジョブは失敗します。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;span style=&quot;color:red;&quot;&gt;※ 2018/02/01 更新&lt;br&gt;修正版の MARS Agent が公開されましたので、更新方法を追記いたしました。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;こんにちは、Azure IaaS Support チームです。&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="Azure Backup" scheme="https://jpaztech.github.io/blog/tags/Azure-Backup/"/>
    
      <category term="MARS Agent" scheme="https://jpaztech.github.io/blog/tags/MARS-Agent/"/>
    
  </entry>
  
  <entry>
    <title>2017/12/9 以降 Azure VM の起動に時間がかかる事象についての対処方法</title>
    <link href="https://jpaztech.github.io/blog/archive/take-time-to-boot-after20171209/"/>
    <id>https://jpaztech.github.io/blog/archive/take-time-to-boot-after20171209/</id>
    <published>2017-12-18T01:17:24.000Z</published>
    <updated>2020-06-19T12:16:02.937Z</updated>
    
    <content type="html"><![CDATA[<p><span style="color:red;">12/16 より問題解消のための修正を開始し、現在 (12/25) では修正を提供しております。<br>一部 VM に対しては別途ユーザー様に対処が必要な項目がございますので、継続して起動に時間がかかる問題が発生する環境においては、以下にご案内いたします対処実施をご検討ください。</span></p><h3 id="対象となる-VM-について"><a href="#対象となる-VM-について" class="headerlink" title="対象となる VM について"></a>対象となる VM について</h3><ul><li>VMSnapshot という名前の拡張機能がインストールされている VM(Azure バックアップの対象VM)</li><li>VM 停止状態においてバックアップが実行されているVM</li></ul><p>こんにちは、Azure IaaS Support チームです。<br>12/9 より一部の Azure VM にて起動処理に時間がかかる事象が発生しています。<br>このブログでは事象の発生理由と問題解消に向けた取り組みについて周知いたします。</p><h3 id="発生事象"><a href="#発生事象" class="headerlink" title="発生事象"></a>発生事象</h3><p>Azure ポータル・Azure PowerShell・Azure Automation を利用した VM が起動するまでに長時間かかります。<br>場合によっては VM の起動が失敗します。</p><h3 id="発生対象"><a href="#発生対象" class="headerlink" title="発生対象"></a>発生対象</h3><p>Azure バックアップの対象となっている Azure VM (Windows) で発生します。<br>具体的には、VMSnapshot という名前の拡張機能がインストールされている VM で発生します。<br>この拡張機能は Azure バックアップの対象としているサーバーに自動的にインストールされます。</p><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>VM 起動処理の一環として拡張機能のステータスをチェックするステップがあります。<br>12/8 に実施された VMSnapshot 拡張機能の更新モジュールに問題があり、VM 起動時のステータス チェックが完了しない状態となっております。<br>その結果、VM の起動処理が完了するまでに長時間かかります。場合によっては VM の起動が失敗します。</p><h3 id="解消に向けた取り組み"><a href="#解消に向けた取り組み" class="headerlink" title="解消に向けた取り組み"></a>解消に向けた取り組み</h3><p>マイクロソフトではすでに原因を特定して、VMSnapshot 拡張機能の修正版を対象の VM に対して配信しております。</p><h3 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h3><p>本問題は最新版の拡張機能に更新する事で解決いたします。拡張機能の更新は VM が起動している際にバックアップを実行すると自動で行われます。尚、 VM 停止状態においてバックアップが実行される場合には更新が行われません。<br>その為、対処としてまずは問題が発生する環境の VMSnapshot の拡張機能を削除下さいますようお願いいたします。</p><h3 id="拡張機能の削除手順"><a href="#拡張機能の削除手順" class="headerlink" title="拡張機能の削除手順"></a>拡張機能の削除手順</h3><ol><li>Azure ポータルを開きます。</li><li>[Virtual Machines] - “対象の VM” - [拡張機能] - [VMSnapshot] を選択します。</li><li>[アンインストール] - [はい] を選択して拡張機能を削除します。</li></ol><p>上記作業を実施する事で、対象の VM の問題については修正されますが、対象のサブスクリプション上には複数の VM が存在しており、またいくつかの VM については停止状態でバックアップが実行される為、更新が行われない可能性がございます。<br>その為、以下のスクリプトを実行して対象のサブスクリプション上にあるすべての VM に対して VMSnapshot の拡張機能削除をご検討下さいますようお願いいたします。</p><p>VMSnapshot の拡張機能は次回バックアップを実行する際に再度インストールされますので、以下の削除を実施する事でのデメリットや VM への影響はございませんのでご安心ください。</p><p>———— スクリプト 開始 ————</p><pre>## Azure にログインします。Login-AzureRmAccount## すべての VM 情報を取得します。$VMs = Get-AzureRmVM## VM に VMSnapshot の拡張機能が含まれる場合には削除します。foreach($vm in $VMs){  Remove-AzureRmVMExtension -ResourceGroupName $vm.ResourceGroupName -VMName $vm.Name -Name VMSnapshot -Force}</pre><p>———— 実行結果例 ————</p><pre>RequestId IsSuccessStatusCode StatusCode ReasonPhrase--------- ------------------- ---------- ------------True      NoContent           No         Content  <<<< 対象の拡張機能がない場合に記録True                          OK         OK  <<<< 対象の拡張機能が削除された場合に記録Remove-AzureRmVMExtension : Cannot modify extensions in the VM when the VM is not running.ErrorCode: OperationNotAllowedErrorMessage: Cannot modify extensions in the VM when the VM is not running.<<<< VMが起動していない為拡張機能が削除出来ない場合に記録</pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;span style=&quot;color:red;&quot;&gt;12/16 より問題解消のための修正を開始し、現在 (12/25) では修正を提供しております。&lt;br&gt;一部 VM に対しては別途ユーザー様に対処が必要な項目がございますので、継続して起動に時間がかかる問題が発生する環境にお
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="Boot" scheme="https://jpaztech.github.io/blog/tags/Boot/"/>
    
  </entry>
  
  <entry>
    <title>ARMのWindowsでディスクやVMレベルでのIOスロットリングを監視・通知する方法</title>
    <link href="https://jpaztech.github.io/blog/archive/monitor-io-throttoling-on-win-vm-arm/"/>
    <id>https://jpaztech.github.io/blog/archive/monitor-io-throttoling-on-win-vm-arm/</id>
    <published>2017-10-04T01:23:55.000Z</published>
    <updated>2020-06-19T12:16:02.921Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azureサポートチームの三國です。<br>今回は、ARMのWindowsでディスクやVMレベルでのIOスロットリングを監視・通知する方法についてご案内いたします。</p><p>本記事は下記英文ブログの抄訳です。<br><a href="https://blogs.msdn.microsoft.com/mast/2017/09/12/how-to-monitor-and-alert-potential-disk-and-vm-level-io-throttling-on-windows-vms-using-arm/" target="_blank" rel="noopener">How to monitor and alert potential Disk and VM Level IO Throttling on Windows VMs using ARM</a><br><span style="color:gray;">本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</span></p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>本ブログはAzure上にあるWindows VMのディスクパフォーマンス監視手順について紹介します。<br>ディスクやVMレベルでのIOスロットリングについて検出することが目的です。<br>本ガイドラインはAzure Resource ManagerにてデプロイされているAzure上のすべてのバージョンのWindowsに適用できます。<br>手順の紹介に入る前に、3つの前提となる概念について説明します。</p><h3 id="スロットリングとは？"><a href="#スロットリングとは？" class="headerlink" title="スロットリングとは？"></a>スロットリングとは？</h3><p>Azure Premium Storage では、選択された VM サイズとディスク サイズに応じて、指定された数の IOPS とスループットがプロビジョニングされます。<br>アプリケーションが、VM またはディスクが対応できるこれらの上限を超えて IOPS やスループットを試みると、これを抑制するように調整されます。 これは、アプリケーションのパフォーマンスの低下という形で現れます。<br>これにより、待機時間が長くなり、スループットや IOPS が低下する可能性があります。<br>スロットリングにはディスクレベルと VM レベルの2種類があります。</p><p>詳細については以下のドキュメントをご確認下さい。<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/premium-storage-performance#throttling" target="_blank" rel="noopener">Azure Premium Storage: 高パフォーマンス用に設計する - Throttling</a></p><h3 id="ディスク-レベルのスロットリングとは？"><a href="#ディスク-レベルのスロットリングとは？" class="headerlink" title="ディスク レベルのスロットリングとは？"></a>ディスク レベルのスロットリングとは？</h3><p>基本的に、ディスクの制限値を超えたIOについてはすべて滞留しより大きな遅延が発生します。<br>管理ディスク・非管理対象ディスクの制限値については以下のドキュメントをご参照ください。<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/sizes-general#dsv2-series" target="_blank" rel="noopener">汎用仮想マシンのサイズ - DSv2 シリーズ</a></p><h3 id="VM-レベルのスロットリングとは？"><a href="#VM-レベルのスロットリングとは？" class="headerlink" title="VM レベルのスロットリングとは？"></a>VM レベルのスロットリングとは？</h3><p>基本的に、VM にアタッチされたディスクの総 IO がスループット制限を超えた場合に VM レベルのスロットリングが発生します。<br>制限値はキャッシュ/非キャッシュで異なります。<br>こちらは Premium ディスクをお使いの場合のみ該当します。<br>Standard ディスクをお使いの場合には VM レベルの IO スロットリングという概念はありません。</p><p>IOスロットリングの詳細については、以下のドキュメントをご参照ください。<br><a href="https://blogs.technet.microsoft.com/xiangwu/2017/05/14/azure-vm-storage-performance-and-throttling-demystify/" target="_blank" rel="noopener">Azure VM Storage Performance and Throttling Demystified</a></p><h2 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h2><p>本ブログの説明に用いるVMの構成例を以下に記載します。</p><p><strong>VM 名</strong>: “MonitorVM”<br><strong>VM サイズ</strong> : DS2_v2<br><strong>Disk 構成</strong>:<br>以下の4データディスクをVMにアタッチします:</p><ul><li>2x P10 (128 GB - Disk limits: 500 IOPS or 100 MB/s - Disk Cache Setting: None)</li><li>1x P20 (512 GB - Disk limits: 2300 IOPS or 150 MB/s - Disk Cache Setting: None)</li><li>1x P30 (1024 GB - Disk limits: 5000 IOPS or 200 MB/s - Disk Cache Setting: None)</li></ul><p>本シナリオでは、上記のようにアタッチされたディスクすべてについてキャッシュが無効になっています。<br>そのためVMの非キャッシュディスクスループット制限(IOPS/MBps)について確認します。<br>下記のURLの”キャッシュが無効な場合の最大ディスク スループット: IOPS/MBps”より確認できます。<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/sizes-general#dsv2-series" target="_blank" rel="noopener">汎用仮想マシンのサイズ - DSv2 シリーズ</a></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/01_dsv2_sizes.png"><p>キャッシュを有効にする場合は、上記 URL の”キャッシュが有効な場合の一時ストレージの最大スループット: IOPS/MBps (キャッシュ サイズは GiB 単位)”より VM における一時ストレージのスループット制限 (IOPS/MBps) を確認できます。</p><h2 id="“MonitorVM”VM内部のディスク設定の詳細について"><a href="#“MonitorVM”VM内部のディスク設定の詳細について" class="headerlink" title="“MonitorVM”VM内部のディスク設定の詳細について"></a>“MonitorVM”VM内部のディスク設定の詳細について</h2><p>F ドライブに、P10 ディスクを 2 つ用いて<a href="https://technet.microsoft.com/ja-jp/library/hh831739.aspx#BKMK_AZURE" target="_blank" rel="noopener">復元力を備えた記憶域</a>を構成し、1000 IOPS (2 x 500 IOPS) が制限値となります。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/02_storagespaces.png"><p><strong>ディスク管理:</strong></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/03_diskmanagement.png"><p><strong>ファイルエクスプローラー:</strong></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/04_explorer.png"><p><strong>“MonitorVM”VM内のパフォーマンスモニター:</strong></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/05_perfmon.png"><p>VM 内のパフォーマンスモニターで VM の物理ディスクのパフォーマンスカウンターについてカウンター名が確認ができました。<br>次に、以下のパフォーマンスカウンターについて VM の診断設定に追加し、IOPS を Azure ポータルで監視する方法をご案内します。</p><p><strong>IOPS:</strong><br>“\PhysicalDisk(_Total)\Disk Transfers/sec” (VM レベルのスロットリング - 6400 IOPS)<br>“\PhysicalDisk(0 C:)\Disk Transfers/sec” (ディスクレベルのスロットリング - OS disk P10 - 500 IOPS)<br>“\PhysicalDisk(2)\Disk Transfers/sec” (ディスクレベルのスロットリング - P10 disk - 500 IOPS)<br>“\PhysicalDisk(3)\Disk Transfers/sec” (ディスクレベルのスロットリング - P10 disk - 500 IOPS)<br>“\PhysicalDisk(4 G:)\Disk Transfers/sec” (ディスクレベルのスロットリング - P20 disk - 2300 IOPS)<br>“\PhysicalDisk(5 H:)\Disk Transfers/sec” (ディスクレベルのスロットリング - P30 disk - 5000 IOPS)<br>“\PhysicalDisk(6 F:)\Disk Transfers/sec” (ディスクレベルのスロットリング - 記憶域スペースドライブ - 1000 IOPS)</p><h2 id="Azureポータルでパフォーマンスカウンターを監視するには？"><a href="#Azureポータルでパフォーマンスカウンターを監視するには？" class="headerlink" title="Azureポータルでパフォーマンスカウンターを監視するには？"></a>Azureポータルでパフォーマンスカウンターを監視するには？</h2><p>パフォーマンスカウンターはAzureポータルの診断設定にて追加できます。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/06_perfcounterportal.png"><p>追加手順を以下に記載します。</p><ul><li>Azure ポータルの “MonitorVM” VM のページへ移動します</li><li>VM ブレードの “Diagnostic settings” を選択し、”Performance counter” タブへ移動します (図中 1.)</li><li>パフォーマンス カウンターを追加するため “Custom” (図中 2.) を選択します</li><li>テキスト ボックス (図中 3.) にパフォーマンス カウンター名を入力します (例: \PhysicalDisk(0 C:)\Disk Transfers/sec)</li><li>“Add” ボタン (図中 4.) を押下し、パフォーマンス カウンターを追加します</li><li>サンプル レートをテキスト ボックス内 (図中 5.) に入力します</li><li>最後に “Save” ボタンを押下し構成を保存します</li></ul><p>サンプル レートはパフォーマンス カウンターを収集する頻度です。<br>デフォルトでは 60 秒に指定されているため、60 秒ごとにパフォーマンス カウンターが収集されます。</p><p>ディスク負荷の変化が激しい場合は収集頻度を 10 秒、あるいは 1 秒に短縮して IO がディスクや VM の制限に到達していないかを確認できます。<br>ディスク負荷の変化が緩やかな場合はサンプル レートを大きくすることもできます。<br>サンプル レートはいつでも、すぐに変更でき、Azure ポータルの “Metrics” を通じて都度検証することができるので、ぜひ適切な値を環境に応じて調整してみてください。</p><h2 id="収集した情報を確認するには？"><a href="#収集した情報を確認するには？" class="headerlink" title="収集した情報を確認するには？"></a>収集した情報を確認するには？</h2><p>下図のようにAzureポータルの”Metrics”より確認ができます。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/07_metricportal.png"><p>VMブレードの “metrics” へ移動すると、追加したパフォーマンス カウンターを選択し折れ線グラフで値を見ることができます。<br>右上にある”time range” を変更することで最近のデータについて見ることができます。</p><p>次に、”Add metric alert”より負荷が制限に達した際に通知を受ける方法をご案内します。</p><h2 id="“metric-alert-Rules”-を有効にするには？"><a href="#“metric-alert-Rules”-を有効にするには？" class="headerlink" title="“metric alert Rules” を有効にするには？"></a>“metric alert Rules” を有効にするには？</h2><p>下図はディスクレベルスロットリングを監視するための設定例です。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/08_ruleconfigdisk.png"><ul><li>“Metric” ドロップダウンより監視したいパフォーマンス カウンター (例では OS ディスク) を選択します</li><li>“Condition” ドロップダウンより “Greater than equal to” を選択します</li><li>“Threshold” に通知する IOPS の閾値 (例ではディスク レベルでの制限値、今回の場合は P10 ディスクの 500 IOPS) を入力します</li><li>“Period” で通知する閾値超えの期間 (例では 5 分以上) を選択します</li><li>メールで通知をする場合はチェックボックスをオンにし、必要に応じて “Additional administrator” を入力します</li><li>最後に、”Name” にルールの名前を入力し、”OK” を押下します</li></ul><p>その他のパフォーマンス カウンターについても同様のルールを作成します。<br>下図は VM レベルスロットリングを監視するための設定例です。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/09_ruleconfigVMIO.png"><p>“(_Total)” を含むカウンター名は VM レベルを監視するのに使用できます。</p><h2 id="“metrics-alert-Rues”をテストするには？"><a href="#“metrics-alert-Rues”をテストするには？" class="headerlink" title="“metrics alert Rues”をテストするには？"></a>“metrics alert Rues”をテストするには？</h2><p>今回、作成したルールをテストするのに <a href="https://github.com/Microsoft/diskspd" target="_blank" rel="noopener">diskspd</a> というベンチマークツールを用います。<br>以下のパラメータを用いて F ドライブに負荷をかけます (P10 disk を 2 つ用いた記憶域スペース)</p><blockquote><p>diskspd.exe -c1024M -d300 -W30 -w100 -t1 -o25 -b8k -r -h -L F:_diskSpd_test\testfile.dat</p></blockquote><p>下図に、負荷が制限値に達した記憶域スペースの様子を示します。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/10_storagespacesvmlimit.png"><p>上図より 2 つの P10 ディスクで 500 IOPS、F ドライブで 1000 IOPS の制限値に達していることがわかります。</p><p>続いて下図に、P30 disk に負荷をかけた後、VM レベルで制限値に到達させた様子を示します。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/11_iovmlimit.png"><p>上図ではまず P30 disk に 5000 IOPS の負荷をかけています。<br>その後、G ドライブ (P20) と H ドライブ (P30) に同時に負荷をかけ VM レベルの制限値 6400 IOPS に到達させています。<br>理論上、2 つのディスクの負荷上限は 7300 IOPS (P20 が 2300, P30 が 5000) ですが、VM の非キャッシュ スループットの上限は DS2_v2 の場合 6400 IOPS であることがわかります。</p><p>先述の “metric alert rule” で指定した閾値を超えた場合、メールにて通知されます。<br>下図は、VMレベルの制限値に達した際の通知メールです。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/12_notificationalertvmlimit.png"><p>下図は、VM レベルの制限値に達した後、事象が解決した際の通知メールです。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/13_notificationbelowlimit.png"><p><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-premium-storage-performance#nature-of-io-requests" target="_blank" rel="noopener">IO 要求の特性</a>により、たとえば 1 つ 1 つの IO サイズが大きい場合などに、IOP S制限値に到達していなくともスループットの制限値に到達することが起こりえます。<br>そのため以下の MBps についての監視も検討できます。</p><p>Throughput/MBps:<br>“\PhysicalDisk(_Total)\Disk Bytes/sec” (VM レベルのスロットリング - 96 MBps)<br>“\PhysicalDisk(0 C:)\Disk Bytes/sec” (ディスクレベルのスロットリング - OS disk P10 - 100 MBps)<br>“\PhysicalDisk(2)\Disk Bytes/sec” (ディスクレベルのスロットリング - P10 disk - 100 MBps)<br>“\PhysicalDisk(3)\Disk Bytes/sec” (ディスクレベルのスロットリング - P10 disk - 100 MBps)<br>“\PhysicalDisk(4 G:)\Disk Bytes/sec” (ディスクレベルのスロットリング - P20 disk - 150 MBps)<br>“\PhysicalDisk(5 H:)\Disk Bytes/sec” (ディスクレベルのスロットリング - P30 disk - 200 MBps)<br>“\PhysicalDisk(6 F:)\Disk Bytes/sec” (ディスクレベルのスロットリング - Storage Spaces Drive 2x P10 - 200 MBps)</p><p>今回の例においてスループットの制限値については、VM レベルよりディスク レベルのスロットリングの制限値が高いため、VM レベルについてのみ通知を設定すれば十分です。<br>ディスク レベルよりも高いスロットリングの制限値をもつ VM サイズ (DS4_v2 - 384 MBpsなど) を選択した場合は、ディスク/VM 両方のレベルで設定します。</p><p>下図はVMレベルでのMBpsの制限値超えを通知するルールです。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/14_rulembps.png"><p>負荷が最大 IOPS または MBps に達した際は、VM レベルでもディスク レベルでもスロットリングにより以下の 2 カウンターの値が増大します (例では OS ディスクについて記載しています)</p><p>“\PhysicalDisk(0 C:)\Current Disk Queue Length”?<br>“\PhysicalDisk(0 C:)\Avg. Disk sec/Transfer”?</p><h2 id="Metrics-データの保管場所について"><a href="#Metrics-データの保管場所について" class="headerlink" title="Metrics データの保管場所について"></a>Metrics データの保管場所について</h2><p>すべてのパフォーマンス カウンター Metric はストレージ アカウント内の “WADPerformanceCountersTable” に保管されます。<br>保管されるストレージアカウントは “Diagnostics settings” の “Agent” タブより確認できます。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/16_storageaccount.png"><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本ブログではスロットリングを検知するためにストレージのパフォーマンスを監視・通知する手順についてご案内しました。<br>ディスクや VM レベルで制限値に達していないにもかかわらず VM の動作が遅くなっている場合は、切り分けとして <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/how-to-use-perfinsights" target="_blank" rel="noopener">PerInsights</a> を利用して調査を行うか、Azure サポートまでお問い合わせください。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azureサポートチームの三國です。&lt;br&gt;今回は、ARMのWindowsでディスクやVMレベルでのIOスロットリングを監視・通知する方法についてご案内いたします。&lt;/p&gt;
&lt;p&gt;本記事は下記英文ブログの抄訳です。&lt;br&gt;&lt;a href=&quot;https://blo
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="Monitoring / Alert" scheme="https://jpaztech.github.io/blog/tags/Monitoring-Alert/"/>
    
      <category term="IO Throttling" scheme="https://jpaztech.github.io/blog/tags/IO-Throttling/"/>
    
      <category term="Performance" scheme="https://jpaztech.github.io/blog/tags/Performance/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway を PowerShell で設定変更するコツ</title>
    <link href="https://jpaztech.github.io/blog/archive/powershell-applicationgateway-configuration/"/>
    <id>https://jpaztech.github.io/blog/archive/powershell-applicationgateway-configuration/</id>
    <published>2017-09-07T06:28:25.000Z</published>
    <updated>2020-06-19T12:16:02.937Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの飯塚です。</p><p>最近、おかげさまで Application Gateway をご利用いただいているお客様が増えております。以前は、ポータルからは Application Gateway の作成ができなかったため、手が出しにくいサービスの 1 つでしたが、現在はポータルから作成可能になり、より手軽に Application Gateway をご利用いただけるようになりました。</p><p>しかし、作成はできるようになりましたが、作成したあとの設定変更については、まだポータルからはできないことも多い状況です。ポータルから設定できる項目を増やすよう、弊社としましても取り組んでいるところですが、現状では、PowerShell 等での設定変更が必要な場面が少なからずあります。</p><p>ただし、PowerShell で Application Gateway を設定する手順は、慣れないと、少しわかりにくい側面がございます。実際にお問い合わせをいただくことも増えてまいりましたので、設定変更のコツを以下におまとめしました。少しでもお役に立てればと思います。<br>(なお、以下の内容はリソース マネージャー デプロイ モデルを対象としたものです)</p><h2 id="■-設定変更の流れ"><a href="#■-設定変更の流れ" class="headerlink" title="■ 設定変更の流れ"></a>■ 設定変更の流れ</h2><p>非常に簡単に説明しますと、PowerShell による Application Gateway の設定変更は、以下の流れで行います。</p><ol><li>Get する</li><li>設定変更する</li><li>Set する</li></ol><p>最初に現在の構成情報を変数に Get して、設定変更はその変数に対して行います。<br>そして最後に、設定変更した変数の内容を Set すれば、設定は完了という流れです。<br>時折、最後に Set するのを忘れてしまい、設定変更してエラーも出なかったのに反映されていない、というお問い合わせをいただくことがあります。<br>常に上記の 3 ステップを意識することが、非常に大切です。</p><h2 id="■-具体例-1-リスナーの削除"><a href="#■-具体例-1-リスナーの削除" class="headerlink" title="■ 具体例 (1) - リスナーの削除"></a>■ 具体例 (1) - リスナーの削除</h2><p>もう少し詳しく、具体的な例を交えて設定変更手順をみてみましょう。<br>以下に、「不要なリスナーを削除する」手順をご案内します。<br>ポータル上では新規のリスナーを作ったり、既存のリスナーの一覧を見ることはできますが、不要になったリスナーを削除することができません。</p><ol><li><p>$AppGw 変数に、既存の Application Gateway の設定を Get します。</p><blockquote><p>$AppGw = Get-AzureRmApplicationGateway -Name “AppGw の名前” -ResourceGroupName “AppGw が作成されているリソース グループ名”</p></blockquote></li><li><p>$AppGw 変数の内容から、対象のリスナーを削除します。</p><blockquote><p>Remove-AzureRmApplicationGatewayHttpListener -Name “削除するリスナー名” -ApplicationGateway $AppGw</p></blockquote></li><li><p>設定変更した $AppGw の内容を Set します。</p><blockquote><p>Set-AzureRmApplicationGateway -ApplicationGateway $AppGw</p></blockquote></li></ol><p>これで、リスナーの削除が完了です。2 つ目の手順を設定したい内容に応じて変更すれば、同じ流れでいろいろな設定変更ができます。</p><h2 id="■-具体例-2-SSL-オフロード用の証明書の変更"><a href="#■-具体例-2-SSL-オフロード用の証明書の変更" class="headerlink" title="■ 具体例 (2) - SSL オフロード用の証明書の変更"></a>■ 具体例 (2) - SSL オフロード用の証明書の変更</h2><p>もう 1 つ、具体例を紹介させていただきます。<br>お問い合わせいただく設定変更のうち、もっとも多いのは「SSL オフロード用の証明書の変更」です。<br>これも本日時点で、ポータルからできない設定変更です。</p><p>証明書の変更は、以下の手順で実行可能です。</p><ol><li><p>$AppGw 変数に、既存の Application Gateway の設定をGet します。</p><blockquote><p>$AppGw = Get-AzureRmApplicationGateway -Name “AppGw の名前” -ResourceGroupName “AppGw が作成されているリソース グループ名”</p></blockquote></li><li><p>$AppGw 変数に含まれる、証明書を更新します。</p><blockquote><p>Set-AzureRmApplicationGatewaySslCertificate -Name “既存の証明書の名前” -ApplicationGateway $AppGw -CertificateFile “新しい証明書 (pfx 形式) の絶対パス” -Password “SSL 証明書のパスフレーズ”<br>※ 証明書の絶対パスは、「C:\work\newcert.pfx」など、.pfx ファイルの場所を指定するものです。</p></blockquote></li><li><p>設定変更した $AppGw の内容を Set します。</p><blockquote><p>Set-AzureRmApplicationGateway -ApplicationGateway $AppGw</p></blockquote></li></ol><p>いかがでしょう？流れはリスナーの削除と一緒で、2 番目のコマンドが違うだけなのが、お分かりいただけると思います。</p><p>2 番目のコマンドは、実行する設定内容に応じて調べる必要があります。この記事ですべてを網羅するのは難しいため、コマンドリファレンスをご案内します。英語版しかなくて申し訳ありませんが、ぜひ参考にしてみてください (また、多くお問い合わせいただくものなどがあれば記事を更新しようと思います)。<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/azurerm.network/?view=azurermps-4.3.1#application_gateway" target="_blank" rel="noopener">AzureRm.Network - Application Gateway</a></p><h2 id="■-参考-Azure-PowerShell-の利用方法"><a href="#■-参考-Azure-PowerShell-の利用方法" class="headerlink" title="■ 参考 - Azure PowerShell の利用方法"></a>■ 参考 - Azure PowerShell の利用方法</h2><p>Azure PowerShell 自体のインストール方法については、以下の記事でご説明していますので、よろしければ、こちらも参考にご覧くださいませ。<br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/05/02/azure-powershell-3-8-0-install/" target="_blank" rel="noopener">Azure PowerShell 最新版のインストール手順 (v3.8.0 現在) **追記あり</a></p><p>Azure PowerShell のインストール後に、実際に Azure の操作を行うためには (Application Gateway にかかわらず)、サインインが必要です。この手順についてのお問い合わせを何件かいただきましたので、以下に手順をご案内いたします。</p><ol><li>以下のコマンドを実行し、管理者アカウントでサインインします。<blockquote><p>Login-AzureRmAccount</p></blockquote></li><li>サブスクリプションが複数ある場合などは、念のため操作対象のサブスクリプションを明示的に指定します。<blockquote><p>Select-AzureRmSubscription -SubscriptionId “サブスクリプション ID”</p></blockquote></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの飯塚です。&lt;/p&gt;
&lt;p&gt;最近、おかげさまで Application Gateway をご利用いただいているお客様が増えております。以前は、ポータルからは Application Gateway の作成ができなかったため、手が出しにく
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
      <category term="PowerShell" scheme="https://jpaztech.github.io/blog/tags/PowerShell/"/>
    
  </entry>
  
</feed>
